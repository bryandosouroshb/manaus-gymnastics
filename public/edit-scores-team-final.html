<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Pontua√ß√µes - Final por Equipes | Mundial de Gin√°stica Manaus 2025</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/css/flag-icons.min.css"/>
    <style>
        :root {
            --primary-green-dark: #0b5d2b;
            --primary-green: #0e7c3a;
            --primary-green-light: #009f3d;
            --accent-gold: #f7c948;
            --background-light: #f8fcf9;
            --text-dark: #1a202c;
            --text-light: #4a5568;
            --border-color: rgba(14, 124, 58, 0.1);
            --shadow-color: rgba(14, 124, 58, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .main-header {
            background: linear-gradient(135deg, var(--primary-green-dark), var(--primary-green-light));
            color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1001;
        }
    .header-title { font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .header-title .fas { color: var(--accent-gold); }
        .header-title .header-phase { font-weight: 400; opacity: 0.8; font-size: 1.1rem; border-left: 1px solid rgba(255, 255, 255, 0.4); margin-left: 0.5rem; padding-left: 1.5rem; }
        .header-nav .nav-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 0.6rem 1.2rem; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s ease; font-family: 'Montserrat', sans-serif; font-size: 0.9rem; cursor: pointer; }
        .header-nav .nav-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        
        .main-container { display: flex; flex-grow: 1; padding-bottom: 80px; }
        
        .scores-sidebar {
            width: 320px; background: #ffffff; border-right: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; position: sticky; top: 0; height: calc(100vh - 67px);
        }
        .sidebar-header { font-size: 1.5rem; font-weight: 700; color: var(--primary-green); margin-bottom: 1.5rem; border-bottom: 2px solid var(--accent-gold); padding-bottom: 0.5rem; }
        .team-list { list-style: none; margin-bottom: 2rem; }
    .team-item { padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; text-decoration: none; color: var(--text-dark); cursor: pointer; transition: all 0.3s ease; }
        .team-item:hover { background-color: #f0fdf4; color: var(--primary-green-dark); }
        .team-item.active { background: linear-gradient(90deg, var(--primary-green), var(--primary-green-light)); color: white; box-shadow: 0 4px 12px var(--shadow-color); transform: translateX(5px); }
        .fi { font-size: 1.5rem; }
        .sidebar-controls { margin-top: auto; display: flex; flex-direction: column; gap: 1rem; }
        
        .manaus-button { background: linear-gradient(135deg, var(--primary-green), var(--primary-green-light)); color: white; padding: 0.8rem 1.5rem; border-radius: 8px; border: none; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center; text-transform: uppercase; letter-spacing: 0.5px; font-family: 'Montserrat', sans-serif; }
        .manaus-button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(14, 124, 58, 0.2); }
        .manaus-button.secondary { background: #e2e8f0; color: var(--text-dark); border: 1px solid #cbd5e0; }
        .manaus-button.danger { background: #fef2f2; color: #ef4444; border: 1px solid #fecaca;}

        .content-area { flex-grow: 1; padding: 2rem 3rem; }
        .hidden { display: none !important; }

        .team-card { background: white; border-radius: 16px; box-shadow: 0 15px 40px var(--shadow-color); border: 1px solid var(--border-color); margin-bottom: 2rem; }
    .team-card-header { font-size: 1.5rem; font-weight: 700; color: var(--primary-green-dark); padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 0.5rem; }
    .team-card-header .fi { margin-right: 0.25rem; }
        
        .apparatus-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; padding: 1.5rem; }
        .apparatus-section { background: #f8fcf9; padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); }
        .apparatus-title { font-size: 1.2rem; font-weight: 700; color: var(--primary-green); margin-bottom: 1.5rem; text-align: center; }
        .gymnast-item { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem; }
        .gymnast-item:first-child { border-top: none; padding-top: 0; margin-top: 0; }
        .gymnast-info { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .gymnast-name { font-weight: 600; }
        
        .score-inputs-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; align-items: end; }
        .score-group { display: flex; flex-direction: column; }
        .score-label { font-weight: 600; margin-bottom: 0.5rem; font-size: 0.8rem; text-align: center; color: var(--text-light); }
        .score-input { width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-weight: 500; text-align: center; font-family: 'Montserrat', sans-serif; }
        .score-total-display { display: block; width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); background-color: #f0fdf4; border-radius: 8px; font-size: 1.2rem; font-weight: 700; color: var(--primary-green-dark); text-align: center; }
        
        .action-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 1rem 2rem; border-top: 1px solid var(--border-color); box-shadow: 0 -4px 20px var(--shadow-color); display: flex; justify-content: center; z-index: 1000; gap: 1rem; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); }
    .modal-content { background: linear-gradient(180deg, #ffffff, #f9fbfa); margin: 5% auto; padding: 0; border-radius: 16px; width: 92%; max-width: 980px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2); animation: slideIn 0.35s ease; max-height: 90vh; display: flex; flex-direction: column; border: 1px solid var(--border-color); }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .modal-title { font-size: 1.25rem; font-weight: 800; color: var(--primary-green-dark); display: flex; align-items: center; gap: .6rem; }
    .modal-title .badge { background: linear-gradient(135deg, var(--primary-green), var(--primary-green-light)); color: #fff; font-size: .8rem; font-weight: 700; padding: .2rem .5rem; border-radius: .5rem; }
    .modal-close { background: transparent; border: none; color: var(--text-light); font-size: 1.2rem; cursor: pointer; border-radius: 8px; padding: .4rem .6rem; }
    .modal-close:hover { background: rgba(0,0,0,0.05); color: var(--text-dark); }
    .modal-body { padding: 1.25rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; }
    .presence-toolbar { display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center; }
    .search-input { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: 10px; font-family: 'Montserrat', sans-serif; }
    .search-input:focus { outline: none; border-color: var(--accent-gold); box-shadow: 0 0 0 3px rgba(247,201,72,0.2); }
    .mini-stats { display: flex; gap: 1rem; color: var(--text-light); font-size: .9rem; }
    .presence-teams { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; }
    .team-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 10px 30px var(--shadow-color); overflow: hidden; display: flex; flex-direction: column; }
    .team-card-header { display: flex; align-items: center; justify-content: space-between; padding: .8rem 1rem; background: linear-gradient(90deg, rgba(14,124,58,0.05), rgba(14,124,58,0.02)); border-bottom: 1px solid var(--border-color); }
    .team-title { display: flex; align-items: center; gap: .5rem; font-weight: 800; color: var(--primary-green-dark); }
    .select-all { display: inline-flex; align-items: center; gap: .5rem; color: var(--text-light); font-size: .9rem; }
    .team-card-body { padding: .75rem; display: grid; gap: .5rem; }
    .presence-item { display: flex; align-items: center; gap: .6rem; background: #f8f9fa; padding: .6rem .75rem; border-radius: 10px; border: 1px solid var(--border-color); }
    .presence-item:hover { background: #f3f7f4; }
    .presence-checkbox { width: 18px; height: 18px; }
    .gymnast-name-pres { font-weight: 600; }
    .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .footer-left { color: var(--text-light); font-size: .9rem; }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-title">
            <i class="fas fa-edit"></i>
            <span>Painel de Edi√ß√£o de Notas</span>
            <span class="header-phase">Final por Equipes</span>
        </div>
        <nav class="header-nav">
            <a href="dashboard.html" class="nav-btn"><i class="fas fa-home"></i> Dashboard</a>
            <button id="logout-btn" class="nav-btn"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </nav>
    </header>

    <div class="main-container">
        <aside class="scores-sidebar">
            <h2 class="sidebar-header">Equipes Finalistas</h2>
            <ul id="team-nav-list" class="team-list"></ul>
            <div class="sidebar-controls">
                 <button id="set-presence-btn" class="manaus-button secondary"><i class="fas fa-user-check"></i> Definir Presen√ßa</button>
                <button id="new-draw-btn" class="manaus-button secondary"><i class="fas fa-dice"></i> Novo Sorteio</button>
                <button id="save-draw-btn" class="manaus-button"><i class="fas fa-save"></i> Salvar Sorteio</button>
            </div>
        </aside>

        <main class="content-area">
            <div id="loading" style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
            <div id="teams-container"></div>
        </main>
    </div>

    <footer class="action-footer">
        <button id="generate-random-btn" class="manaus-button secondary"><i class="fas fa-dice"></i> Gerar Aleat√≥rias</button>
        <button id="clear-scores-btn" class="manaus-button danger"><i class="fas fa-trash"></i> Limpar Notas</button>
        <button id="save-scores-btn" class="manaus-button"><i class="fas fa-save"></i> Salvar Todas as Pontua√ß√µes</button>
    </footer>
    
    <div id="presence-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="presence-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="presence-title" class="modal-title"><i class="fas fa-user-check"></i> Definir Presen√ßa <span class="badge">Equipes</span></h3>
                <button id="presence-close-btn" type="button" class="modal-close" aria-label="Fechar"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="presence-toolbar">
                    <input id="presence-search" type="text" class="search-input" placeholder="Buscar ginasta ou pa√≠s..." />
                    <div class="mini-stats"><span id="presence-count"></span></div>
                </div>
                <div id="presence-teams-container" class="presence-teams"></div>
            </div>
            <div class="modal-footer">
                <div class="footer-left" id="presence-footer-info">Selecione as ginastas presentes para a Final por Equipes.</div>
                <div>
                    <button id="cancel-presence-btn" class="manaus-button secondary">Cancelar</button>
                    <button id="save-presence-btn" class="manaus-button"><i class="fas fa-save"></i> Salvar Presen√ßa</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="js/firebase-init.js"></script>
    <script src="js/countries.js"></script>
    <script>
        // Fun√ß√µes auxiliares
        if (typeof getCountryCode !== 'function') { function getCountryCode(country) { const codes = { 'BRA': 'br', 'USA': 'us', 'CHN': 'cn', 'ITA': 'it' }; return codes[country] || 'xx'; } }
        if (typeof getApparatusName !== 'function') { function getApparatusName(code) { const names = { 'VT': 'Salto', 'UB': 'Barras Assim√©tricas', 'BB': 'Trave', 'FX': 'Solo' }; return names[code] || 'xx'; } }

        document.addEventListener('DOMContentLoaded', () => {
            let gymnastsData = [];
            let qualifiedTeams = [];
            let teamFinalDraw = {};

            // DOM Elements
            const loadingPanel = document.getElementById('loading');
            const container = document.getElementById('teams-container');
            const teamNavList = document.getElementById('team-nav-list');
            const modal = document.getElementById('presence-modal');

            async function loadData() {
                try {
                    const db = window.db;
                    const gymnastsSnapshot = await db.collection('new_gymnasts').get();
                    gymnastsData = gymnastsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    calculateQualifiedTeams();
                    renderSidebar();

                    const drawDoc = await db.collection('start_lists').doc('team_final').get();
                    if (drawDoc.exists) {
                        // Suporta salvar como { structure } ou estrutura direta
                        const saved = drawDoc.data().structure || drawDoc.data();
                        teamFinalDraw = normalizeTeamFinalDraw(saved);
                        // Se ap√≥s normalizar n√£o houver rota√ß√µes v√°lidas, gera novo sorteio
                        if (!teamFinalDraw.rotations || !Array.isArray(teamFinalDraw.rotations) || teamFinalDraw.rotations.length === 0) {
                            generateDraw();
                        }
                    } else {
                        generateDraw();
                    }

                    renderTeamCards();
                    setupAllDynamicCalculations();
                    loadExistingScores();
                    loadingPanel.style.display = 'none';
                } catch(e) {
                    console.error("Error loading data:", e);
                    loadingPanel.textContent = "Erro ao carregar dados.";
                }
            }

            // Converte diferentes formatos de sorteio para o formato usado nesta p√°gina:
            // { rotations: [ { number, apparatus: [ { code: 'VT'|'UB'|'BB'|'FX', team: 'BRA', gymnasts: [ids] } ] } ] }
            function normalizeTeamFinalDraw(saved) {
                const result = { rotations: [] };
                if (!saved) return result;

                // Caso 1: Formato j√° esperado
                if (Array.isArray(saved.rotations) && saved.rotations.length > 0) {
                    saved.rotations.forEach(rot => {
                        const rotation = { number: rot.number || result.rotations.length + 1, apparatus: [] };
                        if (Array.isArray(rot.apparatus)) {
                            // J√° √© um array de entradas por equipe
                            rotation.apparatus = rot.apparatus.map(a => ({ code: a.code, team: a.team, gymnasts: Array.isArray(a.gymnasts) ? a.gymnasts : [] }));
                        } else if (rot.apparatus && typeof rot.apparatus === 'object') {
                            // Formato: apparatus: { VT: [athletes...], UB: [...], ... }
                            // Cada item pode ser {country, gymnastId|id|name}
                            Object.keys(rot.apparatus).forEach(appCode => {
                                const athletes = rot.apparatus[appCode] || [];
                                // Agrupar por pa√≠s
                                const byCountry = {};
                                athletes.forEach(a => {
                                    const country = a.country || a.team || 'N/A';
                                    const gymId = a.gymnastId || a.id || null;
                                    if (!byCountry[country]) byCountry[country] = [];
                                    if (gymId) {
                                        byCountry[country].push(gymId);
                                    } else if (a.name) {
                                        // Tentativa de resolver por nome
                                        const match = gymnastsData.find(g => g.name === a.name && g.country === country);
                                        if (match) byCountry[country].push(match.id);
                                    }
                                });
                                Object.keys(byCountry).forEach(country => {
                                    rotation.apparatus.push({ code: appCode.toUpperCase(), team: country, gymnasts: byCountry[country] });
                                });
                            });
                        }
                        result.rotations.push(rotation);
                    });
                    return result;
                }

                // Caso 2: Formato muito antigo: rotation1..rotation4 com mapeamento rotationN[app][country] = [ids]
                if (saved.rotation1 || saved.rotation2 || saved.rotation3 || saved.rotation4) {
                    for (let i = 1; i <= 4; i++) {
                        const rotData = saved[`rotation${i}`];
                        if (!rotData) continue;
                        const rotation = { number: i, apparatus: [] };
                        Object.keys(rotData).forEach(appCode => {
                            const byCountry = rotData[appCode] || {};
                            Object.keys(byCountry).forEach(country => {
                                const ids = Array.isArray(byCountry[country]) ? byCountry[country] : [];
                                rotation.apparatus.push({ code: appCode.toUpperCase(), team: country, gymnasts: ids });
                            });
                        });
                        result.rotations.push(rotation);
                    }
                    return result;
                }

                // Caso 3: Estrutura inv√°lida/desconhecida
                return result;
            }

            function calculateQualifiedTeams() {
                const teamScores = {};
                 gymnastsData.forEach(g => {
                    const scores = g.scores?.qualifiers;
                    if (!scores) return;
                    if (!teamScores[g.country]) teamScores[g.country] = { country: g.country, total: 0, scores: { VT: [], UB: [], BB: [], FX: [] } };
                    const vt1 = (scores.qualifiers_vt1_d || 0) + (scores.qualifiers_vt1_e || 0) - (scores.qualifiers_vt1_p || 0);
                    teamScores[g.country].scores.VT.push(vt1);
                    ['UB', 'BB', 'FX'].forEach(app => {
                        const s = (scores[`qualifiers_${app.toLowerCase()}_d`] || 0) + (scores[`qualifiers_${app.toLowerCase()}_e`] || 0) - (scores[`qualifiers_${app.toLowerCase()}_p`] || 0);
                        teamScores[g.country].scores[app].push(s);
                    });
                });
                
                const rankedTeams = Object.values(teamScores).map(team => {
                    let total = 0;
                    ['VT', 'UB', 'BB', 'FX'].forEach(app => {
                        total += team.scores[app].sort((a,b)=>b-a).slice(0,3).reduce((sum, s) => sum + s, 0);
                    });
                    team.total = total;
                    return team;
                }).sort((a,b) => b.total - a.total);
                
                qualifiedTeams = rankedTeams.slice(0, 8);
            }
            
            function renderSidebar() {
                teamNavList.innerHTML = qualifiedTeams.map((team, index) => `
                     <li><div class="team-item ${index === 0 ? 'active' : ''}" data-href="#team-card-${team.country}">
                        <span class="fi fi-${getCountryCode(team.country)}"></span>${team.country}
                    </div></li>
                `).join('');
                setupSidebarNav();
            }

            function generateDraw() {
                // Gera um sorteio cobrindo TODAS as equipes classificadas (at√© 8),
                // com duas equipes por aparelho por rota√ß√£o (4 rota√ß√µes no total)
                teamFinalDraw = { rotations: [] };
                const apparatusOrder = ['VT', 'UB', 'BB', 'FX'];
                if (!qualifiedTeams || qualifiedTeams.length === 0) return;

                // Ordena para garantir determinismo b√°sico
                const teams = [...qualifiedTeams];

                for (let r = 0; r < 4; r++) {
                    const rotation = { number: r + 1, apparatus: [] };
                    teams.forEach((team, tIndex) => {
                        const appIndex = (tIndex % 4 + r) % 4; // Cada grupo de 4 equipes roda pelos aparelhos
                        const currentApparatus = apparatusOrder[appIndex];
                        const presentGymnasts = gymnastsData.filter(g => g.country === team.country && g.team_final_present !== false);
                        const shuffled = [...presentGymnasts].sort(() => 0.5 - Math.random());
                        
                        let gymnastsForApparatus = [];
                        const count = presentGymnasts.length;
                        
                        // Regras de duplica√ß√£o baseadas no n√∫mero de ginastas presentes
                        if (count === 0) {
                            // Sem ginastas
                            gymnastsForApparatus = [];
                        } else if (count === 1) {
                            // 1 presente: TRIPLICA
                            const g = shuffled[0];
                            gymnastsForApparatus = [
                                { id: g.id, isDuplicate: false },
                                { id: g.id, isDuplicate: true, duplicateOf: g.id },
                                { id: g.id, isDuplicate: true, duplicateOf: g.id }
                            ];
                        } else if (count === 2) {
                            // 2 presentes: um deles √© DUPLICADO randomicamente
                            const randomIndex = Math.floor(Math.random() * 2);
                            const duplicated = shuffled[randomIndex];
                            gymnastsForApparatus = [
                                { id: shuffled[0].id, isDuplicate: false },
                                { id: shuffled[1].id, isDuplicate: false },
                                { id: duplicated.id, isDuplicate: true, duplicateOf: duplicated.id }
                            ];
                        } else if (count === 3) {
                            // 3 presentes: todas as notas contam normalmente
                            gymnastsForApparatus = shuffled.slice(0, 3).map(g => ({ id: g.id, isDuplicate: false }));
                        } else {
                            // 4+ presentes: sorteia 3 randomicamente
                            gymnastsForApparatus = shuffled.slice(0, 3).map(g => ({ id: g.id, isDuplicate: false }));
                        }
                        
                        rotation.apparatus.push({
                            code: currentApparatus,
                            team: team.country,
                            gymnasts: gymnastsForApparatus
                        });
                    });
                    teamFinalDraw.rotations.push(rotation);
                }
            }

            function renderTeamCards() {
                container.innerHTML = qualifiedTeams.map(team => {
                    return `
                    <div class="team-card" id="team-card-${team.country}">
                        <div class="team-card-header"><span class="fi fi-${getCountryCode(team.country)}"></span><h2 class="team-name">${team.country}</h2></div>
                        <div class="apparatus-grid">
                        ${['VT', 'UB', 'BB', 'FX'].map(app => {
                            let rotationNumber = 0;
                            let gymnastsInRotation = [];
                            if (teamFinalDraw.rotations && Array.isArray(teamFinalDraw.rotations)) {
                                for(const rotation of teamFinalDraw.rotations) {
                                    if (rotation.apparatus && Array.isArray(rotation.apparatus)) {
                                        const apparatusData = rotation.apparatus.find(a => a.code === app && a.team === team.country);
                                        if(apparatusData) {
                                            rotationNumber = rotation.number;
                                            // gymnastsInRotation agora √© array de objetos {id, isDuplicate, duplicateOf}
                                            gymnastsInRotation = apparatusData.gymnasts.map(slot => {
                                                const gymnastId = typeof slot === 'object' ? slot.id : slot;
                                                const g = gymnastsData.find(g => g.id === gymnastId);
                                                return g ? { ...g, isDuplicate: slot.isDuplicate || false, duplicateOf: slot.duplicateOf } : null;
                                            }).filter(Boolean);
                                            break;
                                        }
                                    }
                                }
                            }
                            return `
                            <div class="apparatus-section">
                                <h3 class="apparatus-title">${getApparatusName(app)} (Rota√ß√£o ${rotationNumber})</h3>
                                <div class="gymnast-list">
                                ${gymnastsInRotation.map((g, idx) => {
                                    // Se √© duplicata, n√£o mostra campos de input (apenas o nome)
                                    if (g.isDuplicate) {
                                        return `
                                        <div class="gymnast-item" style="opacity: 0.7; background: #f0fdf4;">
                                            <div class="gymnast-info">
                                                <span class="fi fi-${getCountryCode(g.country)}"></span>
                                                <span class="gymnast-name">${g.name} <em style="font-size:0.85em;color:var(--primary-green);">(duplicada)</em></span>
                                            </div>
                                            <div class="score-inputs-grid" style="opacity: 0.5;">
                                                <div class="score-group"><label class="score-label">D</label><span class="score-total-display" id="${g.duplicateOf}_${app}_d_dup${idx}">‚Äî</span></div>
                                                <div class="score-group"><label class="score-label">E</label><span class="score-total-display" id="${g.duplicateOf}_${app}_e_dup${idx}">‚Äî</span></div>
                                                <div class="score-group"><label class="score-label">P</label><span class="score-total-display" id="${g.duplicateOf}_${app}_p_dup${idx}">‚Äî</span></div>
                                                <div class="score-group"><label class="score-label">Total</label><span class="score-total-display" id="${g.duplicateOf}_${app}_total_dup${idx}">‚Äî</span></div>
                                            </div>
                                        </div>
                                        `;
                                    } else {
                                        // Ginasta original: campos edit√°veis
                                        return `
                                        <div class="gymnast-item">
                                            <div class="gymnast-info"><span class="fi fi-${getCountryCode(g.country)}"></span><span class="gymnast-name">${g.name}</span></div>
                                            <div class="score-inputs-grid">
                                                <div class="score-group"><label class="score-label">D</label><input type="number" class="score-input" id="${g.id}_${app}_d" placeholder="0.000"></div>
                                                <div class="score-group"><label class="score-label">E</label><input type="number" class="score-input" id="${g.id}_${app}_e" placeholder="0.000"></div>
                                                <div class="score-group"><label class="score-label">P</label><input type="number" class="score-input" id="${g.id}_${app}_p" placeholder="0.000"></div>
                                                <div class="score-group"><label class="score-label">Total</label><span class="score-total-display" id="${g.id}_${app}_total">0.000</span></div>
                                            </div>
                                        </div>
                                        `;
                                    }
                                }).join('')}
                                </div>
                            </div>
                            `}).join('')}
                        </div>
                    </div>`
                }).join('');
            }
            
            function setupAllDynamicCalculations() {
                 document.querySelectorAll('.score-input').forEach(input => {
                    input.addEventListener('input', () => {
                        const [gymnastId, apparatus] = input.id.split('_');
                        updateTotalScore(gymnastId, apparatus);
                        // Atualiza tamb√©m as duplicatas dessa ginasta
                        updateDuplicateScores(gymnastId, apparatus);
                    });
                });
            }

            function updateDuplicateScores(gymnastId, apparatus) {
                // Procura por campos de duplicata que referenciam esta ginasta original
                const d = parseFloat(document.getElementById(`${gymnastId}_${apparatus}_d`)?.value) || 0;
                const e = parseFloat(document.getElementById(`${gymnastId}_${apparatus}_e`)?.value) || 0;
                const p = parseFloat(document.getElementById(`${gymnastId}_${apparatus}_p`)?.value) || 0;
                const total = (d + e - p).toFixed(3);
                
                // Atualiza todos os displays de duplicata para este gymnastId e apparatus
                // Formato: ${gymnastId}_${apparatus}_d_dup0, ${gymnastId}_${apparatus}_d_dup1, etc.
                document.querySelectorAll(`[id^="${gymnastId}_${apparatus}_"]`).forEach(element => {
                    const id = element.id;
                    // Verifica se √© um campo de duplicata (cont√©m _dup)
                    if (!id.includes('_dup')) return;
                    
                    // Extrai o tipo (d, e, p, ou total) do ID
                    // Formato: gymnastId_apparatus_TYPE_dupN
                    const parts = id.split('_');
                    const typeIndex = parts.length - 2; // Pen√∫ltimo elemento √© o tipo
                    const type = parts[typeIndex];
                    
                    if (type === 'd') {
                        element.textContent = d.toFixed(3);
                    } else if (type === 'e') {
                        element.textContent = e.toFixed(3);
                    } else if (type === 'p') {
                        element.textContent = p.toFixed(3);
                    } else if (type === 'total') {
                        element.textContent = total;
                    }
                });
            }

            function updateTotalScore(gymnastId, apparatus) {
                const d = parseFloat(document.getElementById(`${gymnastId}_${apparatus}_d`)?.value) || 0;
                const e = parseFloat(document.getElementById(`${gymnastId}_${apparatus}_e`)?.value) || 0;
                const p = parseFloat(document.getElementById(`${gymnastId}_${apparatus}_p`)?.value) || 0;
                const totalDisplay = document.getElementById(`${gymnastId}_${apparatus}_total`);
                if (totalDisplay) totalDisplay.textContent = (d + e - p).toFixed(3);
            }

            function loadExistingScores() {
                gymnastsData.forEach(gymnast => {
                    const scores = gymnast.scores?.team_final;
                    if (!scores) return;
                    ['VT', 'UB', 'BB', 'FX'].forEach(app => {
                         ['d', 'e', 'p'].forEach(type => {
                            const input = document.getElementById(`${gymnast.id}_${app}_${type}`);
                            const scoreKey = `team_final_${app.toLowerCase()}_${type}`;
                            if(input && scores[scoreKey] !== undefined) input.value = scores[scoreKey];
                        });
                        updateTotalScore(gymnast.id, app);
                    });
                });
            }
            
            function setupSidebarNav() {
                 document.querySelectorAll('.team-item').forEach(link => {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        document.querySelectorAll('.team-item').forEach(l => l.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        const targetId = e.currentTarget.dataset.href;
                        document.querySelector(targetId)?.scrollIntoView({ behavior: 'smooth' });
                    });
                });
            }
            
            // Modal Logic (novo layout)
            function openPresenceModal() {
                buildPresenceUI();
                document.getElementById('presence-modal').style.display = 'flex';
                document.getElementById('presence-modal').setAttribute('aria-hidden', 'false');
                setTimeout(() => document.getElementById('presence-search')?.focus(), 50);
            }

            function closePresenceModal() {
                document.getElementById('presence-modal').style.display = 'none';
                document.getElementById('presence-modal').setAttribute('aria-hidden', 'true');
            }

            function buildPresenceUI() {
                const container = document.getElementById('presence-teams-container');
                const allTeams = qualifiedTeams.map(t => t.country);
                const teamsSet = new Set(allTeams);
                const grouped = Array.from(teamsSet).map(country => ({
                    country,
                    gymnasts: gymnastsData.filter(g => g.country === country)
                }));

                container.innerHTML = grouped.map(group => {
                    const total = group.gymnasts.length;
                    const checkedCount = group.gymnasts.filter(g => g.team_final_present !== false).length;
                    const allChecked = total > 0 && checkedCount === total;
                    return `
                        <div class="team-card" data-country="${group.country}">
                            <div class="team-card-header">
                                <div class="team-title"><span class="fi fi-${getCountryCode(group.country)}"></span>${group.country}</div>
                                <label class="select-all">
                                    <input type="checkbox" class="presence-select-all" data-country="${group.country}" ${allChecked ? 'checked' : ''}>
                                    Selecionar todos (${checkedCount}/${total})
                                </label>
                            </div>
                            <div class="team-card-body">
                                ${group.gymnasts.map(g => `
                                    <div class="presence-item" data-name="${(g.name||'').toLowerCase()}" data-country="${group.country}">
                                        <input type="checkbox" id="presence-${g.id}" class="presence-checkbox" data-id="${g.id}" ${g.team_final_present !== false ? 'checked' : ''}>
                                        <label class="gymnast-name-pres" for="presence-${g.id}">${g.name}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

                updatePresenceStats();

                // Eventos de Select All
                container.querySelectorAll('.presence-select-all').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        const country = e.currentTarget.getAttribute('data-country');
                        const teamCard = container.querySelector(`.team-card[data-country="${country}"]`);
                        teamCard.querySelectorAll('.presence-checkbox').forEach(box => { box.checked = e.currentTarget.checked; });
                        updateTeamHeaderCount(teamCard);
                        updatePresenceStats();
                    });
                });

                // Eventos de checkbox individuais
                container.querySelectorAll('.presence-checkbox').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        const teamCard = e.currentTarget.closest('.team-card');
                        updateTeamHeaderCount(teamCard);
                        updatePresenceStats();
                    });
                });

                // Busca
                const search = document.getElementById('presence-search');
                search.oninput = () => filterPresence(search.value);
            }

            function updateTeamHeaderCount(teamCard) {
                const boxes = teamCard.querySelectorAll('.presence-checkbox');
                const total = boxes.length;
                const checked = Array.from(boxes).filter(b => b.checked).length;
                const selectAll = teamCard.querySelector('.presence-select-all');
                if (selectAll) selectAll.checked = total > 0 && checked === total;
                const label = teamCard.querySelector('.select-all');
                if (label) label.innerHTML = `<input type="checkbox" class="presence-select-all" data-country="${teamCard.getAttribute('data-country')}" ${checked===total && total>0?'checked':''}> Selecionar todos (${checked}/${total})`;
                // Re-wire the select-all after innerHTML update
                const newSelectAll = teamCard.querySelector('.presence-select-all');
                newSelectAll.addEventListener('change', (e) => {
                    teamCard.querySelectorAll('.presence-checkbox').forEach(box => { box.checked = e.currentTarget.checked; });
                    updateTeamHeaderCount(teamCard);
                    updatePresenceStats();
                });
            }

            function updatePresenceStats() {
                const allBoxes = document.querySelectorAll('#presence-teams-container .presence-checkbox');
                const total = allBoxes.length;
                const checked = Array.from(allBoxes).filter(b => b.checked).length;
                const countEl = document.getElementById('presence-count');
                if (countEl) countEl.textContent = `${checked}/${total} presentes`;
                const footerInfo = document.getElementById('presence-footer-info');
                if (footerInfo) footerInfo.textContent = `Selecionados ${checked} de ${total} atletas.`;
            }

            function filterPresence(query) {
                const q = (query || '').toLowerCase().trim();
                const cards = document.querySelectorAll('#presence-teams-container .team-card');
                cards.forEach(card => {
                    const country = (card.getAttribute('data-country') || '').toLowerCase();
                    let anyVisible = false;
                    card.querySelectorAll('.presence-item').forEach(item => {
                        const name = item.getAttribute('data-name');
                        const match = !q || name.includes(q) || country.includes(q);
                        item.style.display = match ? 'flex' : 'none';
                        if (match) anyVisible = true;
                    });
                    card.style.display = anyVisible ? 'flex' : 'none';
                });
            }

            document.getElementById('set-presence-btn').onclick = openPresenceModal;
            const presenceCloseBtn = document.getElementById('presence-close-btn');
            if (presenceCloseBtn) presenceCloseBtn.onclick = (e) => { e.preventDefault(); closePresenceModal(); };
            const cancelPresenceBtn = document.getElementById('cancel-presence-btn');
            if (cancelPresenceBtn) cancelPresenceBtn.onclick = (e) => { e.preventDefault(); closePresenceModal(); };
            // Click fora do conte√∫do fecha o modal
            const presenceModal = document.getElementById('presence-modal');
            if (presenceModal) {
                presenceModal.addEventListener('click', (e) => {
                    if (e.target === presenceModal) closePresenceModal();
                });
            }
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePresenceModal(); });
            document.getElementById('save-presence-btn').onclick = async () => {
                const batch = window.db.batch();
                document.querySelectorAll('.presence-checkbox').forEach(cb => {
                    const ref = window.db.collection('new_gymnasts').doc(cb.dataset.id);
                    batch.update(ref, { team_final_present: cb.checked });
                });
                await batch.commit();
                closePresenceModal();
                loadData(); 
            };

            document.getElementById('new-draw-btn').onclick = async () => {
                if (confirm("Gerar um novo sorteio? Isso ir√° substituir o sorteio atual.")) {
                    generateDraw();
                    renderTeamCards();
                    setupAllDynamicCalculations();
                    loadExistingScores();
                    alert("Sorteio gerado! Clique em 'Salvar Sorteio' para confirmar.");
                }
            };
            
            document.getElementById('save-draw-btn').onclick = async () => {
                if (!teamFinalDraw || !teamFinalDraw.rotations || teamFinalDraw.rotations.length === 0) {
                    alert("N√£o h√° sorteio para salvar. Gere um novo sorteio primeiro.");
                    return;
                }
                try {
                    // Converter para o formato que stcontrol/stream esperam
                    const stcontrolFormat = convertToStcontrolFormat(teamFinalDraw);
                    console.log('[Edit TF] üíæ Salvando estrutura:', stcontrolFormat);
                    console.log('[Edit TF] üíæ Type:', stcontrolFormat.type);
                    console.log('[Edit TF] üíæ Rotations:', stcontrolFormat.rotations.length);
                    
                    await window.db.collection('start_lists').doc('team_final').set({ 
                        structure: stcontrolFormat,
                        lastUpdated: new Date() 
                    });
                    
                    console.log('[Edit TF] ‚úÖ Sorteio salvo com sucesso no Firebase!');
                    const saveBtn = document.getElementById('save-draw-btn');
                    const originalHTML = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<i class="fas fa-check"></i> Sorteio Salvo!';
                    saveBtn.style.background = '#10b981';
                    setTimeout(() => {
                        saveBtn.innerHTML = originalHTML;
                        saveBtn.style.background = '';
                    }, 2000);
                } catch (e) {
                    console.error('Erro ao salvar sorteio:', e);
                    alert('Erro ao salvar o sorteio. Tente novamente.');
                }
            };
            
            // Converte o formato interno para o formato que stcontrol/stream esperam
            function convertToStcontrolFormat(draw) {
                const converted = {
                    type: 'team_final',
                    rotations: []
                };
                
                draw.rotations.forEach((rotation, rotIdx) => {
                    const convertedRotation = {
                        number: rotation.number,
                        apparatus: {}  // OBJETO, n√£o array!
                    };
                    
                    // Agrupa por aparelho (VT, UB, BB, FX)
                    ['VT', 'UB', 'BB', 'FX'].forEach(appCode => {
                        const teamsOnThisApparatus = rotation.apparatus.filter(a => a.code === appCode);
                        
                        // Para cada equipe neste aparelho, adiciona as ginastas
                        const allGymnastsOnApparatus = [];
                        teamsOnThisApparatus.forEach(teamData => {
                            teamData.gymnasts.forEach(slot => {
                                const gymnastId = typeof slot === 'object' ? slot.id : slot;
                                const gymnast = gymnastsData.find(g => g.id === gymnastId);
                                if (gymnast) {
                                    const athleteData = {
                                        id: gymnast.id,
                                        name: gymnast.name,
                                        country: gymnast.country,
                                        isDuplicate: slot.isDuplicate || false
                                    };
                                    // S√≥ adiciona duplicateOf se for realmente uma duplicata
                                    if (slot.isDuplicate && slot.duplicateOf) {
                                        athleteData.duplicateOf = slot.duplicateOf;
                                    }
                                    allGymnastsOnApparatus.push(athleteData);
                                }
                            });
                        });
                        
                        // Salva como propriedade do objeto, n√£o como array
                        convertedRotation.apparatus[appCode] = allGymnastsOnApparatus;
                    });
                    
                    converted.rotations.push(convertedRotation);
                });
                
                console.log('[Edit TF] üîç Estrutura convertida:', JSON.stringify(converted, null, 2));
                return converted;
            }
            
            // Main Actions
            document.getElementById('save-scores-btn').onclick = async () => {
                const db = window.db;
                const batch = db.batch();
                gymnastsData.forEach(gymnast => {
                    const gymnastRef = db.collection('new_gymnasts').doc(gymnast.id);
                    const scoresToUpdate = gymnast.scores || {};
                    if(!scoresToUpdate.team_final) scoresToUpdate.team_final = {};
                    let hasUpdate = false;
                    ['VT', 'UB', 'BB', 'FX'].forEach(app => {
                        const dInput = document.getElementById(`${gymnast.id}_${app}_d`);
                        if(dInput){
                             const d = dInput.value;
                             const e = document.getElementById(`${gymnast.id}_${app}_e`).value;
                             const p = document.getElementById(`${gymnast.id}_${app}_p`).value;
                             if (d || e || p) {
                                scoresToUpdate.team_final[`team_final_${app.toLowerCase()}_d`] = parseFloat(d) || 0;
                                scoresToUpdate.team_final[`team_final_${app.toLowerCase()}_e`] = parseFloat(e) || 0;
                                scoresToUpdate.team_final[`team_final_${app.toLowerCase()}_p`] = parseFloat(p) || 0;
                                hasUpdate = true;
                             }
                        }
                    });
                    if (hasUpdate) batch.set(gymnastRef, { scores: scoresToUpdate }, { merge: true });
                });
                try {
                    await batch.commit();
                    // Converter para formato stcontrol antes de salvar
                    const stcontrolFormat = convertToStcontrolFormat(teamFinalDraw);
                    await db.collection('start_lists').doc('team_final').set({structure: stcontrolFormat, lastUpdated: new Date()});
                    alert('Pontua√ß√µes salvas com sucesso!');
                } catch (error) { console.error('Erro ao salvar:', error); alert('Erro ao salvar pontua√ß√µes.'); }
            };

            document.getElementById('generate-random-btn').onclick = () => {
                document.querySelectorAll('.score-input').forEach(input => {
                    const [gymnastId, apparatus, type] = input.id.split('_');
                    if(type === 'd') input.value = (Math.random() * 3 + 4).toFixed(3);
                    if(type === 'e') input.value = (Math.random() * 2 + 7).toFixed(3);
                    if(type === 'p') input.value = (Math.random() * 0.5).toFixed(3);
                    updateTotalScore(gymnastId, apparatus);
                });
            };

            document.getElementById('clear-scores-btn').onclick = () => {
                if(!confirm('Tem certeza que deseja limpar todas as notas?')) return;
                document.querySelectorAll('.score-input').forEach(input => {
                    const [gymnastId, apparatus] = input.id.split('_');
                    input.value = '';
                    updateTotalScore(gymnastId, apparatus);
                });
            };

            function initializeApp() {
                if (!window.db || !window.auth) { setTimeout(initializeApp, 100); return; }
                const auth = window.auth;
                auth.onAuthStateChanged(user => {
                    if (user) { loadData(); } else { window.location.href = 'login.html'; }
                });
                document.getElementById('logout-btn').onclick = () => auth.signOut().then(() => window.location.href = 'login.html');
            }
            initializeApp();
        });
    </script>
</body>
</html>

