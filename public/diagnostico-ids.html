<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de IDs - Manaus 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        // Firebase config inline
        const firebaseConfig = {
            apiKey: "AIzaSyAxUEcAze739pFzE_T9O_plNb_jWOMRowI",
            authDomain: "cozygymnastics.firebaseapp.com",
            projectId: "cozygymnastics",
            storageBucket: "cozygymnastics.appspot.com",
            messagingSenderId: "977608365901",
            appId: "1:977608365901:web:3040bf9cb269e7363e4904",
            measurementId: "G-FYRCES6W8Y"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        window.db = db;
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Montserrat', sans-serif;
            background: #f8fcf9;
            padding: 2rem;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #0e7c3a;
            margin-bottom: 2rem;
            font-size: 2rem;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h2 {
            color: #0b5d2b;
            margin-bottom: 1rem;
            font-size: 1.4rem;
            border-bottom: 2px solid #f7c948;
            padding-bottom: 0.5rem;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .status.ok {
            background: #d4edda;
            color: #155724;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #0e7c3a;
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background: #f0f0f0;
        }
        .missing {
            color: #dc3545;
            font-weight: 600;
        }
        .found {
            color: #28a745;
            font-weight: 600;
        }
        button {
            background: linear-gradient(135deg, #0e7c3a, #009f3d);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            margin-top: 1rem;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 124, 58, 0.3);
        }
        #loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #0e7c3a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de IDs - Ginastas vs Start Lists</h1>
        
        <div id="loading">Carregando dados do Firebase...</div>
        
        <div id="results" style="display: none;">
            <div class="section">
                <h2>üìä Resumo Geral</h2>
                <div id="summary"></div>
            </div>
            
            <div class="section">
                <h2>üìÇ Collections de Start Lists</h2>
                <div id="collections-info"></div>
            </div>
            
            <div class="section">
                <h2>üîç Estrutura da Start List (qualifiers)</h2>
                <div id="startlist-structure"></div>
            </div>

            <div class="section">
                <h2>üë≠ Ginastas no Firebase (new_gymnasts)</h2>
                <div id="gymnasts-list"></div>
            </div>

            <div class="section">
                <h2>üìù IDs nas Start Lists (qualifiers)</h2>
                <div id="startlist-ids"></div>
            </div>

            <div class="section">
                <h2>‚ö†Ô∏è Problemas Encontrados</h2>
                <div id="problems"></div>
            </div>

            <div class="section">
                <h2>‚úÖ Solu√ß√µes</h2>
                <div id="solutions"></div>
            </div>
        </div>
    </div>

    <script>
        async function diagnosticar() {
            try {
                // 0. Verificar ambas as collections de start lists
                console.log('üîç Verificando collections de start lists...');
                
                const startListsUnderscore = await db.collection('start_lists').get();
                const startListsCamelCase = await db.collection('startLists').get();
                
                const underscoreCount = startListsUnderscore.docs.length;
                const camelCaseCount = startListsCamelCase.docs.length;
                
                console.log(`start_lists (underscore): ${underscoreCount} documentos`);
                console.log(`startLists (camelCase): ${camelCaseCount} documentos`);
                
                // Adicionar alerta no topo se houver duplica√ß√£o
                if (underscoreCount > 0 && camelCaseCount > 0) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'section';
                    alertDiv.innerHTML = `
                        <div class="status error">
                            <strong>‚ö†Ô∏è ATEN√á√ÉO: Duas collections de Start Lists encontradas!</strong>
                        </div>
                        <p style="margin-top: 1rem;">
                            ‚Ä¢ <code>start_lists</code> (underscore): <strong>${underscoreCount} documentos</strong><br>
                            ‚Ä¢ <code>startLists</code> (camelCase): <strong>${camelCaseCount} documentos</strong>
                        </p>
                        <div class="status warning" style="margin-top: 1rem;">
                            <strong>üìå Collection correta:</strong> <code>start_lists</code> (com underscore)<br>
                            Todos os arquivos do sistema usam <code>start_lists</code>
                        </div>
                    `;
                    document.getElementById('results').prepend(alertDiv);
                }
                
                // Usar a collection correta
                const correctCollection = 'start_lists';
                
                // 1. Buscar todas as ginastas
                const gymnastsSnapshot = await db.collection('new_gymnasts').get();
                const gymnasts = {};
                gymnastsSnapshot.forEach(doc => {
                    const data = doc.data();
                    gymnasts[doc.id] = {
                        id: doc.id,
                        name: data.name,
                        country: data.country
                    };
                });

                // 2. Buscar start list de qualifiers
                const startListDoc = await db.collection(correctCollection).doc('qualifiers').get();
                const startListData = startListDoc.data();
                
                console.log('üìã Start List Data:', startListData);
                console.log('üìã Start List Structure:', JSON.stringify(startListData, null, 2));
                
                // 2b. Listar todos os documentos em ambas collections
                const underscoreDocs = [];
                startListsUnderscore.forEach(doc => {
                    underscoreDocs.push({
                        id: doc.id,
                        exists: doc.exists,
                        hasData: doc.data() ? Object.keys(doc.data()).length > 0 : false
                    });
                });
                
                const camelCaseDocs = [];
                startListsCamelCase.forEach(doc => {
                    camelCaseDocs.push({
                        id: doc.id,
                        exists: doc.exists,
                        hasData: doc.data() ? Object.keys(doc.data()).length > 0 : false
                    });
                });
                
                // 3. Extrair todos os IDs da start list
                const startListIds = new Set();
                const gymnastsByRotation = {};
                
                if (startListData) {
                    // Verificar diferentes formatos poss√≠veis
                    let rotationsToProcess = null;
                    
                    // Formato 1: { rotations: [...] }
                    if (startListData.rotations) {
                        rotationsToProcess = startListData.rotations;
                        console.log('‚úÖ Formato encontrado: { rotations: [...] }');
                    }
                    // Formato 2: { structure: { rotations: [...] } }
                    else if (startListData.structure && startListData.structure.rotations) {
                        rotationsToProcess = startListData.structure.rotations;
                        console.log('‚úÖ Formato encontrado: { structure: { rotations: [...] } }');
                    }
                    // Formato 3: { subdivisions: [{ rotations: [...] }] }
                    else if (startListData.subdivisions && startListData.subdivisions[0]?.rotations) {
                        rotationsToProcess = startListData.subdivisions[0].rotations;
                        console.log('‚úÖ Formato encontrado: { subdivisions: [{ rotations: [...] }] }');
                    }
                    // Formato 4: { structure: { subdivisions: [{ rotations: [...] }] } }
                    else if (startListData.structure?.subdivisions && startListData.structure.subdivisions[0]?.rotations) {
                        rotationsToProcess = startListData.structure.subdivisions[0].rotations;
                        console.log('‚úÖ Formato encontrado: { structure: { subdivisions: [{ rotations: [...] }] } }');
                    }
                    
                    if (rotationsToProcess && rotationsToProcess.length > 0) {
                        console.log(`‚úÖ ${rotationsToProcess.length} rota√ß√µes encontradas`);
                        rotationsToProcess.forEach((rotation, rotIdx) => {
                            if (rotation.apparatus) {
                                Object.keys(rotation.apparatus).forEach(app => {
                                    const athletes = rotation.apparatus[app] || [];
                                    console.log(`Rota√ß√£o ${rotIdx + 1}, ${app.toUpperCase()}: ${athletes.length} atletas`);
                                    athletes.forEach(athlete => {
                                        startListIds.add(athlete.id);
                                        if (!gymnastsByRotation[athlete.id]) {
                                            gymnastsByRotation[athlete.id] = {
                                                name: athlete.name,
                                                country: athlete.country,
                                                rotations: []
                                            };
                                        }
                                        gymnastsByRotation[athlete.id].rotations.push(`R${rotIdx + 1}-${app.toUpperCase()}`);
                                    });
                                });
                            }
                        });
                    } else {
                        console.warn('‚ö†Ô∏è Nenhuma rota√ß√£o encontrada na start list!');
                        console.log('Estrutura completa:', startListData);
                    }
                }

                // 4. Comparar
                const missingInFirebase = [];
                const foundInBoth = [];
                
                startListIds.forEach(id => {
                    if (gymnasts[id]) {
                        foundInBoth.push({
                            id: id,
                            name: gymnasts[id].name,
                            country: gymnasts[id].country,
                            rotations: gymnastsByRotation[id].rotations
                        });
                    } else {
                        missingInFirebase.push({
                            id: id,
                            name: gymnastsByRotation[id].name,
                            country: gymnastsByRotation[id].country,
                            rotations: gymnastsByRotation[id].rotations
                        });
                    }
                });

                // 5. Ginastas no Firebase que n√£o est√£o na start list
                const notInStartList = [];
                Object.keys(gymnasts).forEach(id => {
                    if (!startListIds.has(id)) {
                        notInStartList.push(gymnasts[id]);
                    }
                });

                // 6. Exibir resultados
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
                
                displaySummary(gymnasts, startListIds, missingInFirebase, foundInBoth, notInStartList);
                displayCollectionsInfo(underscoreDocs, camelCaseDocs, correctCollection);
                displayStartListStructure(startListData);
                displayGymnasts(gymnasts);
                displayStartListIds(gymnastsByRotation);
                displayProblems(missingInFirebase, notInStartList);
                displaySolutions(missingInFirebase);
                
            } catch (error) {
                console.error('Erro no diagn√≥stico:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="status error">
                        ‚ùå Erro ao carregar dados: ${error.message}
                    </div>
                `;
            }
        }

        function displaySummary(gymnasts, startListIds, missingInFirebase, foundInBoth, notInStartList) {
            const total = Object.keys(gymnasts).length;
            const totalInStartList = startListIds.size;
            
            let html = `
                <div class="status ${missingInFirebase.length === 0 ? 'ok' : 'error'}">
                    <strong>Total de ginastas no Firebase:</strong> ${total}
                </div>
                <div class="status ${missingInFirebase.length === 0 ? 'ok' : 'warning'}">
                    <strong>Total de IDs nas Start Lists:</strong> ${totalInStartList}
                </div>
                <div class="status ${foundInBoth.length === totalInStartList ? 'ok' : 'error'}">
                    <strong>IDs encontrados em ambos:</strong> ${foundInBoth.length}
                </div>
                <div class="status ${missingInFirebase.length === 0 ? 'ok' : 'error'}">
                    <strong>‚ö†Ô∏è IDs faltando no Firebase:</strong> ${missingInFirebase.length}
                </div>
                <div class="status ${notInStartList.length === 0 ? 'ok' : 'warning'}">
                    <strong>Ginastas n√£o usadas nas Start Lists:</strong> ${notInStartList.length}
                </div>
            `;
            
            document.getElementById('summary').innerHTML = html;
        }
        
        function displayCollectionsInfo(underscoreDocs, camelCaseDocs, correctCollection) {
            let html = '';
            
            if (underscoreDocs.length === 0 && camelCaseDocs.length === 0) {
                html = `<div class="status error">‚ùå Nenhuma start list encontrada em nenhuma collection!</div>`;
            } else {
                html += `<div class="status ${correctCollection === 'start_lists' ? 'ok' : 'warning'}">
                    <strong>‚úÖ Collection CORRETA sendo usada pelo sistema:</strong> <code>start_lists</code>
                </div>`;
                
                if (underscoreDocs.length > 0) {
                    html += `
                        <div style="margin-top: 1rem;">
                            <strong>üìÅ start_lists (underscore) - ${underscoreDocs.length} documentos:</strong>
                            <ul style="margin-left: 2rem; margin-top: 0.5rem;">`;
                    underscoreDocs.forEach(doc => {
                        html += `<li><code>${doc.id}</code> ${doc.hasData ? '‚úÖ' : '‚ö†Ô∏è vazio'}</li>`;
                    });
                    html += `</ul></div>`;
                }
                
                if (camelCaseDocs.length > 0) {
                    html += `
                        <div style="margin-top: 1rem;">
                            <strong>üìÅ startLists (camelCase) - ${camelCaseDocs.length} documentos:</strong>
                            <ul style="margin-left: 2rem; margin-top: 0.5rem;">`;
                    camelCaseDocs.forEach(doc => {
                        html += `<li><code>${doc.id}</code> ${doc.hasData ? '‚úÖ' : '‚ö†Ô∏è vazio'}</li>`;
                    });
                    html += `</ul>
                        <div class="status warning" style="margin-top: 0.5rem;">
                            ‚ö†Ô∏è Esta collection N√ÉO √© usada pelo sistema. Voc√™ pode delet√°-la se quiser.
                        </div>
                    </div>`;
                }
            }
            
            document.getElementById('collections-info').innerHTML = html;
        }
        
        function displayStartListStructure(startListData) {
            let html = '';
            
            if (!startListData) {
                html = `<div class="status error">‚ùå A start list 'qualifiers' est√° VAZIA ou n√£o existe!</div>`;
            } else {
                const keys = Object.keys(startListData);
                html += `<div class="status ${keys.length > 0 ? 'ok' : 'error'}">
                    <strong>Campos encontrados na start list:</strong> ${keys.join(', ')}
                </div>`;
                
                // Mostrar estrutura detalhada
                html += `<div style="margin-top: 1rem; background: #f5f5f5; padding: 1rem; border-radius: 8px; overflow-x: auto;">
                    <strong>Estrutura JSON:</strong>
                    <pre style="margin-top: 0.5rem; font-size: 0.85rem; white-space: pre-wrap;">${JSON.stringify(startListData, null, 2)}</pre>
                </div>`;
                
                // Diagn√≥stico de formato
                let formatFound = false;
                let rotationsCount = 0;
                
                if (startListData.rotations) {
                    formatFound = true;
                    rotationsCount = startListData.rotations.length;
                    html += `<div class="status ok" style="margin-top: 1rem;">
                        ‚úÖ Formato: <code>{ rotations: [...] }</code> - ${rotationsCount} rota√ß√µes
                    </div>`;
                } else if (startListData.structure?.rotations) {
                    formatFound = true;
                    rotationsCount = startListData.structure.rotations.length;
                    html += `<div class="status ok" style="margin-top: 1rem;">
                        ‚úÖ Formato: <code>{ structure: { rotations: [...] } }</code> - ${rotationsCount} rota√ß√µes
                    </div>`;
                } else if (startListData.subdivisions) {
                    formatFound = true;
                    rotationsCount = startListData.subdivisions[0]?.rotations?.length || 0;
                    html += `<div class="status ok" style="margin-top: 1rem;">
                        ‚úÖ Formato: <code>{ subdivisions: [{ rotations: [...] }] }</code> - ${rotationsCount} rota√ß√µes
                    </div>`;
                } else if (startListData.structure?.subdivisions) {
                    formatFound = true;
                    rotationsCount = startListData.structure.subdivisions[0]?.rotations?.length || 0;
                    html += `<div class="status ok" style="margin-top: 1rem;">
                        ‚úÖ Formato: <code>{ structure: { subdivisions: [...] } }</code> - ${rotationsCount} rota√ß√µes
                    </div>`;
                }
                
                if (!formatFound) {
                    html += `<div class="status error" style="margin-top: 1rem;">
                        ‚ùå Formato n√£o reconhecido! A start list n√£o tem a estrutura esperada.
                    </div>`;
                } else if (rotationsCount === 0) {
                    html += `<div class="status warning" style="margin-top: 1rem;">
                        ‚ö†Ô∏è Start list encontrada, mas est√° VAZIA (0 rota√ß√µes)
                    </div>`;
                }
            }
            
            document.getElementById('startlist-structure').innerHTML = html;
        }

        function displayGymnasts(gymnasts) {
            const sorted = Object.values(gymnasts).sort((a, b) => a.name.localeCompare(b.name));
            
            let html = `<table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Pa√≠s</th>
                        <th>ID do Firebase</th>
                    </tr>
                </thead>
                <tbody>`;
            
            sorted.forEach(g => {
                html += `
                    <tr>
                        <td>${g.name}</td>
                        <td>${g.country}</td>
                        <td><code>${g.id}</code></td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            document.getElementById('gymnasts-list').innerHTML = html;
        }

        function displayStartListIds(gymnastsByRotation) {
            const sorted = Object.entries(gymnastsByRotation).sort((a, b) => a[1].name.localeCompare(b[1].name));
            
            let html = `<table>
                <thead>
                    <tr>
                        <th>Nome (da Start List)</th>
                        <th>Pa√≠s</th>
                        <th>ID</th>
                        <th>Rota√ß√µes</th>
                    </tr>
                </thead>
                <tbody>`;
            
            sorted.forEach(([id, data]) => {
                html += `
                    <tr>
                        <td>${data.name}</td>
                        <td>${data.country}</td>
                        <td><code>${id}</code></td>
                        <td>${data.rotations.join(', ')}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            document.getElementById('startlist-ids').innerHTML = html;
        }

        function displayProblems(missingInFirebase, notInStartList) {
            let html = '';
            
            if (missingInFirebase.length > 0) {
                html += `<div class="status error">
                    <strong>‚ùå ${missingInFirebase.length} ginastas est√£o na Start List mas N√ÉO existem no Firebase:</strong>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Pa√≠s</th>
                            <th>ID Esperado</th>
                            <th>Rota√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                missingInFirebase.forEach(g => {
                    html += `
                        <tr>
                            <td class="missing">${g.name}</td>
                            <td>${g.country}</td>
                            <td><code>${g.id}</code></td>
                            <td>${g.rotations.join(', ')}</td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
            }
            
            if (notInStartList.length > 0) {
                html += `<div class="status warning" style="margin-top: 1rem;">
                    <strong>‚ö†Ô∏è ${notInStartList.length} ginastas existem no Firebase mas N√ÉO est√£o em nenhuma Start List:</strong>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Pa√≠s</th>
                            <th>ID</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                notInStartList.forEach(g => {
                    html += `
                        <tr>
                            <td>${g.name}</td>
                            <td>${g.country}</td>
                            <td><code>${g.id}</code></td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
            }
            
            if (missingInFirebase.length === 0 && notInStartList.length === 0) {
                html = `<div class="status ok">‚úÖ Nenhum problema encontrado! Todos os IDs est√£o sincronizados.</div>`;
            }
            
            document.getElementById('problems').innerHTML = html;
        }

        function displaySolutions(missingInFirebase) {
            let html = '';
            
            if (missingInFirebase.length > 0) {
                html = `
                    <div class="status warning">
                        <strong>üí° Voc√™ precisa:</strong>
                    </div>
                    <ol style="margin-left: 2rem; margin-top: 1rem; line-height: 1.8;">
                        <li><strong>OP√á√ÉO 1 (Recomendado):</strong> Gerar novas Start Lists usando as ginastas atuais do Firebase
                            <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                <li>V√° para a p√°gina de Start Lists (qualifiers)</li>
                                <li>Clique em "Gerar Start List"</li>
                                <li>Isso ir√° criar uma nova start list com os IDs corretos</li>
                            </ul>
                        </li>
                        <li style="margin-top: 1rem;"><strong>OP√á√ÉO 2:</strong> Recriar as ginastas com os IDs espec√≠ficos da Start List
                            <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                <li>‚ö†Ô∏è Mais trabalhoso e pode causar outros problemas</li>
                                <li>Voc√™ precisaria deletar e recriar cada ginasta com o ID exato</li>
                            </ul>
                        </li>
                    </ol>
                    
                    <div class="status error" style="margin-top: 1.5rem;">
                        <strong>‚ö†Ô∏è IMPORTANTE:</strong> O problema aconteceu porque quando voc√™ adiciona ginastas pelo gymnasts.html,
                        o Firebase gera IDs aleat√≥rios automaticamente. As Start Lists antigas t√™m refer√™ncias aos IDs antigos.
                    </div>
                `;
            } else {
                // Se n√£o h√° IDs faltando, mas a start list est√° vazia
                html = `
                    <div class="status error">
                        <strong>‚ùå Problema:</strong> A start list de qualifiers est√° VAZIA!
                    </div>
                    <div style="margin-top: 1rem; line-height: 1.8;">
                        <strong>üîß Solu√ß√£o:</strong>
                        <ol style="margin-left: 2rem; margin-top: 0.5rem;">
                            <li>Abra: <code>start-list-qualifiers.html</code></li>
                            <li>Clique no bot√£o <strong>"Gerar Start List"</strong></li>
                            <li>Configure as rota√ß√µes e distribua as ginastas</li>
                            <li>Clique em <strong>"Salvar Start List"</strong></li>
                        </ol>
                        
                        <div class="status warning" style="margin-top: 1rem;">
                            <strong>üìù Nota:</strong> Voc√™ tem 16 ginastas dispon√≠veis no Firebase prontas para serem adicionadas √† start list!
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('solutions').innerHTML = html;
        }

        // Iniciar diagn√≥stico quando carregar
        setTimeout(() => {
            if (typeof window.db !== 'undefined') {
                diagnosticar();
            } else {
                document.getElementById('loading').innerHTML = '‚ùå Erro: Firebase n√£o inicializado';
            }
        }, 1000);
    </script>
</body>
</html>
