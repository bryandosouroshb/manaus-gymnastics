<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé• Stream Control - Manaus 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #22c55e;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #ef4444;
            --accent: #22c55e;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-light: #f8fafc;
            --text-muted: #64748b;
            --border: rgba(148, 163, 184, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0c1426 100%);
            color: var(--text-light);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), #16a34a);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        .container {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 24px;
        }

        .left-panel {
            display: grid;
            gap: 20px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .btn {
            background: #374151;
            color: var(--text-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: block;
            width: 100%;
            margin-bottom: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn.primary { background: var(--success); border-color: var(--success); }
        .btn.warning { background: var(--warning); border-color: var(--warning); color: #000; }
        .btn.danger { background: var(--danger); border-color: var(--danger); }
        .btn.accent { background: var(--accent); border-color: var(--accent); }
        .btn.active { background: var(--primary); border-color: var(--primary); }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .timer-display {
            background: linear-gradient(135deg, #1f2937, #111827);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }

        .timer-time {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            margin-bottom: 8px;
            letter-spacing: 2px;
        }

        .timer-status {
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .timer-status.wait { color: var(--text-muted); }
        .timer-status.go { color: var(--success); }
        .timer-status.stop { color: var(--danger); }

        .current-gymnast {
            background: linear-gradient(135deg, var(--accent), #0891b2);
            text-align: center;
        }

        .gymnast-name { 
            font-size: 1.2rem; 
            font-weight: 600; 
            margin-bottom: 4px; 
        }
        
        .gymnast-details { 
            font-size: 0.9rem; 
            opacity: 0.9; 
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .checkbox-wrapper input { 
            accent-color: var(--primary); 
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        .form-select option {
            background: var(--bg-card);
            color: var(--text-light);
        }

        .current-gymnast-display {
            background: linear-gradient(135deg, var(--accent), #16a34a);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin-bottom: 12px;
        }

        .current-gymnast-display .gymnast-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .current-gymnast-display .gymnast-details {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.online { 
            background: var(--success); 
        }
        
        .status-dot.offline { 
            background: var(--text-muted); 
        }

        /* Modal Overlay Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-light);
            margin-bottom: 12px;
        }

        .modal textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-light);
            font-family: inherit;
            resize: vertical;
        }

        @media (max-width: 768px) {
            .main-grid { 
                grid-template-columns: 1fr; 
            }
            .btn-grid { 
                grid-template-columns: 1fr; 
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé• Stream Control</h1>
        <div class="subtitle">Manaus 2025 ‚Ä¢ Painel de Controle TV</div>
    </div>

    <div class="container">
        <div class="main-grid">
            <div class="left-panel">
                <!-- Configuration Section -->
                <div class="card">
                    <div class="card-title">üèÜ Configura√ß√£o da Prova</div>
                    <div class="form-group">
                        <label for="phase-select">Fase</label>
                        <select id="phase-select" class="form-select">
                            <option value="">Selecione a Fase</option>
                            <option value="qualifiers">Qualificat√≥rias</option>
                            <option value="aa_final">Final Individual Geral</option>
                            <option value="team_final">Final por Equipes</option>
                            <option value="vt_final">Final Salto</option>
                            <option value="ub_final">Final Barras Assim√©tricas</option>
                            <option value="bb_final">Final Trave</option>
                            <option value="fx_final">Final Solo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rotation-select">Rota√ß√£o</label>
                        <select id="rotation-select" class="form-select">
                            <option value="">Selecione a Rota√ß√£o</option>
                            <option value="1">Rota√ß√£o 1</option>
                            <option value="2">Rota√ß√£o 2</option>
                            <option value="3">Rota√ß√£o 3</option>
                            <option value="4">Rota√ß√£o 4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="apparatus-select">Aparelho</label>
                        <select id="apparatus-select" class="form-select">
                            <option value="">Selecione o Aparelho</option>
                            <option value="vt">Salto (VT)</option>
                            <option value="ub">Barras Assim√©tricas (UB)</option>
                            <option value="bb">Trave (BB)</option>
                            <option value="fx">Solo (FX)</option>
                        </select>
                    </div>
                    <button class="btn primary" id="apply-configuration" style="width: 100%; margin-top: 12px;">‚úÖ Aplicar Configura√ß√£o</button>
                </div>

                <!-- Timer Control -->
                <div class="card">
                    <div class="card-title">‚è±Ô∏è Timer & Performance</div>
                    <div class="timer-display">
                        <div class="timer-time" id="timer-display">0:00</div>
                        <div class="timer-status wait" id="timer-status">AGUARDANDO</div>
                    </div>
                    <div class="btn-grid">
                        <button class="btn primary" id="btn-start">‚ñ∂Ô∏è Iniciar</button>
                        <button class="btn warning" id="btn-stop">‚è∏Ô∏è Parar</button>
                        <button class="btn" id="btn-reset">üîÑ Reset</button>
                    </div>
                    <div class="btn-grid" style="margin-top: 8px;">
                        <button class="btn" id="btn-score">üìä Mostrar Nota</button>
                        <button class="btn" id="btn-show-score-lower">üèÜ Nota no Rodap√©</button>
                        <button class="btn accent" id="btn-inquiry">‚öñÔ∏è Recurso</button>
                    </div>
                </div>

                <!-- Navigation Control -->
                <div class="card">
                    <div class="card-title">üß≠ Navega√ß√£o de Ginastas</div>
                    <div class="current-gymnast-display" id="current-gymnast-info">
                        <div class="gymnast-name">--</div>
                        <div class="gymnast-details">Selecione uma configura√ß√£o</div>
                    </div>
                    <div class="btn-grid">
                        <button class="btn" id="btn-prev">‚¨ÖÔ∏è Anterior</button>
                        <button class="btn" id="btn-next">‚û°Ô∏è Pr√≥ximo</button>
                    </div>
                    <div style="margin-top: 12px;">
                        <button class="btn accent" id="btn-sync" style="width: 100%;">üîÑ Sincronizar Display</button>
                    </div>
                </div>

                <!-- Broadcast Control -->
                <div class="card">
                    <div class="card-title">üé¨ Controle de Transmiss√£o</div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="logo-toggle" checked>
                        <label>Exibir logo na transmiss√£o</label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="auto-sync" checked>
                        <label>Sincroniza√ß√£o autom√°tica</label>
                    </div>
                    <div class="btn-grid">
                        <button class="btn" id="btn-standby">üõë Standby</button>
                        <button class="btn active" id="btn-live">üî¥ AO VIVO</button>
                    </div>
                </div>

                <!-- Overlay Control -->
                <div class="card">
                    <div class="card-title">üéõÔ∏è Overlays na Tela</div>
                    <div class="btn-grid">
                        <button class="btn" id="btn-timer-overlay">‚è±Ô∏è Timer</button>
                        <button class="btn" id="btn-score-overlay">üìä Notas</button>
                        <button class="btn" id="btn-startlist">üìã Lista</button>
                    </div>
                    <div class="btn-grid" style="margin-top: 8px;">
                        <button class="btn" id="btn-results">üèÖ Resultados</button>
                        <button class="btn danger" id="btn-clear">üßπ Limpar</button>
                    </div>
                </div>

                <!-- Special Controls -->
                <div class="card">
                    <div class="card-title">‚ö° Controles Especiais</div>
                    <div class="btn-grid">
                        <button class="btn warning" id="btn-warmup">üî• Aquecimento</button>
                        <button class="btn info" id="btn-inquiry">‚öñÔ∏è Recurso</button>
                    </div>
                    <div class="btn-grid" style="margin-top: 8px;">
                        <button class="btn" id="btn-warmup-stop">‚èπÔ∏è Parar Aquecimento</button>
                        <button class="btn" id="btn-sounds">üîä Efeitos Sonoros</button>
                    </div>
                </div>

                <!-- TV Broadcast Controls -->
                <div class="card">
                    <div class="card-title">üì∫ Controles de Broadcast TV</div>
                    <div class="btn-grid">
                        <button class="btn primary" id="btn-show-lower-third">üë§ Mostrar Rodap√©</button>
                        <button class="btn" id="btn-hide-lower-third">‚ùå Ocultar Rodap√©</button>
                    </div>
                    <div class="btn-grid" style="margin-top: 8px;">
                        <button class="btn accent" id="btn-play-fx-music">üéµ M√∫sica Solo</button>
                        <button class="btn" id="btn-stop-fx-music">‚èπÔ∏è Parar M√∫sica</button>
                    </div>
                    <div class="btn-grid" style="margin-top: 8px;">
                        <button class="btn warning" id="btn-broadcast-warmup">üî• Aquecimento (1min)</button>
                        <button class="btn" id="btn-broadcast-warmup-4min">üî• Aquecimento (4min)</button>
                    </div>
                    <div class="btn-grid" style="margin-top: 8px;">
                        <button class="btn primary" id="btn-show-startlist-cascade">üìã Startlist Cascata</button>
                        <button class="btn accent" id="btn-show-results-cascade">üèÜ Resultados Cascata</button>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <!-- Current Gymnast -->
                <div class="card current-gymnast">
                    <div class="card-title">üë§ Ginasta Atual</div>
                    <div id="current-gymnast-info">
                        <div class="gymnast-name">Carregando...</div>
                        <div class="gymnast-details">Aguarde...</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-title">‚ö° A√ß√µes R√°pidas</div>
                    <button class="btn primary" id="btn-show-list">üìã Lista de Largada</button>
                    <button class="btn accent" id="btn-rankings">üèÜ Classifica√ß√£o</button>
                    <button class="btn danger" id="btn-emergency">üö® Emerg√™ncia</button>
                </div>

                <!-- System Status -->
                <div class="card">
                    <div class="card-title">üì° Status</div>
                    <div class="status-indicator">
                        <span class="status-dot online"></span>Stream: Conectado
                    </div>
                    <div class="status-indicator">
                        <span class="status-dot online"></span>Firebase: Online
                    </div>
                    <div class="status-indicator">
                        <span class="status-dot online"></span>Broadcast: Ativo
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inquiry Modal -->
    <div id="inquiry-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">‚öñÔ∏è Recurso de Nota</h3>
                <button class="modal-close" onclick="closeModal('inquiry')">&times;</button>
            </div>
            <select id="inquiry-gymnast" class="form-control">
                <option value="">Selecione a ginasta</option>
            </select>
            <textarea id="inquiry-reason" placeholder="Motivo do recurso..."></textarea>
            <div class="btn-grid">
                <button class="btn" onclick="closeModal('inquiry')">Cancelar</button>
                <button class="btn warning" id="btn-submit-inquiry">Submeter</button>
            </div>
        </div>
    </div>

    <!-- Warmup Modal -->
    <div id="warmup-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üî• Aquecimento</h3>
                <button class="modal-close" onclick="closeModal('warmup')">&times;</button>
            </div>
            <div class="timer-display">
                <div class="timer-time" id="warmup-display">0:00</div>
                <div class="timer-status wait" id="warmup-status">PRONTO</div>
            </div>
            <div class="btn-grid">
                <button class="btn" onclick="setWarmup(60)">1 min</button>
                <button class="btn" onclick="setWarmup(240)">4 min</button>
            </div>
            <div class="btn-grid" style="margin-top: 8px;">
                <button class="btn primary" id="btn-warmup-start">‚ñ∂Ô∏è Iniciar</button>
                <button class="btn warning" id="btn-warmup-pause">‚è∏Ô∏è Pausar</button>
                <button class="btn danger" id="btn-warmup-stop">‚èπÔ∏è Parar</button>
            </div>
        </div>
    </div>

    <!-- Sound Effects Modal -->
    <div id="sounds-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üîä Efeitos Sonoros</h3>
                <button class="modal-close" onclick="closeModal('sounds')">&times;</button>
            </div>
            <button class="btn" onclick="playSound('beep')">üì¢ Beep</button>
            <button class="btn" onclick="playSound('welcome')">üëã Boas-vindas</button>
            <button class="btn" onclick="playSound('instructions')">üìã Instru√ß√µes</button>
            <button class="btn" onclick="playSound('warmup-start')">üî• In√≠cio Aquecimento</button>
            <button class="btn" onclick="playSound('warmup-end')">‚è∞ Fim Aquecimento</button>
            <button class="btn danger" onclick="stopSounds()">‚èπÔ∏è Parar Todos</button>
        </div>
    </div>

    <script src="js/countries.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="js/firebase-init.js"></script>
    <script src="js/auth-guard.js"></script>
    <script src="js/calculation-logic.js"></script>
    <!-- start-list.js removed - uses ES6 imports, not compatible with current setup -->
    
    <script>
    // Use Firebase v8 syntax - variables are available globally from firebase-init.js
    // Don't assign db immediately - wait for firebase-init.js to finish
    let db = null;

    // State Management (from control.html)
    let allGymnastData = [];
    let fxStartList = [];
    let currentIndex = 0;
    let allStartListStructures = {};
    let currentFullSelection = null;
    let currentSelectedApparatus = null;
    let currentActiveVaultNum = 1;
    let currentGymnastList = [];
    
    // Timer State
    let timerState = {
        running: false,
        elapsed: 0,
        status: 'wait',
        interval: null
    };
    
    // Warmup Timer
    let warmupState = {
        running: false,
        elapsed: 0,
        total: 0,
        interval: null
    };

    // Broadcast Channels
    const controlChannel = new BroadcastChannel('fx-control');
    const soundChannel = new BroadcastChannel('sound-effects');
    console.log('[Control] ‚úÖ BroadcastChannels initialized: fx-control, sound-effects');

    // Broadcast Management
    let broadcastDocRef = null;
    let broadcastAutoSync = true;
    let activeBroadcastScene = 'SCENE_STANDBY';

    // Configuration Variables
    let currentSelectedPhase = '';
    let currentSelectedRotation = '';

    const BROADCAST_SCENES = {
        STANDBY: 'SCENE_STANDBY',
        LIVE: 'SCENE_LIVE_PERFORMANCE'
    };

    const DEFAULT_OVERLAY_STATE = {
        timer: { visible: false, status: 'WAIT', elapsedSeconds: 0, formatted: '00:00' },
        scorecard: { visible: false, gymnastId: null, gymnastName: '-', gymnastLastName: '-' },
        music: { visible: false, status: 'WAIT', label: '', timestamp: Date.now() },
        startlistMain: { visible: false, title: 'Lista', items: [] },
        results: { visible: false, title: 'Resultados', items: [] },
        warmup: { visible: false, status: 'STOPPED', timeRemaining: 0, totalTime: 0, startTimestamp: null },
        inquiry: { visible: false, status: 'PENDING', gymnastName: '', reason: '' }
    };

    let broadcastContext = {
        gymnastId: null,
        countryCode: null,
        lowerThirdVisible: true,
        payload: { gymnastName: '-', gymnastLastName: '-', countryFlagEmoji: 'üè≥Ô∏è', apparatus: 'FX' },
        overlays: JSON.parse(JSON.stringify(DEFAULT_OVERLAY_STATE))
    };

    // Utility Functions
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function splitNameParts(fullName = '') {
        const normalized = fullName.trim();
        if (!normalized) return { first: '-', last: '-' };
        
        const parts = normalized.split(' ');
        if (parts.length === 1) {
            return { first: parts[0], last: parts[0].toUpperCase() };
        }
        
        const last = parts.pop();
        const first = parts.join(' ');
        return { first, last: last.toUpperCase() };
    }

    function resolveCountryMetadata(rawCountry) {
        const dataset = window.countryData || {};
        if (!rawCountry) return { code: null, flag: 'üè≥Ô∏è' };
        
        const normalized = String(rawCountry).trim().toUpperCase();
        let info = dataset[normalized] || null;
        
        if (!info) {
            for (const [key, value] of Object.entries(dataset)) {
                if (value && value.code && value.code.toUpperCase() === normalized) {
                    info = value;
                    break;
                }
            }
        }
        
        return info ? { code: info.code?.toUpperCase(), flag: info.flag || 'üè≥Ô∏è' } : { code: null, flag: 'üè≥Ô∏è' };
    }

    // Data Processing Functions (from control.html)
    function parseDropdownValue(value) {
        const parts = value.split('|');
        const phase = parts[0];
        let subdiv = null, rot = null, app = null;
        
        if (phase.endsWith('_final') && !phase.startsWith('aa') && !phase.startsWith('team') && parts.length === 1) {
            // Apparatus final (e.g., "vt_final")
            app = phase.split('_')[0];
        } else if (parts.length === 3 && phase === 'qualifiers') {
            // Qualifiers with direct rotations (new format): "qualifiers|rot0|vt"
            rot = parts[1];
            app = parts[2];
        } else if (parts.length === 4 && phase === 'qualifiers') {
            // Qualifiers with subdivisions (old format): "qualifiers|subdiv0|rot0|vt"
            subdiv = parts[1];
            rot = parts[2];
            app = parts[3];
        } else if (parts.length === 3 && (phase === 'team_final' || phase === 'aa_final')) {
            // Team/AA final: "team_final|rot0|vt"
            rot = parts[1];
            app = parts[2];
        } else if (phase === 'qualifiers_all_vt') {
            // Special case for all VT
            app = 'vt';
        } else {
            console.warn(`[Control] Formato n√£o reconhecido: ${value}`);
        }
        
        const subdivIdx = subdiv ? parseInt(subdiv.replace('subdiv','')) : null;
        const rotIdx = rot ? parseInt(rot.replace('rot','')) : null;
        currentSelectedApparatus = app;
        return { phase, apparatus: app, subdivIdx, rotIdx };
    }

    function loadGymnastList(key) {
        console.log(`[Control] Loading gymnast list for: ${key}`);
        
        // Parse the key to get phase info
        const parsed = parseDropdownValue(key);
        const basePhase = parsed.phase.split('|')[0];
        
        console.log(`[Control] BasePhase: ${basePhase}, Apparatus: ${parsed.apparatus}`);
        console.log(`[Control] Available structures:`, Object.keys(allStartListStructures));
        
        const currentStructure = allStartListStructures[basePhase];
        console.log(`[Control] Current structure:`, currentStructure);
        
        let list = [];
        
        if (!currentStructure) {
            // Fallback logic for missing structure
            console.log(`[Control] No structure for ${basePhase}, using fallback logic`);
            if (basePhase.endsWith('_final') && parsed.apparatus) {
                // Apparatus finals fallback - top 8, max 2 per country
                const qualifiersGymnasts = allGymnastData.filter(gymnast => {
                    const qualifiersScores = gymnast.scores?.qualifiers;
                    if (!qualifiersScores) return false;
                    if (parsed.apparatus === 'vt') {
                        return qualifiersScores.qualifiers_vt1_d !== undefined || qualifiersScores.qualifiers_vt_d !== undefined;
                    } else {
                        return qualifiersScores[`qualifiers_${parsed.apparatus}_d`] !== undefined;
                    }
                }).map(gymnast => {
                    const qualifiersScores = gymnast.scores.qualifiers;
                    let score = 0;
                    if (parsed.apparatus === 'vt') {
                        if (qualifiersScores.qualifiers_vt1_d !== undefined) {
                            const vt1Total = Math.max(0, (qualifiersScores.qualifiers_vt1_d || 0) + (qualifiersScores.qualifiers_vt1_e || 0) - (qualifiersScores.qualifiers_vt1_p || 0));
                            const vt2Total = Math.max(0, (qualifiersScores.qualifiers_vt2_d || 0) + (qualifiersScores.qualifiers_vt2_e || 0) - (qualifiersScores.qualifiers_vt2_p || 0));
                            score = (vt1Total + vt2Total) / 2;
                        } else {
                            score = Math.max(0, (qualifiersScores.qualifiers_vt_d || 0) + (qualifiersScores.qualifiers_vt_e || 0) - (qualifiersScores.qualifiers_vt_p || 0));
                        }
                    } else {
                        score = Math.max(0, (qualifiersScores[`qualifiers_${parsed.apparatus}_d`] || 0) + (qualifiersScores[`qualifiers_${parsed.apparatus}_e`] || 0) - (qualifiersScores[`qualifiers_${parsed.apparatus}_p`] || 0));
                    }
                    return { ...gymnast, [`${parsed.apparatus}Score`]: score };
                });
                
                qualifiersGymnasts.sort((a, b) => b[`${parsed.apparatus}Score`] - a[`${parsed.apparatus}Score`]);
                
                // Max 2 per country, top 8
                list = [];
                const countryCount = {};
                for (const gymnast of qualifiersGymnasts) {
                    if (list.length >= 8) break;
                    if (!countryCount[gymnast.country]) countryCount[gymnast.country] = 0;
                    if (countryCount[gymnast.country] < 2) {
                        list.push(gymnast);
                        countryCount[gymnast.country]++;
                    }
                }
            } else if (basePhase === 'qualifiers') {
                // Qualifiers fallback
                if (parsed.apparatus === 'vt' && key === 'qualifiers_all_vt') {
                    list = allGymnastData.filter(g => {
                        const phaseScores = g.scores?.qualifiers || {};
                        return phaseScores['qualifiers_vt1_d'] !== undefined || phaseScores['qualifiers_vt2_d'] !== undefined;
                    });
                } else if (parsed.apparatus) {
                    list = allGymnastData.filter(g => {
                        const phaseScores = g.scores?.qualifiers || {};
                        if (parsed.apparatus === 'vt') {
                            return phaseScores['qualifiers_vt1_d'] !== undefined;
                        } else {
                            return phaseScores[`qualifiers_${parsed.apparatus}_d`] !== undefined;
                        }
                    });
                }
            } else {
                // Other phases: use all gymnasts
                list = allGymnastData;
            }
            
            currentGymnastList = list.filter(g => g && g.id);
            currentIndex = 0;
            updateCurrentGymnastDisplay();
            return;
        }

        // Structure exists - use it
        try {
            if (currentStructure.type === 'apparatus_final' && parsed.apparatus) {
                console.log(`[Control] Calculando ginastas para final de ${parsed.apparatus}...`);
                
                if (parsed.apparatus === 'vt') {
                    // VT Final - calcular com m√©dia dos dois saltos
                    const qualifiersGymnasts = allGymnastData.filter(gymnast => {
                        const qualifiersScores = gymnast.scores?.qualifiers;
                        return qualifiersScores && (
                            qualifiersScores.qualifiers_vt1_d !== undefined || 
                            qualifiersScores.qualifiers_vt_d !== undefined
                        );
                    }).map(gymnast => {
                        const qualifiersScores = gymnast.scores.qualifiers;
                        let vtScore = 0;
                        
                        if (qualifiersScores.qualifiers_vt1_d !== undefined) {
                            const vt1Total = Math.max(0, (qualifiersScores.qualifiers_vt1_d || 0) + (qualifiersScores.qualifiers_vt1_e || 0) - (qualifiersScores.qualifiers_vt1_p || 0));
                            const vt2Total = Math.max(0, (qualifiersScores.qualifiers_vt2_d || 0) + (qualifiersScores.qualifiers_vt2_e || 0) - (qualifiersScores.qualifiers_vt2_p || 0));
                            vtScore = (vt1Total + vt2Total) / 2;
                        } else {
                            vtScore = Math.max(0, (qualifiersScores.qualifiers_vt_d || 0) + (qualifiersScores.qualifiers_vt_e || 0) - (qualifiersScores.qualifiers_vt_p || 0));
                        }
                        
                        return { ...gymnast, vtAverage: vtScore };
                    });

                    qualifiersGymnasts.sort((a, b) => b.vtAverage - a.vtAverage);

                    // Aplicar regra de m√°ximo 2 por pa√≠s
                    list = [];
                    const countryCount = {};

                    for (const gymnast of qualifiersGymnasts) {
                        if (list.length >= 8) break;
                        
                        if (!countryCount[gymnast.country]) {
                            countryCount[gymnast.country] = 0;
                        }
                        
                        if (countryCount[gymnast.country] < 2) {
                            list.push(gymnast);
                            countryCount[gymnast.country]++;
                        }
                    }
                } else {
                    // Outras finais (UB, BB, FX)
                    const qualifiersGymnasts = allGymnastData.filter(gymnast => {
                        const qualifiersScores = gymnast.scores?.qualifiers;
                        return qualifiersScores && (
                            qualifiersScores[`qualifiers_${parsed.apparatus}_d`] !== undefined
                        );
                    }).map(gymnast => {
                        const qualifiersScores = gymnast.scores.qualifiers;
                        const apparatusScore = Math.max(0, (qualifiersScores[`qualifiers_${parsed.apparatus}_d`] || 0) + (qualifiersScores[`qualifiers_${parsed.apparatus}_e`] || 0) - (qualifiersScores[`qualifiers_${parsed.apparatus}_p`] || 0));
                        return { ...gymnast, [`${parsed.apparatus}Score`]: apparatusScore };
                    });

                    qualifiersGymnasts.sort((a, b) => b[`${parsed.apparatus}Score`] - a[`${parsed.apparatus}Score`]);

                    // Aplicar regra de m√°ximo 2 por pa√≠s
                    list = [];
                    const countryCount = {};

                    for (const gymnast of qualifiersGymnasts) {
                        if (list.length >= 8) break;
                        
                        if (!countryCount[gymnast.country]) {
                            countryCount[gymnast.country] = 0;
                        }
                        
                        if (countryCount[gymnast.country] < 2) {
                            list.push(gymnast);
                            countryCount[gymnast.country]++;
                        }
                    }
                }
                
                console.log(`[Control] ${list.length} ginastas qualificadas para final de ${parsed.apparatus}`);
            } else if (parsed.apparatus === 'vt' && key === 'qualifiers_all_vt') {
                list = [];
                if (allStartListStructures['qualifiers']) {
                    const structure = allStartListStructures['qualifiers'];
                    const rotationsToProcess = structure.subdivisions ? 
                        structure.subdivisions[0]?.rotations || [] : 
                        structure.rotations || [];
                        
                    rotationsToProcess.forEach(rot => {
                        if (rot.apparatus?.vt) {
                            rot.apparatus.vt.forEach(savedAthlete => {
                                const freshData = allGymnastData.find(g => g.id === savedAthlete.id);
                                if (freshData) {
                                    list.push(freshData);
                                }
                            });
                        }
                    });
                    list = list.filter((g, index, self) => index === self.findIndex(t => t.id === g.id)); // Deduplicate
                }
                console.log("[Control] Loaded qualifiers VT all list");
            } else if (currentStructure.type === 'qualifiers' && parsed.rotIdx !== null && parsed.apparatus) {
                const rotationsToProcess = currentStructure.subdivisions ? 
                    currentStructure.subdivisions[0]?.rotations || [] : 
                    currentStructure.rotations || [];
                    
                const savedAthletes = rotationsToProcess[parsed.rotIdx]?.apparatus?.[parsed.apparatus] || [];
                list = savedAthletes.map(savedAthlete => {
                    const freshData = allGymnastData.find(g => g.id === savedAthlete.id);
                    return freshData || savedAthlete;
                });
                console.log("[Control] Loaded qualifiers specific rotation list");
            } else if ((currentStructure.type === 'team_final' || currentStructure.type === 'aa_final') && parsed.rotIdx !== null && parsed.apparatus) {
                const apparatusKey = parsed.apparatus.toUpperCase();
                const savedAthletes = currentStructure.rotations?.[parsed.rotIdx]?.apparatus?.[apparatusKey] || [];
                
                list = savedAthletes.map(savedAthlete => {
                    const freshData = allGymnastData.find(g => g.id === savedAthlete.id);
                    return freshData || savedAthlete;
                });
                console.log("[Control] Loaded team/aa final list");
            }
            
            currentGymnastList = list.filter(g => g && g.id);
            console.log("[Control] Final list:", currentGymnastList.map(g => `${g.id}: ${g.name}`));
        } catch (e) {
            console.error(`Error accessing structure data for ${key}:`, e);
            currentGymnastList = [];
        }
        
        currentIndex = 0;
        updateCurrentGymnastDisplay();
    }

    // Configuration Functions
    function applyConfiguration() {
        const phaseSelect = document.getElementById('phase-select');
        const rotationSelect = document.getElementById('rotation-select');
        const apparatusSelect = document.getElementById('apparatus-select');
        
        const phase = phaseSelect?.value;
        const rotation = rotationSelect?.value;
        const apparatus = apparatusSelect?.value;
        
        // Check if all required fields are filled
        const needsRotation = phase === 'qualifiers' || phase === 'aa_final' || (phase && phase.includes('_final') && apparatus === 'vt');
        
        if (!phase || (!needsRotation && !apparatus) || (needsRotation && (!rotation || !apparatus))) {
            if (needsRotation) {
                alert('Por favor, selecione Fase, Rota√ß√£o e Aparelho antes de aplicar a configura√ß√£o.');
            } else {
                alert('Por favor, selecione Fase e Aparelho antes de aplicar a configura√ß√£o.');
            }
            return;
        }

        // Save current selection
        currentSelectedPhase = phase;
        currentSelectedApparatus = apparatus;
        currentSelectedRotation = rotation;

        // Construct the gymnast list key
        let gymnastListKey = '';
        
        if (phase === 'qualifiers' && rotation && apparatus) {
            gymnastListKey = `${phase}|rot${parseInt(rotation)-1}|${apparatus}`;
        } else if (phase.includes('_final')) {
            if (apparatus) {
                gymnastListKey = `${phase}`;
            } else {
                gymnastListKey = `${phase}|rot${parseInt(rotation)-1}|${apparatus || ''}`;
            }
        }

        // Load gymnast list from Firebase
        loadGymnastList(gymnastListKey);
        
        // Update UI to reflect the configuration
        updateConfigurationStatus();
        
        // Persist configuration to Firestore (broadcast/liveState)
        updateBroadcastConfiguration(phase, apparatus, rotation);
        
        // Notify other components
        controlChannel.postMessage({
            action: 'configurationApplied',
            phase: phase,
            rotation: rotation,
            apparatus: apparatus,
            timestamp: Date.now()
        });

        console.log(`[Control] Configuration applied: Phase=${phase}, Rotation=${rotation}, Apparatus=${apparatus}`);
    }

    function loadGymnastList(key) {
        console.log(`[Control] Loading gymnast list for: ${key}`);
        
        // Clear current list
        currentGymnastList = [];
        currentIndex = 0;
        
        // Load real data from Firebase
        if (window.db && key && allStartListStructures) {
            console.log(`[Control] Loading gymnast list for: ${key}`);
            
            const parsed = parseDropdownValue(key);
            console.log(`[Control] Parsed:`, parsed);
            
            const basePhase = parsed.phase.split('|')[0];
            console.log(`[Control] BasePhase: ${basePhase}`);
            console.log(`[Control] Available structures:`, Object.keys(allStartListStructures));
            
            const currentStructure = allStartListStructures[basePhase];
            console.log(`[Control] Current structure:`, currentStructure);
            
            if (currentStructure) {
                console.log(`[Control] Structure type: ${currentStructure.type}`);
                if (currentStructure.type === 'rotational') {
                    console.log(`[Control] Rotations available:`, currentStructure.rotations ? currentStructure.rotations.length : 0);
                    if (parsed.rotIdx !== null && currentStructure.rotations && currentStructure.rotations[parsed.rotIdx]) {
                        console.log(`[Control] Rotation ${parsed.rotIdx} gymnasts:`, currentStructure.rotations[parsed.rotIdx].gymnasts);
                    }
                }
                
                const list = getGymnastListFromStructure(currentStructure, parsed);
                currentGymnastList = list || [];
                console.log(`[Control] Loaded ${currentGymnastList.length} gymnasts`);
            } else {
                console.warn(`[Control] No structure found for ${basePhase}`);
                currentGymnastList = [];
            }
        }
        
        // Update current gymnast display
        updateCurrentGymnastDisplay();
    }

    function updateConfigurationStatus() {
        console.log(`[Control] Configuration status updated`);
        // Update any status indicators if needed
    }

    function updateCurrentGymnastDisplay() {
        const gymnastInfo = document.getElementById('current-gymnast-info');
        if (!gymnastInfo) return;
        
        if (!currentGymnastList || currentGymnastList.length === 0) {
            gymnastInfo.innerHTML = `
                <div class="gymnast-name">--</div>
                <div class="gymnast-details">Lista vazia</div>
            `;
            return;
        }
        
        if (currentIndex < 0 || currentIndex >= currentGymnastList.length) {
            currentIndex = 0;
        }
        
        const gymnast = currentGymnastList[currentIndex];
        if (!gymnast) {
            gymnastInfo.innerHTML = `
                <div class="gymnast-name">--</div>
                <div class="gymnast-details">Dados inv√°lidos</div>
            `;
            return;
        }
        
        const countryInfo = window.countryData && window.countryData[gymnast.country] || {};
        const countryName = countryInfo.name || gymnast.country;
        
        gymnastInfo.innerHTML = `
            <div class="gymnast-name">${gymnast.name}</div>
            <div class="gymnast-details">${countryName} ‚Ä¢ ${currentIndex + 1}/${currentGymnastList.length}</div>
        `;
        
        // Notify stream display about current gymnast
        syncBroadcastWithCurrentGymnast();
    }

    function goToPreviousGymnast() {
        if (!currentGymnastList || currentGymnastList.length === 0) return;
        
        currentIndex--;
        if (currentIndex < 0) {
            currentIndex = currentGymnastList.length - 1;
        }
        
        updateCurrentGymnastDisplay();
    }

    function goToNextGymnast() {
        if (!currentGymnastList || currentGymnastList.length === 0) return;
        
        currentIndex++;
        if (currentIndex >= currentGymnastList.length) {
            currentIndex = 0;
        }
        
        updateCurrentGymnastDisplay();
    }

    // Firebase Data Loading Functions (from control.html)
    async function populatePhaseSelectAndOptions() {
        // This function is now simplified - the dropdowns are pre-populated in HTML
        allStartListStructures = {};
        
        try {
            const querySnapshot = await window.db.collection("start_lists").get();
            if (querySnapshot.empty) {
                console.warn("Nenhum start list encontrado no Firebase");
                return;
            }

            querySnapshot.forEach((docSnap) => {
                const phaseKey = docSnap.id;
                const structure = docSnap.data().structure;
                allStartListStructures[phaseKey] = structure;
            });
            
            console.log('[Control] Start lists carregados:', Object.keys(allStartListStructures));
            
        } catch (error) {
            console.error('Erro ao carregar start lists:', error);
        }
    }

    function syncDisplays() {
        // Force sync with stream display
        pushBroadcastState(activeBroadcastScene);
        syncBroadcastWithCurrentGymnast({ force: true });
        
        // Show confirmation
        console.log('[Control] Displays synchronized');
    }

    function syncBroadcastWithCurrentGymnast(options = {}) {
        if (!currentGymnastList || currentGymnastList.length === 0 || currentIndex < 0 || currentIndex >= currentGymnastList.length) {
            controlChannel.postMessage({
                action: 'syncCurrentGymnast',
                gymnast: null,
                phase: currentSelectedPhase,
                apparatus: currentSelectedApparatus,
                rotation: currentSelectedRotation,
                timestamp: Date.now(),
                force: options.force || false
            });
            return;
        }
        
        const gymnast = currentGymnastList[currentIndex];
        controlChannel.postMessage({
            action: 'syncCurrentGymnast',
            gymnast: gymnast,
            phase: currentSelectedPhase,
            apparatus: currentSelectedApparatus,
            rotation: currentSelectedRotation,
            index: currentIndex,
            total: currentGymnastList.length,
            timestamp: Date.now(),
            force: options.force || false
        });
    }

    function getCountryInfo(countryCode) {
        if (!countryCode || typeof countryCode !== 'string') {
            return { code: null, emoji: 'üè≥Ô∏è' };
        }
        const normalized = countryCode.trim().toUpperCase();
        const data = window.countryData ? window.countryData[normalized] : null;
        const code = data?.code ? data.code.toLowerCase() : normalized.toLowerCase();
        const emoji = data?.emoji || data?.flag || 'üè≥Ô∏è';
        return { code, emoji };
    }

    function parseDropdownValue(value) {
        const parts = value.split('|');
        const phase = parts[0];
        let subdiv = null, rot = null, app = null;
        
        if (phase.endsWith('_final') && !phase.startsWith('aa') && !phase.startsWith('team') && parts.length === 1) {
            // Apparatus final (e.g., "vt_final")
            app = phase.split('_')[0];
        } else if (parts.length === 3 && phase === 'qualifiers') {
            // Qualifiers with direct rotations (new format): "qualifiers|rot0|vt"
            rot = parts[1];
            app = parts[2];
        } else if (parts.length === 4 && phase === 'qualifiers') {
            // Qualifiers with subdivisions (old format): "qualifiers|subdiv0|rot0|vt"
            subdiv = parts[1];
            rot = parts[2];
            app = parts[3];
        } else if (parts.length === 3 && (phase === 'team_final' || phase === 'aa_final')) {
            // Team/AA final: "team_final|rot0|vt"
            rot = parts[1];
            app = parts[2];
        } else if (phase === 'qualifiers_all_vt') {
            // Special case for all VT
            app = 'vt';
        } else {
            console.warn(`[Control] Formato n√£o reconhecido: ${value}`);
        }
        
        const subdivIdx = subdiv ? parseInt(subdiv.replace('subdiv','')) : null;
        const rotIdx = rot ? parseInt(rot.replace('rot','')) : null;
        currentSelectedApparatus = app;
        return { phase, apparatus: app, subdivIdx, rotIdx };
    }

    function getGymnastListFromStructure(structure, parsed) {
        console.log(`[Control] getGymnastListFromStructure called with:`, {structure: structure?.type, parsed});
        
        if (!structure || !allGymnastData) {
            console.log(`[Control] Missing structure or gymnast data:`, {
                hasStructure: !!structure, 
                allGymnastDataCount: allGymnastData?.length || 0
            });
            return [];
        }
        
        let list = [];
        
        // Handle qualifiers structure
        if (structure.type === 'qualifiers' && parsed.rotIdx !== null && parsed.apparatus) {
            console.log(`[Control] Processing qualifiers structure, rotIdx: ${parsed.rotIdx}, apparatus: ${parsed.apparatus}`);
            
            // Check if using subdivisions (old format) or direct rotations (new format)
            const rotationsToProcess = structure.subdivisions ? 
                structure.subdivisions[0]?.rotations || [] : 
                structure.rotations || [];
            
            console.log(`[Control] Rotations available: ${rotationsToProcess.length}`);
            
            const savedAthletes = rotationsToProcess[parsed.rotIdx]?.apparatus?.[parsed.apparatus] || [];
            console.log(`[Control] Found ${savedAthletes.length} athletes for rotation ${parsed.rotIdx}, apparatus ${parsed.apparatus}`);
            
            list = savedAthletes.map(savedAthlete => {
                const freshData = allGymnastData.find(g => g.id === savedAthlete.id);
                return freshData || savedAthlete; // Use fresh data if available, fallback to saved
            });
            
            console.log("[Control] Loaded qualifiers list:", list.map(g => `${g.id}: ${g.name}`));
        }
        // Handle team_final or aa_final structure
        else if ((structure.type === 'team_final' || structure.type === 'aa_final') && parsed.rotIdx !== null && parsed.apparatus) {
            console.log(`[Control] Processing ${structure.type} structure, rotIdx: ${parsed.rotIdx}, apparatus: ${parsed.apparatus}`);
            
            // Convert apparatus to uppercase to match Firebase structure
            const apparatusKey = parsed.apparatus.toUpperCase();
            const savedAthletes = structure.rotations?.[parsed.rotIdx]?.apparatus?.[apparatusKey] || [];
            
            console.log(`[Control] Found ${savedAthletes.length} athletes for ${apparatusKey} in rotation ${parsed.rotIdx}`);
            
            list = savedAthletes.map(savedAthlete => {
                const freshData = allGymnastData.find(g => g.id === savedAthlete.id);
                return freshData || savedAthlete;
            });
            
            console.log(`[Control] Loaded ${structure.type} list:`, list.map(g => `${g.id}: ${g.name}`));
        }
        // Handle apparatus finals (vt_final, ub_final, bb_final, fx_final)
        else if (structure.type === 'apparatus_final' && structure.athletes) {
            console.log(`[Control] Processing apparatus final structure`);
            
            list = structure.athletes.map(savedAthlete => {
                const freshData = allGymnastData.find(g => g.id === savedAthlete.id);
                return freshData || savedAthlete;
            });
            
            console.log(`[Control] Loaded apparatus final list:`, list.map(g => `${g.id}: ${g.name}`));
        }
        // Handle rotational structure (legacy)
        else if (structure.type === 'rotational' && structure.rotations && parsed.rotIdx !== null) {
            console.log(`[Control] Processing rotational structure, rotIdx: ${parsed.rotIdx}`);
            const rotation = structure.rotations[parsed.rotIdx];
            
            if (rotation && rotation.gymnasts) {
                list = rotation.gymnasts.map(id => {
                    const gymnast = allGymnastData.find(g => g.id === id);
                    return gymnast;
                }).filter(Boolean);
            }
            
            console.log(`[Control] Loaded rotational list:`, list.map(g => `${g.id}: ${g.name}`));
        }
        // Handle linear structure (legacy)
        else if (structure.type === 'linear' && structure.gymnasts) {
            console.log(`[Control] Processing linear structure`);
            list = structure.gymnasts.map(id => allGymnastData.find(g => g.id === id)).filter(Boolean);
            console.log(`[Control] Loaded linear list:`, list.map(g => `${g.id}: ${g.name}`));
        }
        
        // Filter out any null/undefined entries
        list = list.filter(g => g && g.id);
        
        console.log(`[Control] Final filtered list: ${list.length} gymnasts`);
        return list;
    }

    async function populatePhaseSelectAndOptions() {
        allStartListStructures = {};
        
        try {
            if (!window.db) {
                console.error('[Control] Firebase not initialized');
                return;
            }
            
            const querySnapshot = await window.db.collection("start_lists").get();
            if (querySnapshot.empty) {
                console.warn("[Control] Nenhum start list encontrado no Firebase");
                return;
            }

            querySnapshot.forEach((docSnap) => {
                const phaseKey = docSnap.id;
                const structure = docSnap.data().structure;
                allStartListStructures[phaseKey] = structure;
            });
            
            console.log('[Control] Start lists carregados:', Object.keys(allStartListStructures));
            
        } catch (error) {
            console.error('[Control] Erro ao carregar start lists:', error);
        }
    }

    // Timer Functions
    function startTimer() {
        if (timerState.running) return;
        
        timerState.running = true;
        timerState.status = 'go';
        
        // Show timer overlay when starting
        setOverlayState('timer', {
            visible: true,
            status: 'GO',
            elapsedSeconds: timerState.elapsed
        });
        
        timerState.interval = setInterval(() => {
            timerState.elapsed++;
            updateTimerDisplay();
            
            setOverlayState('timer', {
                elapsedSeconds: timerState.elapsed,
                formatted: formatTime(timerState.elapsed)
            });
            
            pushBroadcastState(activeBroadcastScene);
        }, 1000);
        
        // Auto-play FX music when starting timer for Floor Exercise
        if (currentSelectedApparatus === 'fx') {
            console.log('[Control] Timer started for FX - Auto-playing music');
            playFXMusic();
        }
        
        updateTimerDisplay();
        pushBroadcastState(activeBroadcastScene);
    }

    function stopTimer() {
        if (!timerState.running) return;
        
        clearInterval(timerState.interval);
        timerState.running = false;
        timerState.status = 'stop';
        
        updateTimerDisplay();
        pushBroadcastState(activeBroadcastScene);
    }

    function resetTimer() {
        clearInterval(timerState.interval);
        timerState.running = false;
        timerState.elapsed = 0;
        timerState.status = 'wait';
        
        setOverlayState('timer', {
            elapsedSeconds: 0,
            formatted: '00:00',
            status: 'WAIT'
        });
        
        updateTimerDisplay();
        pushBroadcastState(activeBroadcastScene);
    }

    function updateTimerDisplay() {
        const display = document.getElementById('timer-display');
        const status = document.getElementById('timer-status');
        
        if (display) display.textContent = formatTime(timerState.elapsed);
        if (status) {
            status.textContent = timerState.status.toUpperCase();
            status.className = `timer-status ${timerState.status}`;
        }
    }

    function showScore() {
        timerState.status = 'score';
        
        setOverlayState('scorecard', {
            visible: true,
            gymnastId: broadcastContext.gymnastId,
            gymnastName: broadcastContext.payload?.gymnastName || '-',
            gymnastLastName: broadcastContext.payload?.gymnastLastName || '-'
        });
        
        updateTimerDisplay();
        pushBroadcastState(activeBroadcastScene);
    }

    function toggleLowerThirdScore() {
        if (!currentGymnastList || currentGymnastList.length === 0 || currentIndex < 0 || currentIndex >= currentGymnastList.length) {
            alert('Nenhum ginasta selecionado ou lista vazia');
            return;
        }

        const gymnast = currentGymnastList[currentIndex];
        const countryInfo = getCountryInfo(gymnast.country);
        
        // For demo purposes, simulate scores
        const scores = {
            totalScore: currentSelectedApparatus === 'vt' ? null : (13.500 + Math.random() * 2).toFixed(3),
            vt1Score: currentSelectedApparatus === 'vt' ? (13.200 + Math.random() * 1.5).toFixed(3) : null,
            vt2Score: currentSelectedApparatus === 'vt' ? (13.800 + Math.random() * 1.2).toFixed(3) : null,
            scoreLabel: currentSelectedApparatus === 'vt' ? 'MELHOR' : 'TOTAL'
        };

        controlChannel.postMessage({
            action: 'updateLowerThird',
            data: {
                gymnastName: gymnast.name.split(' ')[0],
                gymnastLastName: gymnast.name.split(' ').slice(-1)[0],
                countryCode: countryInfo.code,
                countryFlagEmoji: countryInfo.emoji,
                apparatus: (currentSelectedApparatus || 'fx').toUpperCase(),
                showScore: true,
                ...scores
            },
            timestamp: Date.now()
        });

        console.log('[Control] Lower third score toggled for:', gymnast.name);
    }

    // Warmup Functions
    function startWarmup() {
        // Send warmup command to stream
        controlChannel.postMessage({
            action: 'startWarmup',
            duration: 60, // 1 minute default
            timestamp: Date.now()
        });

        // Play beep sound
        soundChannel.postMessage({
            type: 'PLAY_BEEP',
            timestamp: Date.now()
        });

        console.log('[Control] Warmup started');
    }

    function stopWarmup() {
        controlChannel.postMessage({
            action: 'stopWarmup',
            timestamp: Date.now()
        });

        console.log('[Control] Warmup stopped');
    }

    function testBeep() {
        soundChannel.postMessage({
            type: 'PLAY_BEEP',
            timestamp: Date.now()
        });

        console.log('[Control] Test beep played');
    }

    // Broadcast Functions
    function ensureBroadcastDocRef() {
        if (!db) {
            console.error('[Control] Firebase db not available');
            return null;
        }
        if (!broadcastDocRef) {
            broadcastDocRef = db.collection('broadcast').doc('liveState');
        }
        return broadcastDocRef;
    }

    function setOverlayState(key, patch = {}) {
        if (!broadcastContext.overlays[key]) {
            broadcastContext.overlays[key] = { ...DEFAULT_OVERLAY_STATE[key] };
        }
        Object.assign(broadcastContext.overlays[key], patch);
        return broadcastContext.overlays[key];
    }

    function toggleOverlayVisibility(key) {
        if (!broadcastContext.overlays[key]) {
            broadcastContext.overlays[key] = { ...DEFAULT_OVERLAY_STATE[key] };
        }
        broadcastContext.overlays[key].visible = !broadcastContext.overlays[key].visible;
        return broadcastContext.overlays[key].visible;
    }

    function clearAllOverlays() {
        broadcastContext.overlays = JSON.parse(JSON.stringify(DEFAULT_OVERLAY_STATE));
    }

    async function pushBroadcastState(scene) {
        try {
            const docRef = ensureBroadcastDocRef();
            if (!docRef) return;

            const logoToggle = document.getElementById('logo-toggle');
            const overlays = {
                logoBug: !!logoToggle?.checked,
                widgets: broadcastContext.overlays
            };

            await docRef.set({
                currentScene: scene,
                scenePayload: broadcastContext.payload,
                activeOverlays: overlays,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            updateBroadcastButtons(scene);
            activeBroadcastScene = scene;
        } catch (error) {
            console.error('Erro ao atualizar broadcast:', error);
        }
    }

    function updateBroadcastButtons(scene) {
        const standbyBtn = document.getElementById('btn-standby');
        const liveBtn = document.getElementById('btn-live');
        
        if (standbyBtn) standbyBtn.classList.toggle('active', scene === BROADCAST_SCENES.STANDBY);
        if (liveBtn) liveBtn.classList.toggle('active', scene === BROADCAST_SCENES.LIVE);
    }

    async function updateBroadcastConfiguration(phase, apparatus, rotation) {
        try {
            const docRef = ensureBroadcastDocRef();
            if (!docRef) {
                console.warn('[Control] Cannot update configuration - no broadcast doc ref');
                return;
            }

            // Update configuration in Firestore
            await docRef.set({
                configuration: {
                    currentPhase: phase,
                    currentApparatus: apparatus,
                    currentRotation: rotation || null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            }, { merge: true });

            console.log('[Control] Configuration persisted to Firestore:', { phase, apparatus, rotation });
        } catch (error) {
            console.error('[Control] Error updating configuration in Firestore:', error);
        }
    }

    // Modal Functions
    function showModal(modalId) {
        const modal = document.getElementById(modalId + '-modal');
        if (modal) {
            modal.style.display = 'flex';
            
            // Populate gymnast select when opening inquiry modal
            if (modalId === 'inquiry') {
                populateInquiryGymnasts();
            }
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId + '-modal');
        if (modal) modal.style.display = 'none';
    }

    function populateInquiryGymnasts() {
        const select = document.getElementById('inquiry-gymnast');
        if (!select) return;
        
        // Clear existing options except first
        select.innerHTML = '<option value="">Selecione a ginasta</option>';
        
        // Add current gymnast list
        if (currentGymnastList && currentGymnastList.length > 0) {
            currentGymnastList.forEach(gymnast => {
                const option = document.createElement('option');
                option.value = gymnast.id;
                option.textContent = gymnast.name;
                select.appendChild(option);
            });
        }
        // Fallback to all gymnasts if no list selected
        else if (allGymnastData && allGymnastData.length > 0) {
            allGymnastData.forEach(gymnast => {
                const option = document.createElement('option');
                option.value = gymnast.id;
                option.textContent = gymnast.name;
                select.appendChild(option);
            });
        }
    }

    // Sound Functions
    const soundEffectFiles = {
        'beep': '/audio/beep.mp3',
        'welcome': '/audio/welcome.mp3',
        'instructions': '/audio/final-instructions.mp3',
        'warmup-start': '/audio/warmup-start.mp3',
        'warmup-end': '/audio/warmup-end.mp3'
    };

    function playSound(effect) {
        const audioFile = soundEffectFiles[effect];
        if (!audioFile) {
            console.warn('[Control] Unknown sound effect:', effect);
            return;
        }
        
        // Send standardized message with file path
        soundChannel.postMessage({
            action: 'play',
            file: audioFile,
            volume: 0.8,
            type: 'effect',
            timestamp: Date.now()
        });
        
        console.log('[Control] Playing sound effect:', effect, '| File:', audioFile);
    }

    function stopSounds() {
        soundChannel.postMessage({
            action: 'stop',
            type: 'all',
            timestamp: Date.now()
        });
    }

    // Warmup Functions  
    function setWarmup(seconds) {
        warmupState.total = seconds;
        warmupState.elapsed = seconds;
        updateWarmupDisplay();
    }

    function updateWarmupDisplay() {
        const display = document.getElementById('warmup-display');
        const status = document.getElementById('warmup-status');
        
        if (display) display.textContent = formatTime(warmupState.elapsed);
        if (status) {
            if (warmupState.running) {
                status.textContent = 'EXECUTANDO';
                status.className = 'timer-status go';
            } else if (warmupState.elapsed > 0) {
                status.textContent = 'PAUSADO';
                status.className = 'timer-status stop';
            } else {
                status.textContent = 'PRONTO';
                status.className = 'timer-status wait';
            }
        }
    }

    // TV Broadcast Controls (from Gemini directives)
    function showLowerThird() {
        if (!currentGymnastList || currentGymnastList.length === 0 || currentIndex < 0 || currentIndex >= currentGymnastList.length) {
            alert('Nenhuma ginasta selecionada');
            return;
        }

        const gymnast = currentGymnastList[currentIndex];
        const countryInfo = getCountryInfo(gymnast.country);
        
        controlChannel.postMessage({
            action: 'show-lower-third',
            payload: {
                name: gymnast.name.split(' ')[0] || '',
                surname: gymnast.name.split(' ').slice(-1)[0] || '',
                countryCode: countryInfo.code,
                countryName: countryInfo.name || gymnast.country
            }
        });

        console.log('[Control] Lower third shown for:', gymnast.name);
    }

    function hideLowerThird() {
        controlChannel.postMessage({
            action: 'hide-lower-third'
        });
        console.log('[Control] Lower third hidden');
    }

    function playFXMusic() {
        if (!currentGymnastList || currentGymnastList.length === 0 || currentIndex < 0 || currentIndex >= currentGymnastList.length) {
            alert('Nenhuma ginasta selecionada');
            return;
        }

        const gymnast = currentGymnastList[currentIndex];
        const gymnastData = allGymnastData.find(g => g.id === gymnast.id);
        
        if (gymnastData && gymnastData.fxMusicUrl) {
            const message = {
                action: 'play',
                file: gymnastData.fxMusicUrl,
                volume: 1.0
            };
            soundChannel.postMessage(message);
            console.log('[Control] üì§ Sending sound-effects message:', message);
            console.log('[Control] Playing FX music for:', gymnast.name, '| URL:', gymnastData.fxMusicUrl);
        } else {
            alert('M√∫sica de solo n√£o encontrada para esta ginasta');
            console.warn('[Control] No fxMusicUrl for gymnast:', gymnast.id, '| gymnastData:', gymnastData);
        }
    }

    function stopFXMusic() {
        soundChannel.postMessage({
            action: 'stop'
        });
        console.log('[Control] FX music stopped');
    }

    function startBroadcastWarmup(duration = 60) {
        // Update Firestore with warmup state
        setOverlayState('warmup', {
            visible: true,
            status: 'RUNNING',
            timeRemaining: duration,
            totalTime: duration,
            startTimestamp: Date.now()
        });
        
        // Also send via BroadcastChannel for immediate response
        controlChannel.postMessage({
            action: 'warmup-start',
            time: duration,
            totalTime: duration,
            timestamp: Date.now()
        });
        
        pushBroadcastState(activeBroadcastScene);
        console.log('[Control] Warmup started:', duration, 'seconds (Firestore + BroadcastChannel)');
    }

    function stopBroadcastWarmup() {
        // Update Firestore to hide warmup
        setOverlayState('warmup', {
            visible: false,
            status: 'STOPPED',
            timeRemaining: 0
        });
        
        // Also send via BroadcastChannel
        controlChannel.postMessage({
            action: 'warmup-stop',
            timestamp: Date.now()
        });
        
        pushBroadcastState(activeBroadcastScene);
        console.log('[Control] Warmup stopped (Firestore + BroadcastChannel)');
    }

    function showStartlistCascade() {
        if (!currentGymnastList || currentGymnastList.length === 0) {
            alert('Nenhuma lista de largada dispon√≠vel');
            return;
        }

        const title = `Start List - ${currentSelectedPhase || 'Prova'} - ${(currentSelectedApparatus || 'fx').toUpperCase()}`;
        
        controlChannel.postMessage({
            action: 'show-startlist-main',
            payload: {
                list: currentGymnastList.map((g, index) => ({
                    id: g.id,
                    name: g.name,
                    country: g.country,
                    position: index + 1
                })),
                title: title
            }
        });
        
        console.log('[Control] Startlist cascade shown');
    }

    function showResultsCascade() {
        if (typeof calculateConsolidatedResults !== 'function') {
            alert('Fun√ß√£o de c√°lculo de resultados n√£o dispon√≠vel');
            return;
        }

        const basePhase = currentSelectedPhase?.split('|')[0] || 'qualifiers';
        const results = calculateConsolidatedResults(basePhase, currentSelectedApparatus);
        
        if (!results || results.length === 0) {
            alert('Nenhum resultado dispon√≠vel');
            return;
        }

        const title = `Resultados - ${basePhase.replace('_', ' ').toUpperCase()}`;
        
        controlChannel.postMessage({
            action: 'show-results-main',
            payload: {
                list: results.map((r, index) => ({
                    id: r.id,
                    name: r.name,
                    country: r.country,
                    score: r.total || r.score || r.apparatusScore || 0,
                    position: index + 1
                })),
                title: title
            }
        });
        
        console.log('[Control] Results cascade shown');
    }

    function submitInquiry() {
        const gymnastSelect = document.getElementById('inquiry-gymnast');
        const reasonTextarea = document.getElementById('inquiry-reason');
        
        if (!gymnastSelect || !reasonTextarea) {
            console.error('[Control] Inquiry form elements not found');
            return;
        }
        
        const gymnastId = gymnastSelect.value;
        const reason = reasonTextarea.value.trim();
        
        if (!gymnastId) {
            alert('Por favor, selecione uma ginasta');
            return;
        }
        
        if (!reason) {
            alert('Por favor, informe o motivo do recurso');
            return;
        }
        
        // Find gymnast name
        const gymnast = allGymnastData.find(g => g.id === gymnastId);
        const gymnastName = gymnast ? gymnast.name : 'Ginasta';
        
        // Update Firestore with inquiry state
        setOverlayState('inquiry', {
            visible: true,
            status: 'PENDING',
            gymnastId: gymnastId,
            gymnastName: gymnastName,
            reason: reason,
            timestamp: Date.now()
        });
        
        // Also send via BroadcastChannel for immediate response
        controlChannel.postMessage({
            action: 'inquiry-start',
            gymnastId: gymnastId,
            gymnastName: gymnastName,
            reason: reason,
            timestamp: Date.now()
        });
        
        pushBroadcastState(activeBroadcastScene);
        
        console.log('[Control] Inquiry submitted for:', gymnastName, '| Reason:', reason);
        closeModal('inquiry');
    }

    function resolveInquiry(accepted = true) {
        const status = accepted ? 'ACCEPTED' : 'REJECTED';
        
        setOverlayState('inquiry', {
            status: status,
            visible: true
        });
        
        pushBroadcastState(activeBroadcastScene);
        console.log('[Control] Inquiry', status.toLowerCase());
    }

    function hideInquiry() {
        setOverlayState('inquiry', {
            visible: false
        });
        
        controlChannel.postMessage({
            action: 'inquiry-stop',
            timestamp: Date.now()
        });
        
        pushBroadcastState(activeBroadcastScene);
        console.log('[Control] Inquiry hidden');
    }

    function getCountryInfo(countryCode) {
        if (!countryCode || typeof countryCode !== 'string') {
            return { code: null, name: '', emoji: 'üè≥Ô∏è' };
        }
        const normalized = countryCode.trim().toUpperCase();
        const data = window.countryData ? window.countryData[normalized] : null;
        return {
            code: data?.code ? data.code.toLowerCase() : normalized.toLowerCase(),
            name: data?.name || countryCode,
            emoji: data?.emoji || data?.flag || 'üè≥Ô∏è'
        };
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Timer Controls
        document.getElementById('btn-start')?.addEventListener('click', startTimer);
        document.getElementById('btn-stop')?.addEventListener('click', stopTimer);
        document.getElementById('btn-reset')?.addEventListener('click', resetTimer);
        document.getElementById('btn-score')?.addEventListener('click', showScore);
        document.getElementById('btn-show-score-lower')?.addEventListener('click', toggleLowerThirdScore);
        document.getElementById('btn-inquiry')?.addEventListener('click', () => showModal('inquiry'));

        // Broadcast Controls
        document.getElementById('btn-standby')?.addEventListener('click', () => pushBroadcastState(BROADCAST_SCENES.STANDBY));
        document.getElementById('btn-live')?.addEventListener('click', () => pushBroadcastState(BROADCAST_SCENES.LIVE));

        // Configuration Controls
        document.getElementById('apply-configuration')?.addEventListener('click', applyConfiguration);
        
        // Navigation Controls
        document.getElementById('btn-prev')?.addEventListener('click', goToPreviousGymnast);
        document.getElementById('btn-next')?.addEventListener('click', goToNextGymnast);
        document.getElementById('btn-sync')?.addEventListener('click', syncDisplays);

        // Overlay Controls
        document.getElementById('btn-timer-overlay')?.addEventListener('click', () => {
            toggleOverlayVisibility('timer');
            pushBroadcastState(activeBroadcastScene);
        });
        document.getElementById('btn-score-overlay')?.addEventListener('click', () => {
            toggleOverlayVisibility('scorecard');
            pushBroadcastState(activeBroadcastScene);
        });
        document.getElementById('btn-startlist')?.addEventListener('click', () => {
            toggleOverlayVisibility('startlistMain');
            pushBroadcastState(activeBroadcastScene);
        });
        document.getElementById('btn-results')?.addEventListener('click', () => {
            toggleOverlayVisibility('results');
            pushBroadcastState(activeBroadcastScene);
        });
        document.getElementById('btn-clear')?.addEventListener('click', () => {
            clearAllOverlays();
            pushBroadcastState(activeBroadcastScene);
        });
        
        // Special Controls
        document.getElementById('btn-warmup')?.addEventListener('click', startWarmup);
        document.getElementById('btn-warmup-stop')?.addEventListener('click', stopWarmup);
        document.getElementById('btn-inquiry')?.addEventListener('click', () => showModal('inquiry'));
        document.getElementById('btn-sounds')?.addEventListener('click', testBeep);

        // TV Broadcast Controls
        document.getElementById('btn-show-lower-third')?.addEventListener('click', showLowerThird);
        document.getElementById('btn-hide-lower-third')?.addEventListener('click', hideLowerThird);
        document.getElementById('btn-play-fx-music')?.addEventListener('click', playFXMusic);
        document.getElementById('btn-stop-fx-music')?.addEventListener('click', stopFXMusic);
        document.getElementById('btn-broadcast-warmup')?.addEventListener('click', () => startBroadcastWarmup(60));
        document.getElementById('btn-broadcast-warmup-4min')?.addEventListener('click', () => startBroadcastWarmup(240));
        document.getElementById('btn-show-startlist-cascade')?.addEventListener('click', showStartlistCascade);
        document.getElementById('btn-show-results-cascade')?.addEventListener('click', showResultsCascade);

        // Modal Buttons
        document.getElementById('btn-warmup')?.addEventListener('click', () => showModal('warmup'));
        document.getElementById('btn-sounds')?.addEventListener('click', () => showModal('sounds'));
        document.getElementById('btn-submit-inquiry')?.addEventListener('click', submitInquiry);

        // Close modals with Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal('inquiry');
                closeModal('warmup');
                closeModal('sounds');
            }
        });
    });

    // Initialize when Firebase is ready
    async function initializeWhenReady() {
        // Wait for Firebase to be fully initialized
        if (typeof firebase === 'undefined' || !firebase.apps.length) {
            console.log('[Control] Waiting for Firebase to initialize...');
            setTimeout(initializeWhenReady, 100);
            return;
        }

        if (window.db) {
            // Set db from window.db now that Firebase is ready
            db = window.db;
            console.log('[Control] Firebase connected successfully, db initialized');
            
            try {
                // Load phase structures
                await populatePhaseSelectAndOptions();
                
                // Listen for gymnast data changes
                const unsubscribeGymnasts = db.collection("new_gymnasts").onSnapshot((snapshot) => {
                    allGymnastData = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        allGymnastData.push({ id: doc.id, ...data });
                    });
                    console.log(`[Control] Loaded ${allGymnastData.length} gymnasts`);
                    
                    // Reload current list if active
                    if (currentFullSelection) {
                        loadGymnastList(currentFullSelection);
                    }
                });
                
                // Listen for start list changes
                const unsubscribeStartLists = db.collection("start_lists").onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        const phaseKey = change.doc.id;
                        const structure = change.doc.data().structure;
                        allStartListStructures[phaseKey] = structure;
                    });
                    
                    // Reload current list if active
                    if (currentFullSelection) {
                        loadGymnastList(currentFullSelection);
                    }
                });
                
                // Initialize timer display
                updateTimerDisplay();
                
            } catch (error) {
                console.error('[Control] Error initializing Firebase listeners:', error);
            }
            
        } else {
            console.log('[Control] Waiting for Firebase db to be available...');
            setTimeout(initializeWhenReady, 100);
        }
    }

    // Start when ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeWhenReady);
    } else {
        initializeWhenReady();
    }
    </script>
</body>
</html>