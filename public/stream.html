<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manaus Worlds Broadcast Engine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/broadcast-theme.css">
    <style>
        /* Judge Score Notification Pop-up */
        #judge-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #0e7c3a 0%, #009f3d 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            z-index: 99999;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        
        #judge-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        #judge-notification i {
            font-size: 1.2rem;
            color: #f7c948;
        }
    </style>
</head>
<body>
    <!-- Judge Score Notification -->
    <div id="judge-notification">
        <i class="fas fa-check-circle"></i>
        <span id="judge-notification-text">Nota lan√ßada</span>
    </div>
    
    <div id="app-shell">
        <video id="video-stream" playsinline muted autoplay></video>

        <div id="scene-container">
            <!-- SCENE: Standby -->
            <section class="scene" id="scene-standby" data-scene="SCENE_STANDBY" style="display:none;">
                <div class="scene-layer">
                    <div class="scene-card">
                        <h1 class="scene-title">EVENTO-TESTE EM BREVE</h1>
                        <p class="scene-subtitle">
                            A transmiss√£o oficial do evento-teste de Manaus 2025 come√ßar√° em instantes.<br>
                            Evento Oficial Preparat√≥rio para o Mundial de Gin√°stica Art√≠stica FIG Manaus 2025.
                        </p>
                    </div>
                </div>
            </section>

            <!-- SCENE: Live Performance -->
            <section class="scene" id="scene-live" data-scene="SCENE_LIVE_PERFORMANCE" style="display:none;">
                <div class="lower-third" id="live-lower-third" data-visible="false">
                    <div class="flag" id="live-flag">
                        <img id="live-flag-img" alt="" class="hidden" loading="lazy">
                        <span id="live-flag-emoji" class="flag-emoji">üè≥Ô∏è</span>
                    </div>
                    <div class="identity">
                        <div class="name">
                            <span class="lastname" id="live-lastname">-</span>
                            <span class="firstname" id="live-firstname">-</span>
                        </div>
                    </div>
                    <div class="score-section" id="live-score-section" data-visible="false">
                        <!-- Score breakdown: D, E, P, TOTAL -->
                        <div class="score-breakdown" id="live-score-breakdown" data-visible="true">
                            <div class="score-component">
                                <span class="component-label">D</span>
                                <span class="component-value" id="live-score-d">0.0</span>
                            </div>
                            <div class="score-component">
                                <span class="component-label">E</span>
                                <span class="component-value" id="live-score-e">0.000</span>
                            </div>
                            <div class="score-component">
                                <span class="component-label">P</span>
                                <span class="component-value" id="live-score-p">0.0</span>
                            </div>
                            <div class="score-component total">
                                <span class="component-label">TOTAL</span>
                                <span class="component-value" id="live-score-total">0.000</span>
                            </div>
                        </div>
                        <!-- Vault scores (VT1, VT2, Average) -->
                        <div class="vault-scores" id="live-vault-scores" data-visible="false">
                            <div class="vault-score">
                                <span class="vault-label">VT1</span>
                                <span class="vault-value" id="live-vt1-score">0.000</span>
                            </div>
                            <div class="vault-score">
                                <span class="vault-label">VT2</span>
                                <span class="vault-value" id="live-vt2-score">0.000</span>
                            </div>
                            <div class="vault-score average">
                                <span class="vault-label">M√âDIA</span>
                                <span class="vault-value" id="live-vault-average">0.000</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-icon" id="live-app-icon">--</div>
                </div>

                <!-- ‚ú® NOVO: Rodap√© VT1 (Nota Salto 1) -->
                <div class="lower-third lower-third-score" id="live-lower-third-vt1" data-visible="false">
                    <div class="app-icon-left" id="live-app-icon-vt1">VT</div>
                    <div class="flag" id="live-flag-vt1">
                        <img id="live-flag-img-vt1" alt="" class="hidden" loading="lazy">
                        <span id="live-flag-emoji-vt1" class="flag-emoji">üè≥Ô∏è</span>
                    </div>
                    <div class="identity">
                        <div class="name">
                            <span class="lastname" id="live-lastname-vt1">-</span>
                            <span class="firstname" id="live-firstname-vt1">-</span>
                        </div>
                    </div>
                    <div class="score-display">
                        <div class="score-components">
                            <div class="score-item">
                                <span class="score-label">D</span>
                                <span class="score-value" id="live-vt1-d">0.0</span>
                            </div>
                            <div class="score-item">
                                <span class="score-label">E</span>
                                <span class="score-value" id="live-vt1-e">0.000</span>
                            </div>
                            <div class="score-item">
                                <span class="score-label">P</span>
                                <span class="score-value" id="live-vt1-p">0.0</span>
                            </div>
                        </div>
                        <div class="score-total">
                            <span class="total-label">TOTAL</span>
                            <span class="total-value" id="live-vt1-total">0.000</span>
                        </div>
                    </div>
                </div>

                <!-- ‚ú® NOVO: Rodap√© VT2 (M√©dia dos Saltos) -->
                <div class="lower-third lower-third-score" id="live-lower-third-vt2" data-visible="false">
                    <div class="app-icon-left" id="live-app-icon-vt2">VT</div>
                    <div class="flag" id="live-flag-vt2">
                        <img id="live-flag-img-vt2" alt="" class="hidden" loading="lazy">
                        <span id="live-flag-emoji-vt2" class="flag-emoji">üè≥Ô∏è</span>
                    </div>
                    <div class="identity">
                        <div class="name">
                            <span class="lastname" id="live-lastname-vt2">-</span>
                            <span class="firstname" id="live-firstname-vt2">-</span>
                        </div>
                    </div>
                    <div class="score-display">
                        <div class="score-components">
                            <div class="score-item">
                                <span class="score-label">VT1</span>
                                <span class="score-value" id="live-vt2-score1">0.000</span>
                            </div>
                            <div class="score-item">
                                <span class="score-label">VT2</span>
                                <span class="score-value" id="live-vt2-score2">0.000</span>
                            </div>
                        </div>
                        <div class="score-total">
                            <span class="total-label">M√âDIA</span>
                            <span class="total-value" id="live-vt2-average">0.000</span>
                        </div>
                    </div>
                </div>

                <!-- ‚ú® NOVO: Rodap√© FX/UB/BB (Nota Aparelho) -->
                <div class="lower-third lower-third-score" id="live-lower-third-apparatus" data-visible="false">
                    <div class="app-icon-left" id="live-app-icon-apparatus">FX</div>
                    <div class="flag" id="live-flag-apparatus">
                        <img id="live-flag-img-apparatus" alt="" class="hidden" loading="lazy">
                        <span id="live-flag-emoji-apparatus" class="flag-emoji">üè≥Ô∏è</span>
                    </div>
                    <div class="identity">
                        <div class="name">
                            <span class="lastname" id="live-lastname-apparatus">-</span>
                            <span class="firstname" id="live-firstname-apparatus">-</span>
                        </div>
                    </div>
                    <div class="score-display">
                        <div class="score-components">
                            <div class="score-item">
                                <span class="score-label">D</span>
                                <span class="score-value" id="live-apparatus-d">0.0</span>
                            </div>
                            <div class="score-item">
                                <span class="score-label">E</span>
                                <span class="score-value" id="live-apparatus-e">0.000</span>
                            </div>
                            <div class="score-item">
                                <span class="score-label">P</span>
                                <span class="score-value" id="live-apparatus-p">0.0</span>
                            </div>
                        </div>
                        <div class="score-total">
                            <span class="total-label">TOTAL</span>
                            <span class="total-value" id="live-apparatus-total">0.000</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="overlay-container">
            <img src="images/logo.png" alt="Logo Manaus Worlds" id="logo-bug" class="active">

            <section class="broadcast-overlay overlay-timer" id="overlay-timer" data-visible="false">
                <header class="overlay-header">
                    <span class="overlay-title">Tempo de Rotina</span>
                    <span class="overlay-apparatus" id="overlay-timer-apparatus">FX</span>
                </header>
                <div class="overlay-timer-body">
                    <span class="overlay-timer-display" id="overlay-timer-display">00:00</span>
                    <div class="overlay-timer-meta">
                        <span class="overlay-status-pill" id="overlay-timer-status" data-status="WAIT">WAIT</span>
                        <span class="overlay-timer-dv">
                            <span class="label">DV</span>
                            <span class="value" id="overlay-timer-dv">--</span>
                        </span>
                    </div>
                    <span class="overlay-timer-warning" id="overlay-timer-warning" data-active="false">Tempo limite atingido</span>
                </div>
            </section>

            <section class="broadcast-overlay overlay-scorecard" id="overlay-scorecard" data-visible="false">
                <header class="overlay-header">
                    <div class="overlay-identity">
                        <div class="overlay-flag" id="overlay-scorecard-flag">
                            <img id="overlay-scorecard-flag-img" alt="" class="hidden">
                            <span id="overlay-scorecard-flag-emoji">üè≥Ô∏è</span>
                        </div>
                        <div class="overlay-name">
                            <span class="lastname" id="overlay-scorecard-lastname">-</span>
                            <span class="firstname" id="overlay-scorecard-firstname">-</span>
                        </div>
                    </div>
                    <div class="overlay-rank" id="overlay-scorecard-rank" data-visible="false">#1</div>
                </header>
                <div class="overlay-subline">
                    <span class="overlay-country" id="overlay-scorecard-country">---</span>
                </div>
                <div class="overlay-score-grid">
                    <div class="score-cell" data-score-type="D">
                        <span class="label">D</span>
                        <span class="value" id="overlay-scorecard-d">--</span>
                    </div>
                    <div class="score-cell" data-score-type="E">
                        <span class="label">E</span>
                        <span class="value" id="overlay-scorecard-e">--</span>
                    </div>
                    <div class="score-cell" data-score-type="P">
                        <span class="label">P</span>
                        <span class="value" id="overlay-scorecard-p">--</span>
                    </div>
                    <div class="score-cell total" data-score-type="TOTAL">
                        <span class="label">TOTAL</span>
                        <span class="value" id="overlay-scorecard-total">--</span>
                    </div>
                </div>
            </section>

            <!-- ‚ú® NOVO: Overlay Central de Listas e Resultados -->
            <section class="overlay-list-center" id="overlay-list-center" data-visible="false">
                <div class="list-center-container">
                    <header class="list-center-header">
                        <div class="list-center-logo">
                            <img src="images/logo.png" alt="Manaus 2025" style="width: 100px; height: auto;">
                        </div>
                        <div class="list-center-titles">
                            <h1 id="list-center-title">Women's All-Around Final</h1>
                            <h2 id="list-center-subtitle">Start List</h2>
                        </div>
                        <div class="list-center-page" id="list-center-page"></div>
                    </header>
                    <div class="list-center-body">
                        <ol id="list-center-items"></ol>
                    </div>
                </div>
              </section>

              <!-- ‚ú® Novo: Overlays de Cerim√¥nia de P√≥dio -->
              <section class="overlay-podium-intro" id="overlay-podium-intro" data-visible="false">
                  <div class="intro-card">
                      <h1>PREMIA√á√ÉO</h1>
                      <h2>EVENTO TESTE</h2>
                      <div class="intro-phase" id="podium-intro-phase">TEAM FINAL</div>
                  </div>
              </section>

              <section class="overlay-podium" id="overlay-podium" data-visible="false">
                  <div class="podium-title">
                      <span>P√ìDIO</span>
                      <span id="podium-phase-label">Team Final</span>
                  </div>
                  <div class="podium-stage" id="podium-stage"></div>
              </section>

              <section class="overlay-podium-footer" id="overlay-podium-footer" data-visible="false">
                  <div class="podium-footer-left">
                      <div class="podium-footer-flag" id="podium-footer-flag"></div>
                      <div class="podium-footer-text">
                          <div class="country" id="podium-footer-country">BRAZIL</div>
                          <div class="subtitle" id="podium-footer-subtitle">Bronze Medal - Team Final - Manaus 2025</div>
                      </div>
                  </div>
                  <div class="podium-footer-medal">
                      <div class="medal-icon" id="podium-footer-medal-icon">ü•â</div>
                      <span id="podium-footer-score">164.450</span>
                  </div>
              </section>

              <section class="overlay-podium-flags" id="overlay-podium-flags" data-visible="false">
                  <div class="podium-title" style="justify-content: center;">
                      <span>HINO NACIONAL</span>
                      <span id="podium-flags-phase">Team Final</span>
                  </div>
                  <div class="flag-raising-stage" id="podium-flags-stage"></div>
              </section>

              <!-- Warmup Overlay -->
            <section class="overlay-warmup" id="overlay-warmup" data-visible="false">
                <div class="warmup-content">
                    <h1 class="warmup-title">AQUECIMENTO</h1>
                    <div class="warmup-timer" id="warmup-timer">00:00</div>
                    <div class="warmup-status" id="warmup-status">PREPARANDO</div>
                </div>
            </section>

            <!-- Inquiry Overlay -->
            <section class="overlay-inquiry" id="overlay-inquiry" data-visible="false">
                <div class="inquiry-content">
                    <h1 class="inquiry-title">RECURSO EM AN√ÅLISE</h1>
                    <div class="inquiry-details" id="inquiry-details">
                        <div class="inquiry-gymnast" id="inquiry-gymnast">Ginasta</div>
                        <div class="inquiry-reason" id="inquiry-reason">Motivo do recurso...</div>
                    </div>
                </div>
            </section>

            <!-- Country Reception Overlay (Canto Superior Esquerdo) -->
            <section class="overlay-reception" id="overlay-reception" data-visible="false">
                <div class="reception-content">
                    <div class="reception-flag" id="reception-flag"></div>
                    <div class="reception-text" id="reception-text">BRAZIL TEAM</div>
                </div>
            </section>

            <!-- Welcome Overlay (Boas-Vindas √† Manaus 2025) -->
            <section class="overlay-welcome" id="overlay-welcome" data-visible="false">
                <div class="welcome-content">
                    <h1 class="welcome-title">BOAS-VINDAS √Ä</h1>
                    <img src="images/logo.png" alt="Manaus 2025" class="welcome-logo">
                </div>
            </section>

            <!-- Brazil Anthem Overlay (Hino Nacional Brasileiro) -->
            <section class="overlay-anthem" id="overlay-anthem" data-visible="false">
                <div class="anthem-content">
                    <div class="anthem-flag" id="anthem-flag"></div>
                    <div class="anthem-text">
                        <h1 class="anthem-title">HINO NACIONAL BRASILEIRO</h1>
                        <p class="anthem-subtitle">entoado pela For√ßa A√©rea Brasileira</p>
                    </div>
                </div>
            </section>

            <!-- Final Instructions Overlay (Instru√ß√µes Finais) -->
            <section class="overlay-instructions" id="overlay-instructions" data-visible="false">
                <div class="instructions-content">
                    <h1 class="instructions-title">‚ö†Ô∏è ATEN√á√ÉO GINASTAS! ‚ö†Ô∏è</h1>
                    <p class="instructions-subtitle">Instru√ß√µes finais da organiza√ß√£o</p>
                </div>
            </section>

            <!-- ‚ú® NOVO: Score Reveal Overlay (Aparelhos FX/BB/UB ou VT1) -->
            <section class="overlay-score-reveal" id="overlay-score-reveal" data-visible="false">
                <div class="score-reveal-container">
                    <!-- Lado ESQUERDO: Ranking 5 posi√ß√µes -->
                    <div class="score-reveal-left">
                        <div class="ranking-title">RANKING</div>
                        <div class="ranking-cards" id="ranking-cards">
                            <!-- Cards de ranking ser√£o inseridos dinamicamente aqui -->
                        </div>
                    </div>

                    <!-- CENTRO: Card Principal -->
                    <div class="score-reveal-center">
                        <div class="gymnast-card">
                            <div class="gymnast-header">
                                <div class="gymnast-flag" id="reveal-flag">
                                    <img id="reveal-flag-img" alt="" class="hidden" loading="lazy">
                                    <span id="reveal-flag-emoji" class="flag-emoji">üè≥Ô∏è</span>
                                </div>
                                <div class="gymnast-identity">
                                    <div class="gymnast-country" id="reveal-country">COUNTRY</div>
                                    <div class="gymnast-name">
                                        <span class="gymnast-lastname" id="reveal-lastname">LASTNAME</span>
                                        <span class="gymnast-firstname" id="reveal-firstname">First</span>
                                    </div>
                                </div>
                            </div>
                            <div class="score-footer">
                                <div class="apparatus-icon" id="reveal-apparatus-icon">FX</div>
                                <div class="total-score">
                                    <div class="score-label" id="reveal-score-label">TOTAL</div>
                                    <span class="total-value" id="reveal-total">13.500</span>
                                </div>
                                <div class="current-rank" id="reveal-rank">#2</div>
                            </div>
                        </div>
                    </div>

                    <!-- Lado DIREITO: Breakdown D, E, P -->
                    <div class="score-reveal-right">
                        <div class="score-breakdown-title" id="breakdown-title">BREAKDOWN</div>
                        
                        <!-- VT1 ou aparelho √∫nico -->
                        <div class="score-boxes" id="reveal-boxes-single" style="visibility: visible;">
                            <div class="score-box score-box-d">
                                <span class="box-label">D</span>
                                <span class="box-value" id="reveal-d">5.6</span>
                            </div>
                            <div class="score-box score-box-e">
                                <span class="box-label">E</span>
                                <span class="box-value" id="reveal-e">7.900</span>
                            </div>
                            <div class="score-box score-box-p" id="reveal-p-box">
                                <span class="box-label">P</span>
                                <span class="box-value" id="reveal-p">0.0</span>
                            </div>
                        </div>
                        
                        <!-- VT2 modo: 2 saltos com layout vertical -->
                        <div class="score-boxes-vt2" id="reveal-boxes-vt2" style="display: none;">
                            <!-- VT1 -->
                            <div class="vault-section">
                                <div class="vault-label-header">VT1</div>
                                <div class="vault-dep-scores">
                                    <div class="score-box-mini score-box-d">
                                        <span class="box-label">D</span>
                                        <span class="box-value" id="reveal-vt1-d">5.6</span>
                                    </div>
                                    <div class="score-box-mini score-box-e">
                                        <span class="box-label">E</span>
                                        <span class="box-value" id="reveal-vt1-e">7.900</span>
                                    </div>
                                    <div class="score-box-mini score-box-p">
                                        <span class="box-label">P</span>
                                        <span class="box-value" id="reveal-vt1-p">0.0</span>
                                    </div>
                                </div>
                                <div class="vault-total-badge">
                                    <span class="total-label">TOTAL VT1</span>
                                    <span class="total-value" id="reveal-vt1-total">15.566</span>
                                </div>
                            </div>
                            
                            <!-- VT2 -->
                            <div class="vault-section">
                                <div class="vault-label-header">VT2</div>
                                <div class="vault-dep-scores">
                                    <div class="score-box-mini score-box-d">
                                        <span class="box-label">D</span>
                                        <span class="box-value" id="reveal-vt2-d">5.4</span>
                                    </div>
                                    <div class="score-box-mini score-box-e">
                                        <span class="box-label">E</span>
                                        <span class="box-value" id="reveal-vt2-e">8.100</span>
                                    </div>
                                    <div class="score-box-mini score-box-p">
                                        <span class="box-label">P</span>
                                        <span class="box-value" id="reveal-vt2-p">0.0</span>
                                    </div>
                                </div>
                                <div class="vault-total-badge">
                                    <span class="total-label">TOTAL VT2</span>
                                    <span class="total-value" id="reveal-vt2-total">14.883</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <button id="capture-button" style="position:fixed; top:24px; left:24px; z-index:100; padding:12px 18px; border-radius:12px; border:none; font-weight:600; letter-spacing:0.08rem; background:rgba(56,189,248,0.25); color:#f1f5f9; backdrop-filter:blur(6px); box-shadow:0 10px 25px rgba(2,6,23,0.45); cursor:pointer;">
        Ativar captura da arena
    </button>

    <button id="enable-audio-btn">üîä Habilitar √°udio</button>

    <audio id="gymnast-audio" preload="auto"></audio>
    <audio id="beep-audio" preload="auto">
        <source src="audio/beep.mp3" type="audio/mpeg">
        <source src="audio/beep.ogg" type="audio/ogg">
    </audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="js/firebase-init.js"></script>
    <script src="js/countries.js"></script>
    <script src="js/calculation-logic.js"></script>
    <script>
        const resolvedFirebaseConfig = (typeof window !== 'undefined' && window.firebaseConfig)
            ? window.firebaseConfig
            : (typeof firebaseConfig !== 'undefined' ? firebaseConfig : null);

        if (!firebase.apps.length && resolvedFirebaseConfig) {
            firebase.initializeApp(resolvedFirebaseConfig);
        }

        if (!window.firebaseConfig && resolvedFirebaseConfig) {
            window.firebaseConfig = resolvedFirebaseConfig;
        }

        const db = window.db || firebase.firestore();

        const dataState = {
            gymnasts: [],
            gymnastMap: new Map(),
            startLists: {},
            lastUpdated: {
                gymnasts: null,
                startLists: null
            }
        };

        const overlayContext = {
            phase: 'qualifiers',
            apparatus: 'fx',
            currentIndex: 0,
            subdivIdx: null,
            rotIdx: null,
            activeVaultNum: 1,
             gymnastId: null,
            showScore: false,
            timer: {
                status: 'WAIT',
                elapsed: 0,
                warning: false,
                startedAt: null,
                intervalId: null,
                dv: null
            },
            music: {
                status: 'WAIT',
                label: 'FX',
                timestamp: null
            }
        };

        const latestBroadcastState = {
            currentScene: 'SCENE_STANDBY',
            scenePayload: {},
            activeOverlays: { logoBug: false, widgets: {} },
            audioCommand: null
        };

        // Estado persistente do rodap√© - s√≥ muda com comando expl√≠cito
        let currentLowerThirdState = false;

        let unsubscribeGymnasts = null;
        let unsubscribeStartLists = null;
        let unsubscribeBroadcast = null;
        let controlChannel = null;
        let lastAudioTimestamp = 0;

        const SCENES = {
            STANDBY: 'SCENE_STANDBY',
            LIVE: 'SCENE_LIVE_PERFORMANCE'
        };

        const sceneNodes = Array.from(document.querySelectorAll('.scene'));
        let activeSceneId = null;

        const sceneElements = {
            [SCENES.STANDBY]: document.getElementById('scene-standby'),
            [SCENES.LIVE]: document.getElementById('scene-live')
        };

        const lowerThird = document.getElementById('live-lower-third');
        const lowerThirdFields = {
            flag: document.getElementById('live-flag'),
            flagImg: document.getElementById('live-flag-img'),
            flagEmoji: document.getElementById('live-flag-emoji'),
            lastname: document.getElementById('live-lastname'),
            firstname: document.getElementById('live-firstname'),
            icon: document.getElementById('live-app-icon'),
            scoreSection: document.getElementById('live-score-section'),
            scoreLabel: document.getElementById('live-score-label'),
            scoreValue: document.getElementById('live-score-value'),
            vaultScores: document.getElementById('live-vault-scores'),
            vt1Score: document.getElementById('live-vt1-score'),
            vt2Score: document.getElementById('live-vt2-score')
        };

        // ‚ú® Novos rodap√©s de notas
        const lowerThirdVt1 = document.getElementById('live-lower-third-vt1');
        const lowerThirdVt1Fields = {
            root: lowerThirdVt1,
            appIcon: document.getElementById('live-app-icon-vt1'),
            flagImg: document.getElementById('live-flag-img-vt1'),
            flagEmoji: document.getElementById('live-flag-emoji-vt1'),
            lastname: document.getElementById('live-lastname-vt1'),
            firstname: document.getElementById('live-firstname-vt1'),
            dScore: document.getElementById('live-vt1-d'),
            eScore: document.getElementById('live-vt1-e'),
            pScore: document.getElementById('live-vt1-p'),
            total: document.getElementById('live-vt1-total')
        };

        const lowerThirdVt2 = document.getElementById('live-lower-third-vt2');
        const lowerThirdVt2Fields = {
            root: lowerThirdVt2,
            appIcon: document.getElementById('live-app-icon-vt2'),
            flagImg: document.getElementById('live-flag-img-vt2'),
            flagEmoji: document.getElementById('live-flag-emoji-vt2'),
            lastname: document.getElementById('live-lastname-vt2'),
            firstname: document.getElementById('live-firstname-vt2'),
            score1: document.getElementById('live-vt2-score1'),
            score2: document.getElementById('live-vt2-score2'),
            average: document.getElementById('live-vt2-average')
        };

        const lowerThirdApparatus = document.getElementById('live-lower-third-apparatus');
        const lowerThirdApparatusFields = {
            root: lowerThirdApparatus,
            appIcon: document.getElementById('live-app-icon-apparatus'),
            flagImg: document.getElementById('live-flag-img-apparatus'),
            flagEmoji: document.getElementById('live-flag-emoji-apparatus'),
            lastname: document.getElementById('live-lastname-apparatus'),
            firstname: document.getElementById('live-firstname-apparatus'),
            dScore: document.getElementById('live-apparatus-d'),
            eScore: document.getElementById('live-apparatus-e'),
            pScore: document.getElementById('live-apparatus-p'),
            total: document.getElementById('live-apparatus-total')
        };

        const logoBug = document.getElementById('logo-bug');
        const captureButton = document.getElementById('capture-button');
        const videoStream = document.getElementById('video-stream');

        const apparatusIcons = {
            VT: 'VT',
            UB: 'UB',
            BB: 'BB',
            FX: 'FX'
        };

        const apparatusLabels = {
            VT: 'VAULT',
            UB: 'UNEVEN BARS',
            BB: 'BALANCE BEAM',
            FX: 'FLOOR'
        };

        const FLAG_CDN_BASE = 'https://flagcdn.com';

        const overlayElements = {
            timer: {
                root: document.getElementById('overlay-timer'),
                apparatus: document.getElementById('overlay-timer-apparatus'),
                status: document.getElementById('overlay-timer-status'),
                display: document.getElementById('overlay-timer-display'),
                warning: document.getElementById('overlay-timer-warning'),
                dvContainer: document.querySelector('#overlay-timer .overlay-timer-dv'),
                dv: document.getElementById('overlay-timer-dv')
            },
            scorecard: {
                root: document.getElementById('overlay-scorecard'),
                flagImg: document.getElementById('overlay-scorecard-flag-img'),
                flagEmoji: document.getElementById('overlay-scorecard-flag-emoji'),
                lastname: document.getElementById('overlay-scorecard-lastname'),
                firstname: document.getElementById('overlay-scorecard-firstname'),
                country: document.getElementById('overlay-scorecard-country'),
                d: document.getElementById('overlay-scorecard-d'),
                e: document.getElementById('overlay-scorecard-e'),
                p: document.getElementById('overlay-scorecard-p'),
                total: document.getElementById('overlay-scorecard-total'),
                rank: document.getElementById('overlay-scorecard-rank')
            },
            startlistMain: {
                root: document.getElementById('overlay-startlist-main'),
                title: document.getElementById('overlay-startlist-main-title'),
                list: document.getElementById('overlay-startlist-main-items')
            },
            startlistCorner: {
                root: document.getElementById('overlay-startlist-corner'),
                title: document.getElementById('overlay-startlist-corner-title'),
                list: document.getElementById('overlay-startlist-corner-items')
            },
            results: {
                root: document.getElementById('overlay-results'),
                title: document.getElementById('overlay-results-title'),
                list: document.getElementById('overlay-results-items')
            }
        };

        const overlayPodiumIntro = document.getElementById('overlay-podium-intro');
        const overlayPodium = document.getElementById('overlay-podium');
        const overlayPodiumFooter = document.getElementById('overlay-podium-footer');
        const overlayPodiumFlags = document.getElementById('overlay-podium-flags');
        const podiumIntroPhaseEl = document.getElementById('podium-intro-phase');
        const podiumPhaseLabelEl = document.getElementById('podium-phase-label');
        const podiumStageContainer = document.getElementById('podium-stage');
        const podiumFooterFlagEl = document.getElementById('podium-footer-flag');
        const podiumFooterCountryEl = document.getElementById('podium-footer-country');
        const podiumFooterSubtitleEl = document.getElementById('podium-footer-subtitle');
        const podiumFooterMedalIconEl = document.getElementById('podium-footer-medal-icon');
        const podiumFooterScoreEl = document.getElementById('podium-footer-score');
        const podiumFlagsPhaseEl = document.getElementById('podium-flags-phase');
        const podiumFlagsStageEl = document.getElementById('podium-flags-stage');

        const PODIUM_PHASES = {
            team_final: { label: 'Team Final', category: 'team', apparatus: null },
            aa_final: { label: 'All-Around Final', category: 'individual', apparatus: null },
            vt_final: { label: 'Vault Final', category: 'individual', apparatus: 'vt' },
            ub_final: { label: 'Uneven Bars Final', category: 'individual', apparatus: 'ub' },
            bb_final: { label: 'Balance Beam Final', category: 'individual', apparatus: 'bb' },
            fx_final: { label: 'Floor Exercise Final', category: 'individual', apparatus: 'fx' }
        };

        const MEDAL_CONFIG = {
            gold: { label: 'Gold Medal', icon: 'ü•á' },
            silver: { label: 'Silver Medal', icon: 'ü•à' },
            bronze: { label: 'Bronze Medal', icon: 'ü•â' }
        };

        const ANTHEM_FILES = {
            BRA: 'music/brazil-anthem.mp3',
            ITA: 'music/italy-anthem.mp3',
            CHN: 'music/china-anthem.mp3',
            USA: 'music/usa-anthem.mp3'
        };

        const PODIUM_LAYOUT = ['silver', 'gold', 'bronze'];
        const MEDAL_INDEX = { gold: 0, silver: 1, bronze: 2 };

        const podiumState = {
            phaseKey: null,
            apparatus: null,
            phaseLabel: '',
            category: 'individual',
            results: [],
            activeMedals: {
                gold: null,
                silver: null,
                bronze: null
            },
            lastMedal: null,
            introTimeout: null
        };

        const enableAudioBtn = document.getElementById('enable-audio-btn');
        const gymnastAudioElement = document.getElementById('gymnast-audio');
        const beepAudioElement = document.getElementById('beep-audio');
        let audioEnabled = false;
        let lastBeepSecond = -1;

        const LIST_SCORE_KEYS = ['totalScore', 'total', 'score', 'value', 'result', 'average', 'points'];

        function applyFlagImage(flagImgEl, flagEmojiEl, countryCode, fallbackEmoji = 'üè≥Ô∏è') {
            console.log('[Stream] üè≥Ô∏è applyFlagImage called with:', { 
                flagImgEl, 
                flagEmojiEl, 
                countryCode, 
                fallbackEmoji,
                hasImgElement: !!flagImgEl,
                hasEmojiElement: !!flagEmojiEl 
            });
            
            if (!flagImgEl || !flagEmojiEl) {
                console.error('[Stream] ‚ùå applyFlagImage: Missing elements!', { flagImgEl, flagEmojiEl });
                return;
            }

            let normalizedCode = (typeof countryCode === 'string') ? countryCode.trim().toLowerCase() : '';
            console.log('[Stream] üè≥Ô∏è normalizedCode BEFORE:', normalizedCode, 'length:', normalizedCode.length);
            
            // CORRIGIDO: Se c√≥digo tem 3 letras, converter usando countryData
            if (normalizedCode.length === 3 && window.countryData) {
                const countryInfo = window.countryData[normalizedCode.toUpperCase()];
                if (countryInfo && countryInfo.code) {
                    normalizedCode = countryInfo.code; // Converte BRA ‚Üí br, USA ‚Üí us, etc
                    console.log('[Stream] üè≥Ô∏è Converted 3-letter to 2-letter:', normalizedCode);
                }
            }
            
            console.log('[Stream] üè≥Ô∏è normalizedCode AFTER:', normalizedCode, 'length:', normalizedCode.length);
            
            if (normalizedCode.length === 2) {
                const basePng = `${FLAG_CDN_BASE}/w160/${normalizedCode}.png`;
                console.log('[Stream] üè≥Ô∏è Setting flag image:', basePng);
                flagImgEl.src = basePng;
                flagImgEl.srcset = `${FLAG_CDN_BASE}/w80/${normalizedCode}.png 1x, ${FLAG_CDN_BASE}/w160/${normalizedCode}.png 2x, ${FLAG_CDN_BASE}/w320/${normalizedCode}.png 3x`;
                flagImgEl.alt = `Bandeira ${normalizedCode.toUpperCase()}`;
                flagImgEl.classList.remove('hidden');
                flagEmojiEl.classList.add('hidden');
                flagEmojiEl.textContent = fallbackEmoji || 'üè≥Ô∏è';
            } else {
                console.log('[Stream] üè≥Ô∏è Invalid countryCode, using emoji fallback');
                flagImgEl.removeAttribute('src');
                flagImgEl.removeAttribute('srcset');
                flagImgEl.classList.add('hidden');
                flagEmojiEl.textContent = fallbackEmoji || 'üè≥Ô∏è';
                flagEmojiEl.classList.remove('hidden');
            }
        }

        function renderLowerThirdFlag(countryCode, flagEmoji) {
            console.log('[Stream] üè≥Ô∏è renderLowerThirdFlag called with:', { countryCode, flagEmoji });
            applyFlagImage(lowerThirdFields.flagImg, lowerThirdFields.flagEmoji, countryCode, flagEmoji);
        }

        function setLowerThirdVisibility(shouldShow) {
            if (!lowerThird) return;
            const nextState = !!shouldShow;
            lowerThird.dataset.visible = nextState ? 'true' : 'false';
        }

        // ========== FUN√á√ïES DOS NOVOS RODAP√âS DE NOTAS ==========
        
        function hideAllLowerThirds() {
            console.log('[Stream] üö´ Ocultando todos os rodap√©s...');
            setLowerThirdVisibility(false);
            if (lowerThirdVt1) lowerThirdVt1.dataset.visible = 'false';
            if (lowerThirdVt2) lowerThirdVt2.dataset.visible = 'false';
            if (lowerThirdApparatus) lowerThirdApparatus.dataset.visible = 'false';
        }

        function updateLowerThirdVt1(gymnastData, phase, scoreData) {
            console.log('[Stream] üìä Atualizando rodap√© VT1:', { gymnastData, phase, scoreData });
            
            if (!lowerThirdVt1Fields.root) return;
            
            // Atualizar identidade
            const countryInfo = getCountryInfo(gymnastData.country);
            lowerThirdVt1Fields.lastname.textContent = (gymnastData.surname || gymnastData.lastName || '-').toUpperCase();
            lowerThirdVt1Fields.firstname.textContent = gymnastData.firstName || gymnastData.name || '-';
            lowerThirdVt1Fields.appIcon.textContent = 'VT';
            
            // Atualizar bandeira
            applyFlagImage(lowerThirdVt1Fields.flagImg, lowerThirdVt1Fields.flagEmoji, countryInfo.code, countryInfo.emoji);
            
            // Atualizar notas (D, E, P, Total)
            const d = scoreData?.vt1_d ?? 0;
            const e = scoreData?.vt1_e ?? 0;
            const p = scoreData?.vt1_p ?? 0;
            const total = d + e - p;
            
            console.log('[Stream] üéØ VT1 Rodap√© - D:', d, 'E:', e, 'P:', p, 'Total:', total);
            console.log('[Stream] üéØ VT1 Rodap√© - Phase:', phase);
            console.log('[Stream] üéØ VT1 Rodap√© - ScoreData:', scoreData);
            
            lowerThirdVt1Fields.dScore.textContent = formatScoreValue(d, 1);
            lowerThirdVt1Fields.eScore.textContent = formatScoreValue(e, 3);
            lowerThirdVt1Fields.pScore.textContent = formatScoreValue(p, 1);
            lowerThirdVt1Fields.total.textContent = formatScoreValue(total, 3);
            
            // Mostrar rodap√©
            hideAllLowerThirds();
            lowerThirdVt1.dataset.visible = 'true';
            console.log('[Stream] ‚úÖ Rodap√© VT1 exibido com sucesso!');
        }

        function updateLowerThirdVt2(gymnastData, phase, scoreData) {
            console.log('[Stream] üìä Atualizando rodap√© VT2:', { gymnastData, phase, scoreData });
            
            if (!lowerThirdVt2Fields.root) return;
            
            // Atualizar identidade
            const countryInfo = getCountryInfo(gymnastData.country);
            lowerThirdVt2Fields.lastname.textContent = (gymnastData.surname || gymnastData.lastName || '-').toUpperCase();
            lowerThirdVt2Fields.firstname.textContent = gymnastData.firstName || gymnastData.name || '-';
            lowerThirdVt2Fields.appIcon.textContent = 'VT';
            
            // Atualizar bandeira
            applyFlagImage(lowerThirdVt2Fields.flagImg, lowerThirdVt2Fields.flagEmoji, countryInfo.code, countryInfo.emoji);
            
            // Calcular VT1 e VT2
            const vt1_d = scoreData?.vt1_d ?? 0;
            const vt1_e = scoreData?.vt1_e ?? 0;
            const vt1_p = scoreData?.vt1_p ?? 0;
            const vt1Total = vt1_d + vt1_e - vt1_p;
            
            const vt2_d = scoreData?.vt2_d ?? 0;
            const vt2_e = scoreData?.vt2_e ?? 0;
            const vt2_p = scoreData?.vt2_p ?? 0;
            const vt2Total = vt2_d + vt2_e - vt2_p;
            
            console.log('[Stream] üîç VT2 DEBUG - D:', vt2_d, 'E:', vt2_e, 'P:', vt2_p, 'Total:', vt2Total);
            
            const average = (vt1Total + vt2Total) / 2;
            
            lowerThirdVt2Fields.score1.textContent = formatScoreValue(vt1Total, 3);
            lowerThirdVt2Fields.score2.textContent = formatScoreValue(vt2Total, 3);
            lowerThirdVt2Fields.average.textContent = formatScoreValue(average, 3);
            
            // Mostrar rodap√©
            hideAllLowerThirds();
            lowerThirdVt2.dataset.visible = 'true';
        }

        function updateLowerThirdApparatus(gymnastData, phase, apparatus, scoreData) {
            console.log('[Stream] üìä Atualizando rodap√© aparelho:', { gymnastData, phase, apparatus, scoreData });
            
            if (!lowerThirdApparatusFields.root) return;
            
            // Atualizar identidade
            const countryInfo = getCountryInfo(gymnastData.country);
            lowerThirdApparatusFields.lastname.textContent = (gymnastData.surname || gymnastData.lastName || '-').toUpperCase();
            lowerThirdApparatusFields.firstname.textContent = gymnastData.firstName || gymnastData.name || '-';
            lowerThirdApparatusFields.appIcon.textContent = apparatus.toUpperCase();
            
            // Atualizar bandeira
            applyFlagImage(lowerThirdApparatusFields.flagImg, lowerThirdApparatusFields.flagEmoji, countryInfo.code, countryInfo.emoji);
            
            // Buscar notas baseadas no aparelho
            let d = 0, e = 0, p = 0;
            
            if (scoreData) {
                switch(apparatus.toLowerCase()) {
                    case 'fx':
                        d = scoreData.fx_d ?? scoreData.d ?? 0;
                        e = scoreData.fx_e ?? scoreData.e ?? 0;
                        p = scoreData.fx_p ?? scoreData.p ?? 0;
                        break;
                    case 'ub':
                        d = scoreData.d ?? 0;  // UB usa 'd', 'e', 'p' direto
                        e = scoreData.e ?? 0;
                        p = scoreData.p ?? 0;
                        break;
                    case 'bb':
                        d = scoreData.bb_d ?? scoreData.d ?? 0;
                        e = scoreData.bb_e ?? scoreData.e ?? 0;
                        p = scoreData.bb_p ?? scoreData.p ?? 0;
                        break;
                    default:
                        d = scoreData.d ?? 0;
                        e = scoreData.e ?? 0;
                        p = scoreData.p ?? 0;
                }
            }
            
            const total = d + e - p;
            
            lowerThirdApparatusFields.dScore.textContent = formatScoreValue(d, 1);
            lowerThirdApparatusFields.eScore.textContent = formatScoreValue(e, 3);
            lowerThirdApparatusFields.pScore.textContent = formatScoreValue(p, 1);
            lowerThirdApparatusFields.total.textContent = formatScoreValue(total, 3);
            
            // Mostrar rodap√©
            hideAllLowerThirds();
            lowerThirdApparatus.dataset.visible = 'true';
        }

        function updateLowerThirdContent(payload) {
            console.log('[Stream] üìä updateLowerThirdContent called with:', payload);
            
            const {
                gymnastName = '-',
                gymnastLastName = '-',
                countryFlagEmoji = 'üè≥Ô∏è',
                countryCode = null,
                apparatus = 'FX',
                showScore = false,
                totalScore = null,
                dScore = null,
                eScore = null,
                pScore = null,
                vt1Score = null,
                vt2Score = null,
                scoreLabel = 'TOTAL'
            } = payload || {};

            lowerThirdFields.lastname.textContent = gymnastLastName ? gymnastLastName.toUpperCase() : '-';
            lowerThirdFields.firstname.textContent = gymnastName || '-';
            lowerThirdFields.icon.textContent = apparatusIcons[apparatus] || apparatus;

            console.log('[Stream] üìä About to render flag with countryCode:', countryCode, 'flagEmoji:', countryFlagEmoji);
            renderLowerThirdFlag(countryCode, countryFlagEmoji);
            updateLowerThirdScores({ 
                showScore, 
                totalScore, 
                dScore, 
                eScore, 
                pScore,
                vt1Score, 
                vt2Score, 
                scoreLabel, 
                apparatus 
            });
        }

        function updateLowerThirdScores({ 
            showScore = false, 
            totalScore = null, 
            dScore = null,
            eScore = null,
            pScore = null,
            vt1Score = null, 
            vt2Score = null, 
            scoreLabel = 'TOTAL', 
            apparatus = 'FX' 
        }) {
            const scoreSection = document.getElementById('live-score-section');
            const scoreBreakdown = document.getElementById('live-score-breakdown');
            const vaultScores = document.getElementById('live-vault-scores');
            
            if (!scoreSection) return;
            
            // Show/hide score section
            scoreSection.dataset.visible = showScore ? 'true' : 'false';
            
            if (!showScore) return;
            
            // Handle vault-specific scores
            const isVault = apparatus === 'VT';
            
            if (isVault && vaultScores) {
                // Hide score breakdown, show vault scores
                if (scoreBreakdown) scoreBreakdown.dataset.visible = 'false';
                vaultScores.dataset.visible = 'true';
                
                // Update vault scores
                const vt1El = document.getElementById('live-vt1-score');
                const vt2El = document.getElementById('live-vt2-score');
                const avgEl = document.getElementById('live-vault-average');
                
                if (vt1El) vt1El.textContent = formatScoreValue(vt1Score);
                if (vt2El) vt2El.textContent = formatScoreValue(vt2Score);
                
                // Calculate average
                if (avgEl && vt1Score !== null && vt2Score !== null) {
                    const avg = (parseFloat(vt1Score) + parseFloat(vt2Score)) / 2;
                    avgEl.textContent = formatScoreValue(avg);
                } else if (avgEl) {
                    avgEl.textContent = '--';
                }
            } else if (scoreBreakdown) {
                // Hide vault scores, show D/E/P/TOTAL breakdown
                if (vaultScores) vaultScores.dataset.visible = 'false';
                scoreBreakdown.dataset.visible = 'true';
                
                // Update D, E, P, TOTAL
                const dEl = document.getElementById('live-score-d');
                const eEl = document.getElementById('live-score-e');
                const pEl = document.getElementById('live-score-p');
                const totalEl = document.getElementById('live-score-total');
                
                if (dEl) dEl.textContent = formatScoreValue(dScore, 1);
                if (eEl) eEl.textContent = formatScoreValue(eScore);
                if (pEl) pEl.textContent = formatScoreValue(pScore, 1);
                if (totalEl) totalEl.textContent = formatScoreValue(totalScore);
            }
        }

        function formatSecondsToClock(rawSeconds) {
            const numeric = Number(rawSeconds);
            if (!Number.isFinite(numeric)) return '00:00';
            const totalSeconds = Math.max(0, Math.floor(numeric));
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function formatScoreValue(value, decimals = 3) {
            if (value === null || value === undefined) return '--';
            if (typeof value === 'string' && value.trim() === '') return '--';
            const numeric = Number(value);
            if (Number.isFinite(numeric)) {
                return numeric.toFixed(decimals);
            }
            return String(value);
        }

        function getCountryInfo(countryCode) {
            if (!countryCode || typeof countryCode !== 'string') {
                return { code: null, emoji: 'üè≥Ô∏è' };
            }
            
            const normalized = countryCode.trim().toUpperCase();
            
            // 1. Tenta encontrar por c√≥digo de 3 letras (ex: 'BRA')
            if (normalized.length === 3 && window.countryData && window.countryData[normalized]) {
                const data = window.countryData[normalized];
                return { 
                    code: (data.code || '').toLowerCase(), 
                    emoji: data.flag || data.emoji || 'üè≥Ô∏è' 
                };
            }
            
            // 2. Tenta encontrar por c√≥digo de 2 letras (ex: 'BR')
            if (normalized.length === 2 && window.countryData) {
                // Procura no objeto de pa√≠ses por um que tenha o c√≥digo de 2 letras
                for (const key in window.countryData) {
                    const country = window.countryData[key];
                    if (country.code && country.code.toUpperCase() === normalized) {
                        return { 
                            code: country.code.toLowerCase(), 
                            emoji: country.flag || country.emoji || 'üè≥Ô∏è' 
                        };
                    }
                }
            }
            
            // 3. Fallback final se nada for encontrado
            console.log('[Stream] üè≥Ô∏è getCountryInfo: Nenhum pa√≠s encontrado para o c√≥digo:', countryCode);
            return { code: null, emoji: 'üè≥Ô∏è' };
        }

        function splitNameParts(fullName) {
            if (!fullName || typeof fullName !== 'string') {
                return { firstName: '', lastName: '' };
            }
            const parts = fullName.trim().split(/\s+/);
            if (parts.length === 1) {
                return { firstName: parts[0], lastName: parts[0].toUpperCase() };
            }
            
            // Separar sobrenomes (palavras em caixa alta) de nomes (caixa mista)
            // Ex: "Rebeca ANDRADE" -> lastName: "ANDRADE", firstName: "Rebeca"
            // Ex: "Daiane DOS SANTOS" -> lastName: "DOS SANTOS", firstName: "Daiane"
            const lastNameParts = [];
            const firstNameParts = [];
            
            for (let i = parts.length - 1; i >= 0; i--) {
                // Se a palavra est√° toda em mai√∫scula (e tem mais de 1 caractere), √© sobrenome
                if (parts[i] === parts[i].toUpperCase() && parts[i].length > 1) {
                    lastNameParts.unshift(parts[i]);
                } else {
                    // Encontrou palavra em caixa mista, o resto √© nome
                    firstNameParts.unshift(...parts.slice(0, i + 1));
                    break;
                }
            }
            
            // Se n√£o encontrou nenhuma palavra em caixa mista, usa a l√≥gica antiga
            if (firstNameParts.length === 0) {
                const lastName = parts.pop();
                return {
                    firstName: parts.join(' '),
                    lastName: lastName.toUpperCase()
                };
            }
            
            return {
                firstName: firstNameParts.join(' '),
                lastName: lastNameParts.join(' ')
            };
        }

        function resolveGymnastById(gymnastId) {
            if (!gymnastId) return null;
            return dataState.gymnastMap.get(gymnastId) || null;
        }

        function setOverlayVisibility(element, visible) {
            if (!element) return;
            element.dataset.visible = visible ? 'true' : 'false';
        }

        function resolveListScore(item, decimals = 3, keys = LIST_SCORE_KEYS) {
            if (!item) return null;
            const searchKeys = Array.isArray(keys) && keys.length ? keys : LIST_SCORE_KEYS;
            for (const key of searchKeys) {
                if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
                    return formatScoreValue(item[key], decimals);
                }
            }
            return null;
        }

        function normalizeListName(item = {}) {
            if (!item) return '-';
            if (item.displayName) return String(item.displayName);
            const first = item.firstName || item.firstname || item.gymnastName || item.name || item.athlete || '';
            const last = item.lastName || item.lastname || item.gymnastLastName || '';
            if (first && last) {
                return `${first} ${String(last).toUpperCase()}`.trim();
            }
            if (last) return String(last).toUpperCase();
            if (first) return String(first);
            if (item.team) return String(item.team);
            return '-';
        }

        function resolveListCountry(item = {}) {
            const value = item.countryCode || item.country || item.nation || item.teamCode || item.countryShort;
            if (!value) return '';
            return String(value).toUpperCase();
        }

        function setAudioButtonState(enabled) {
            if (!enableAudioBtn) return;
            if (enabled) {
                enableAudioBtn.classList.add('hidden');
            } else {
                enableAudioBtn.classList.remove('hidden');
            }
        }

        async function primeAudioElement(element) {
            if (!element) return false;
            try {
                await element.play();
                element.pause();
                element.currentTime = 0;
                return true;
            } catch (error) {
                console.warn('[Stream] Audio priming failed:', error);
                return false;
            }
        }

        async function unlockAudio() {
            const beepReady = await primeAudioElement(beepAudioElement);
            const gymnastReady = await primeAudioElement(gymnastAudioElement);
            audioEnabled = beepReady || gymnastReady;
            setAudioButtonState(audioEnabled);
            return audioEnabled;
        }

        async function ensureAudioEnabled() {
            if (audioEnabled) return true;
            
            // Try to enable audio automatically
            console.log('[Stream] Attempting to auto-enable audio...');
            const success = await unlockAudio();
            
            if (!success) {
                console.warn('[Stream] ‚ö†Ô∏è Audio is not enabled. User must click "Enable Audio" button first.');
                if (enableAudioBtn) {
                    enableAudioBtn.classList.remove('hidden');
                }
            }
            
            return success;
        }

        function playBeep(force = false) {
            if (!ensureAudioEnabled() || !beepAudioElement) return;
            if (!force && lastBeepSecond === overlayContext.timer.elapsed) return;

            try {
                beepAudioElement.currentTime = 0;
                beepAudioElement.volume = 0.8;
                const playPromise = beepAudioElement.play();
                if (playPromise) {
                    playPromise.catch((error) => console.warn('[Stream] Beep playback blocked:', error));
                }
                lastBeepSecond = overlayContext.timer.elapsed;
            } catch (error) {
                console.warn('[Stream] Unable to play beep:', error);
            }
        }

        function stopGymnastMusic() {
            if (!gymnastAudioElement) return;
            gymnastAudioElement.pause();
            gymnastAudioElement.currentTime = 0;
            gymnastAudioElement.removeAttribute('src');
        }

        function playGymnastMusic(gymnastId) {
            if (!ensureAudioEnabled() || !gymnastAudioElement || !gymnastId) return;
            const gymnast = resolveGymnastById(gymnastId);
            const musicUrl = gymnast?.fxMusicUrl || gymnast?.musicUrl || null;
            if (!musicUrl) {
                stopGymnastMusic();
                return;
            }

            if (gymnastAudioElement.src !== musicUrl) {
                gymnastAudioElement.src = musicUrl;
            }
            gymnastAudioElement.currentTime = 0;
            gymnastAudioElement.volume = 1;
            gymnastAudioElement.play().then(() => {
                overlayContext.music.status = 'GO';
                overlayContext.music.label = gymnast?.fxMusicLabel || gymnast?.fxMusicTitle || gymnast?.fxMusicName || gymnast?.musicTitle || 'M√∫sica';
                overlayContext.music.timestamp = Date.now();
            }).catch((error) => {
                console.warn('[Stream] Gymnast music blocked:', error);
            });
        }

        function stopAllAudio(resetButton = false) {
            stopGymnastMusic();
            if (resetButton) {
                audioEnabled = false;
                setAudioButtonState(false);
            }
        }

        // Warmup and Inquiry Functions
        let warmupInterval = null;
        let warmupTimeLeft = 0;

        let warmupAudioElements = {
            start: null,
            music1min: null,
            music4min: null,
            end: null
        };
        
        function initWarmupAudio() {
            warmupAudioElements.start = new Audio('/audio/warmup-start.mp3');
            warmupAudioElements.music1min = new Audio('/audio/warmup-music-1min.mp3');
            warmupAudioElements.music4min = new Audio('/audio/warmup-music-4min.mp3');
            warmupAudioElements.end = new Audio('/audio/warmup-end.mp3');
        }

        function showWarmupOverlay(duration = 60) {
            const warmupOverlay = document.getElementById('overlay-warmup');
            const warmupTimer = document.getElementById('warmup-timer');
            const warmupStatus = document.getElementById('warmup-status');
            
            if (!warmupOverlay || !warmupTimer || !warmupStatus) return;
            
            // Inicializar √°udios se ainda n√£o foram criados
            if (!warmupAudioElements.start) {
                initWarmupAudio();
            }
            
            warmupTimeLeft = duration;
            
            // Show overlay
            setOverlayVisibility(warmupOverlay, true);
            
            // Fase 1: PREPARANDO (tocar warmup-start.mp3)
            warmupTimer.textContent = formatSecondsToClock(warmupTimeLeft);
            warmupStatus.textContent = 'PREPARANDO...';
            
            console.log('[Stream] üî• Iniciando aquecimento - Fase 1: PREPARANDO');
            
            // Tocar √°udio de in√≠cio
            if (warmupAudioElements.start) {
                warmupAudioElements.start.currentTime = 0;
                warmupAudioElements.start.play()
                    .then(() => console.log('[Stream] üîä Tocando warmup-start.mp3'))
                    .catch(e => console.error('[Stream] ‚ùå Erro ao tocar warmup-start:', e));
            }
            
            // Aguardar ~3 segundos do √°udio de in√≠cio, depois iniciar cron√¥metro
            setTimeout(() => {
                console.log('[Stream] üî• Fase 2: EM ANDAMENTO - Iniciando cron√¥metro');
                warmupStatus.textContent = 'EM ANDAMENTO';
                
                // Tocar m√∫sica de fundo baseada na dura√ß√£o
                const musicAudio = duration === 60 ? warmupAudioElements.music1min : warmupAudioElements.music4min;
                if (musicAudio) {
                    musicAudio.currentTime = 0;
                    musicAudio.play()
                        .then(() => console.log(`[Stream] üîä Tocando m√∫sica de aquecimento (${duration}s)`))
                        .catch(e => console.error('[Stream] ‚ùå Erro ao tocar m√∫sica:', e));
                }
                
                // Start countdown
                warmupInterval = setInterval(() => {
                    warmupTimeLeft--;
                    warmupTimer.textContent = formatSecondsToClock(warmupTimeLeft);
                    
                    if (warmupTimeLeft <= 0) {
                        clearInterval(warmupInterval);
                        finishWarmup();
                    }
                }, 1000);
                
            }, 3000); // Aguarda 3 segundos para o √°udio de in√≠cio
        }
        
        function finishWarmup() {
            const warmupStatus = document.getElementById('warmup-status');
            const warmupOverlay = document.getElementById('overlay-warmup');
            
            console.log('[Stream] üî• Fase 3: FINALIZADO');
            if (warmupStatus) {
                warmupStatus.textContent = 'FINALIZADO';
            }
            
            // Parar m√∫sica de fundo
            if (warmupAudioElements.music1min) {
                warmupAudioElements.music1min.pause();
                warmupAudioElements.music1min.currentTime = 0;
            }
            if (warmupAudioElements.music4min) {
                warmupAudioElements.music4min.pause();
                warmupAudioElements.music4min.currentTime = 0;
            }
            
            // Tocar √°udio de fim
            if (warmupAudioElements.end) {
                warmupAudioElements.end.currentTime = 0;
                warmupAudioElements.end.play()
                    .then(() => console.log('[Stream] üîä Tocando warmup-end.mp3'))
                    .catch(e => console.error('[Stream] ‚ùå Erro ao tocar warmup-end:', e));
            }
            
            // Auto-hide ap√≥s 3 segundos
            setTimeout(() => {
                console.log('[Stream] üî• Ocultando overlay de aquecimento');
                hideWarmupOverlay();
            }, 3000);
        }

        function hideWarmupOverlay() {
            const warmupOverlay = document.getElementById('overlay-warmup');
            if (!warmupOverlay) return;
            
            if (warmupInterval) {
                clearInterval(warmupInterval);
                warmupInterval = null;
            }
            
            // Parar todos os √°udios
            Object.values(warmupAudioElements).forEach(audio => {
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }
            });
            
            setOverlayVisibility(warmupOverlay, false);
        }

        function showInquiryOverlay(gymnastName = '', reason = '', type = 'pending', duration = null) {
            console.log('[Stream] üîç showInquiryOverlay chamada com:', { gymnastName, reason, type, duration });
            
            const inquiryOverlay = document.getElementById('overlay-inquiry');
            const inquiryGymnast = document.getElementById('inquiry-gymnast');
            const inquiryReason = document.getElementById('inquiry-reason');
            const inquiryTitle = inquiryOverlay?.querySelector('.inquiry-title');
            
            console.log('[Stream] üîç Elementos encontrados:', {
                inquiryOverlay: !!inquiryOverlay,
                inquiryGymnast: !!inquiryGymnast,
                inquiryReason: !!inquiryReason,
                inquiryTitle: !!inquiryTitle
            });
            
            if (!inquiryOverlay) {
                console.error('[Stream] ‚ùå overlay-inquiry N√ÉO ENCONTRADO!');
                return;
            }
            
            // Atualizar t√≠tulo baseado no tipo
            if (inquiryTitle) {
                console.log('[Stream] üîç Atualizando t√≠tulo para tipo:', type);
                inquiryTitle.className = 'inquiry-title';
                if (type === 'rejected') {
                    inquiryTitle.textContent = 'RECURSO REJEITADO';
                    inquiryTitle.classList.add('inquiry-title--rejected');
                } else if (type === 'increased') {
                    inquiryTitle.textContent = 'NOTA AUMENTADA';
                    inquiryTitle.classList.add('inquiry-title--increased');
                } else if (type === 'decreased') {
                    inquiryTitle.textContent = 'NOTA DIMINU√çDA';
                    inquiryTitle.classList.add('inquiry-title--decreased');
                } else {
                    inquiryTitle.textContent = 'RECURSO EM AN√ÅLISE';
                }
                console.log('[Stream] ‚úÖ T√≠tulo atualizado:', inquiryTitle.textContent, '| Classes:', inquiryTitle.className);
            } else {
                console.error('[Stream] ‚ùå inquiry-title N√ÉO ENCONTRADO!');
            }
            
            if (inquiryGymnast) {
                inquiryGymnast.textContent = gymnastName || 'Ginasta';
                console.log('[Stream] ‚úÖ Nome da ginasta atualizado:', inquiryGymnast.textContent);
            }
            if (inquiryReason) {
                inquiryReason.textContent = reason || 'An√°lise de recurso em andamento...';
                console.log('[Stream] ‚úÖ Motivo atualizado:', inquiryReason.textContent);
            }
            
            console.log('[Stream] ‚úÖ Mostrando overlay...');
            setOverlayVisibility(inquiryOverlay, true);
            
            // Auto-hide se duration for fornecida
            if (duration) {
                console.log('[Stream] ‚è±Ô∏è Auto-hide agendado para', duration, 'ms');
                setTimeout(() => {
                    console.log('[Stream] ‚è±Ô∏è Executando auto-hide...');
                    hideInquiryOverlay();
                }, duration);
            }
        }

        function hideInquiryOverlay() {
            const inquiryOverlay = document.getElementById('overlay-inquiry');
            if (!inquiryOverlay) return;
            
            setOverlayVisibility(inquiryOverlay, false);
        }

        function showReceptionOverlay(flag = '', text = 'TEAM', duration = 5000, countryCode = null) {
            console.log('[Stream] RECEPTION V4.0 COM IMAGEM:', { flag, text, countryCode });
            
            const receptionOverlay = document.getElementById('overlay-reception');
            const receptionFlag = document.getElementById('reception-flag');
            const receptionText = document.getElementById('reception-text');
            
            if (!receptionOverlay || !receptionFlag || !receptionText) {
                console.error('[Stream] Elementos reception nao encontrados');
                return;
            }
            
            // Usar IMAGEM PNG ao inv√©s de emoji
            if (countryCode) {
                const countryInfo = getCountryInfo(countryCode);
                const code2Letter = countryInfo.code || countryCode.toLowerCase().substring(0, 2);
                receptionFlag.innerHTML = `<img src="https://flagcdn.com/w320/${code2Letter}.png" alt="Bandeira ${countryCode}" style="width: 4rem; height: auto; filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.5));">`;
                console.log('[Stream] Bandeira PNG inserida para:', code2Letter);
            } else {
                receptionFlag.innerHTML = '';
            }
            
            // Atualizar texto com lista de ginastas
            if (countryCode && dataState.gymnasts) {
                const countryGymnasts = dataState.gymnasts
                    .filter(g => g.country === countryCode)
                    .map(g => g.name)
                    .sort();
                
                if (countryGymnasts.length > 0) {
                    receptionText.innerHTML = `<strong>${text}</strong><br><span style="font-size: 1.5rem; font-weight: 500;">${countryGymnasts.join(' ‚Ä¢ ')}</span>`;
                } else {
                    receptionText.textContent = text;
                }
            } else {
                receptionText.textContent = text;
            }
            
            setOverlayVisibility(receptionOverlay, true);
            
            setTimeout(() => {
                setOverlayVisibility(receptionOverlay, false);
            }, duration);
        }

        function showWelcomeOverlay(duration = 6000) {
            console.log('[Stream] üëã‚ú® VERS√ÉO NOVA COM HTML ENTITIES - showWelcomeOverlay CHAMADA! Duration:', duration);
            const welcomeOverlay = document.getElementById('overlay-welcome');
            console.log('[Stream] üëã welcomeOverlay element:', welcomeOverlay);
            if (!welcomeOverlay) {
                console.error('[Stream] ‚ùå overlay-welcome N√ÉO ENCONTRADO!');
                return;
            }
            
            // Show overlay
            console.log('[Stream] üëã Definindo overlay como vis√≠vel...');
            setOverlayVisibility(welcomeOverlay, true);
            
            // Auto-hide after duration
            setTimeout(() => {
                console.log('[Stream] üëã Ocultando overlay ap√≥s', duration, 'ms');
                setOverlayVisibility(welcomeOverlay, false);
            }, duration);
        }

        function showAnthemOverlay(duration = 8000) {
            console.log('[Stream] ‚úÖ VERSAO 5.0 COM IMAGEM CDN - TIMESTAMP:', new Date().toISOString());
            const anthemOverlay = document.getElementById('overlay-anthem');
            const anthemFlag = document.getElementById('anthem-flag');
            
            if (!anthemOverlay) {
                console.error('[Stream] ‚ùå anthem overlay nao encontrado');
                return;
            }
            
            if (!anthemFlag) {
                console.error('[Stream] ‚ùå anthem-flag element nao encontrado');
                return;
            }
            
            // NOVA ESTRATEGIA: Usar IMAGEM PNG ao inv√©s de emoji
            anthemFlag.innerHTML = '<img src="https://flagcdn.com/w320/br.png" alt="Bandeira do Brasil" style="width: 8rem; height: auto; filter: drop-shadow(0 8px 24px rgba(0, 0, 0, 0.6));">';
            console.log('[Stream] ‚úÖ Bandeira PNG inserida via innerHTML');
            
            setOverlayVisibility(anthemOverlay, true);
            
            setTimeout(() => {
                setOverlayVisibility(anthemOverlay, false);
            }, duration);
        }

        function showInstructionsOverlay(duration = 5000) {
            console.log('[Stream] ‚ö†Ô∏è Exibindo overlay de Instru√ß√µes Finais');
            const instructionsOverlay = document.getElementById('overlay-instructions');
            if (!instructionsOverlay) return;
            
            // Show overlay
            setOverlayVisibility(instructionsOverlay, true);
            
            // Auto-hide after duration
            setTimeout(() => {
                setOverlayVisibility(instructionsOverlay, false);
            }, duration);
        }

        // ========== ‚ú® NOVO: SCORE REVEAL OVERLAY ==========
        
        let scoreRevealAnimationTimeout = null;
        
        /**
         * Calcula quais 5 posi√ß√µes mostrar no ranking baseado na posi√ß√£o atual da ginasta
         * @param {number} currentRank - Rank atual da ginasta (1-based)
         * @param {number} totalGymnasts - Total de ginastas no ranking
         * @returns {object} - { startRank, endRank } - Intervalo de ranks a mostrar
         */
        function calculateRankingWindow(currentRank, totalGymnasts) {
            // Sempre mostrar 5 posi√ß√µes ao redor da ginasta atual
            const windowSize = 5;
            
            // Se estiver nas primeiras posi√ß√µes (1¬∫, 2¬∫, 3¬∫)
            if (currentRank <= 3) {
                return { startRank: 1, endRank: Math.min(windowSize, totalGymnasts) };
            }
            
            // Se estiver nas √∫ltimas posi√ß√µes
            if (currentRank >= totalGymnasts - 2) {
                return { 
                    startRank: Math.max(1, totalGymnasts - windowSize + 1), 
                    endRank: totalGymnasts 
                };
            }
            
            // Caso geral: centralizar a ginasta atual
            // Se est√° em 8¬∫, mostrar 6¬∫ ao 10¬∫
            const offset = Math.floor(windowSize / 2);
            return {
                startRank: currentRank - offset,
                endRank: currentRank - offset + windowSize - 1
            };
        }

        /**
         * Atualiza o overlay de Score Reveal com dados da ginasta, ranking e scores
         * @param {object} gymnastData - Dados da ginasta (id, name, country, etc)
         * @param {string} phase - Fase da competi√ß√£o
         * @param {string} apparatus - Aparelho (vt, ub, bb, fx)
         * @param {object} scoreData - Dados de score (d, e, p, total) ou para VT2: {vt1, vt2, isVT2}
         * @param {array} rankingList - Lista completa do ranking ordenada
         * @param {number} currentRank - Posi√ß√£o atual da ginasta no ranking
         * @param {boolean} isTeamRanking - Se true, rankingList cont√©m equipes (pa√≠ses), n√£o ginastas
         */
        function showScoreRevealOverlay(gymnastData, phase, apparatus, scoreData, rankingList, currentRank, isTeamRanking = false) {
            console.log('[Stream] ‚ú® Mostrando Score Reveal Overlay:', { gymnastData, phase, apparatus, scoreData, currentRank, isTeamRanking });
            
            const overlay = document.getElementById('overlay-score-reveal');
            if (!overlay) {
                console.error('[Stream] ‚ùå overlay-score-reveal n√£o encontrado!');
                return;
            }
            
            // Detectar modo VT2
            const isVT2Mode = scoreData.isVT2 === true;
            
            // Atualizar CENTRO: Card Principal
            const countryInfo = getCountryInfo(gymnastData.country);
            const nameParts = splitNameParts(gymnastData.name);
            
            applyFlagImage(
                document.getElementById('reveal-flag-img'),
                document.getElementById('reveal-flag-emoji'),
                countryInfo.code,
                countryInfo.emoji
            );
            
            document.getElementById('reveal-country').textContent = gymnastData.country?.toUpperCase() || 'COUNTRY';
            document.getElementById('reveal-firstname').textContent = nameParts.firstName || gymnastData.firstName || 'First';
            document.getElementById('reveal-lastname').textContent = nameParts.lastName || gymnastData.lastName || 'LASTNAME';
            document.getElementById('reveal-apparatus-icon').textContent = apparatus.toUpperCase();
            
            // Atualizar label e valor do score
            const scoreLabel = document.getElementById('reveal-score-label');
            const displayTotal = isVT2Mode ? scoreData.average : scoreData.total;
            
            if (scoreLabel) {
                scoreLabel.textContent = isVT2Mode ? 'M√âDIA' : 'TOTAL';
            }
            
            document.getElementById('reveal-total').textContent = formatScoreValue(displayTotal, 3);
            
            // Ranking: ocultar para Team Final, mostrar para outras fases
            const rankElement = document.getElementById('reveal-rank');
            if (currentRank !== null) {
                rankElement.textContent = `#${currentRank}`;
                rankElement.style.display = 'block';
            } else {
                // Team Final: n√£o mostramos ranking individual
                rankElement.style.display = 'none';
            }
            
            // Atualizar DIREITA: Breakdown D, E, P
            const singleBoxes = document.getElementById('reveal-boxes-single');
            const vt2Boxes = document.getElementById('reveal-boxes-vt2');
            const revealContainer = document.querySelector('.score-reveal-container');
            const breakdownTitle = document.getElementById('breakdown-title');
            
            if (isVT2Mode) {
                // Modo VT2: Mostrar dois saltos (sem m√©dia no breakdown)
                console.log('[Stream] üîç Before visibility changes:', {
                    singleBoxesVisibility: singleBoxes?.style.visibility,
                    vt2BoxesVisibility: vt2Boxes?.style.visibility
                });
                
                // ‚úÖ Usar grid padr√£o (boxes VT2 compactos cabem em 25%)
                if (revealContainer) {
                    revealContainer.style.gridTemplateColumns = '20% 50% 30%'; // üéØ Mais espa√ßo √† direita
                    console.log('[Stream] üìê Grid VT2: 20% 50% 30%');
                }
                
                // üõë GEMINI FIX: Esconder t√≠tulo BREAKDOWN que ocupa espa√ßo
                if (breakdownTitle) breakdownTitle.style.display = 'none';
                
                // üõë SOLU√á√ÉO EMERG√äNCIA GEMINI: display remove do layout, visibility n√£o!
                if (singleBoxes) singleBoxes.style.display = 'none';
                if (vt2Boxes) {
                    vt2Boxes.style.display = 'flex';
                    console.log('[Stream] ‚úÖ VT2 Boxes exibidos com display:flex');
                }
                
                console.log('[Stream] üîç After visibility changes:', {
                    singleBoxesVisibility: singleBoxes?.style.visibility,
                    vt2BoxesVisibility: vt2Boxes?.style.visibility
                });
                
                console.log('[Stream] üîç VT2 Mode - Populating breakdown with:', {
                    vt1: scoreData.vt1,
                    vt2: scoreData.vt2
                });
                
                console.log('[Stream] üîç VT2 Elements exist?', {
                    'reveal-vt1-d': !!document.getElementById('reveal-vt1-d'),
                    'reveal-vt1-e': !!document.getElementById('reveal-vt1-e'),
                    'reveal-vt1-p': !!document.getElementById('reveal-vt1-p'),
                    'reveal-vt1-total': !!document.getElementById('reveal-vt1-total'),
                    'reveal-vt2-d': !!document.getElementById('reveal-vt2-d'),
                    'reveal-vt2-e': !!document.getElementById('reveal-vt2-e'),
                    'reveal-vt2-p': !!document.getElementById('reveal-vt2-p'),
                    'reveal-vt2-total': !!document.getElementById('reveal-vt2-total'),
                    'vt2Boxes': !!vt2Boxes,
                    'vt2Boxes.style.display': vt2Boxes?.style.display
                });
                
                // VT1
                document.getElementById('reveal-vt1-d').textContent = formatScoreValue(scoreData.vt1.d, 1);
                document.getElementById('reveal-vt1-e').textContent = formatScoreValue(scoreData.vt1.e, 3);
                document.getElementById('reveal-vt1-p').textContent = formatScoreValue(scoreData.vt1.p, 1);
                document.getElementById('reveal-vt1-total').textContent = formatScoreValue(scoreData.vt1.total, 3);
                
                console.log('[Stream] üîç VT1 elements updated:', {
                    d: document.getElementById('reveal-vt1-d').textContent,
                    e: document.getElementById('reveal-vt1-e').textContent,
                    p: document.getElementById('reveal-vt1-p').textContent,
                    total: document.getElementById('reveal-vt1-total').textContent
                });
                
                // VT2
                document.getElementById('reveal-vt2-d').textContent = formatScoreValue(scoreData.vt2.d, 1);
                document.getElementById('reveal-vt2-e').textContent = formatScoreValue(scoreData.vt2.e, 3);
                document.getElementById('reveal-vt2-p').textContent = formatScoreValue(scoreData.vt2.p, 1);
                document.getElementById('reveal-vt2-total').textContent = formatScoreValue(scoreData.vt2.total, 3);
                
                console.log('[Stream] üîç VT2 elements updated:', {
                    d: document.getElementById('reveal-vt2-d').textContent,
                    e: document.getElementById('reveal-vt2-e').textContent,
                    p: document.getElementById('reveal-vt2-p').textContent,
                    total: document.getElementById('reveal-vt2-total').textContent
                });
                
            } else {
                // Modo single apparatus (VT1, UB, BB, FX)
                
                // ‚úÖ Restaurar grid padr√£o
                if (revealContainer) {
                    revealContainer.style.gridTemplateColumns = '20% 50% 30%'; // üéØ Mesmo grid para consist√™ncia
                    console.log('[Stream] üìê Grid restaurado para single: 20% 50% 30%');
                }
                
                // üõë GEMINI FIX: Mostrar t√≠tulo BREAKDOWN de volta
                if (breakdownTitle) breakdownTitle.style.display = 'block';
                
                // üõë SOLU√á√ÉO EMERG√äNCIA GEMINI: display remove do layout, visibility n√£o!
                if (singleBoxes) singleBoxes.style.display = 'flex';
                if (vt2Boxes) vt2Boxes.style.display = 'none';
                
                document.getElementById('reveal-d').textContent = formatScoreValue(scoreData.d, 1);
                document.getElementById('reveal-e').textContent = formatScoreValue(scoreData.e, 3);
                document.getElementById('reveal-p').textContent = formatScoreValue(scoreData.p, 1);
                
                // Atualizar cor do box de Penalty
                const pBox = document.getElementById('reveal-p-box');
                if (pBox) {
                    const hasPenalty = scoreData.p && parseFloat(scoreData.p) > 0;
                    pBox.dataset.hasPenalty = hasPenalty ? 'true' : 'false';
                }
            }
            
            // Atualizar ESQUERDA: Ranking (apenas para fases individuais)
            if (currentRank !== null && rankingList && rankingList.length > 0) {
                updateScoreRevealRanking(rankingList, currentRank, isTeamRanking ? gymnastData.country : gymnastData.id, isTeamRanking);
            } else {
                // Team Final ou sem ranking: limpar cards de ranking
                const rankingCards = document.getElementById('ranking-cards');
                if (rankingCards) rankingCards.innerHTML = '';
            }
            
            // Mostrar overlay
            setOverlayVisibility(overlay, true);
            
            console.log('[Stream] üîç Overlay visibility set to TRUE');
            console.log('[Stream] üîç Overlay dataset.visible:', overlay.dataset.visible);
            console.log('[Stream] üîç VT2 boxes computed style:', {
                display: window.getComputedStyle(vt2Boxes).display,
                visibility: window.getComputedStyle(vt2Boxes).visibility,
                opacity: window.getComputedStyle(vt2Boxes).opacity
            });
            
            // Ap√≥s 2 segundos, animar mudan√ßa de posi√ß√£o no ranking (se necess√°rio)
            if (scoreRevealAnimationTimeout) {
                clearTimeout(scoreRevealAnimationTimeout);
            }
            
            scoreRevealAnimationTimeout = setTimeout(() => {
                animateRankingPositionChange(rankingList, currentRank, gymnastData.id);
            }, 2000);
        }

        /**
         * Atualiza os cards de ranking no lado esquerdo
         * @param {array} rankingList - Lista de resultados (ginastas ou equipes)
         * @param {number} currentRank - Posi√ß√£o atual
         * @param {string} currentId - ID da ginasta ou c√≥digo do pa√≠s
         * @param {boolean} isTeamRanking - Se true, mostra ranking de equipes (pa√≠ses)
         */
        function updateScoreRevealRanking(rankingList, currentRank, currentId, isTeamRanking = false) {
            const rankingCards = document.getElementById('ranking-cards');
            if (!rankingCards) return;
            
            console.log('[Stream] üèÜ Atualizando ranking:', { isTeamRanking, currentId, currentRank, rankingList });
            
            // Calcular janela de exibi√ß√£o (5 posi√ß√µes)
            const { startRank, endRank } = calculateRankingWindow(currentRank, rankingList.length);
            
            // Limpar cards existentes
            rankingCards.innerHTML = '';
            
            // Criar cards para as posi√ß√µes vis√≠veis
            for (let i = startRank; i <= endRank; i++) {
                const item = rankingList[i - 1]; // Array √© 0-indexed
                if (!item) continue;
                
                const card = document.createElement('div');
                card.className = 'ranking-card';
                
                if (isTeamRanking) {
                    // Ranking de EQUIPES (Team Final)
                    // Marcar card do pa√≠s atual
                    if (item.country === currentId) {
                        card.classList.add('current');
                    }
                    
                    card.dataset.rank = i;
                    card.dataset.country = item.country;
                    
                    // Buscar score da equipe
                    let scoreValue = item.total || item.score || item.teamTotal || 0;
                    
                    // Nome do pa√≠s
                    const countryInfo = getCountryInfo(item.country);
                    const displayName = countryInfo.code || item.country || 'PA√çS';
                    const resolvedFlagCode = countryInfo.code || (window.getCountryCode ? window.getCountryCode(item.country) : null);
                    const resolvedFlagEmoji = countryInfo.emoji || (window.getCountryFlag ? window.getCountryFlag(item.country) : 'üè≥Ô∏è');
                    const flagMarkup = getFlagMarkup({ flagCode: resolvedFlagCode, flagEmoji: resolvedFlagEmoji }, 'w80');
                    card.innerHTML = `
                        <div class="ranking-position">#${i}</div>
                        <div class="ranking-info">
                            <div class="ranking-flag">${flagMarkup}</div>
                            <div class="ranking-name">${displayName}</div>
                        </div>
                        <div class="ranking-score">${formatScoreValue(scoreValue, 3)}</div>
                    `;
                } else {
                    // Ranking INDIVIDUAL (qualifiers, finais de aparelho, AA)
                    const gymnast = item;
                    
                    // Marcar card da ginasta atual
                    if (gymnast.id === currentId) {
                        card.classList.add('current');
                    }
                    
                    // Adicionar data attribute para transi√ß√µes posteriores
                    card.dataset.rank = i;
                    card.dataset.gymnastId = gymnast.id;
                    
                    // Buscar score correto (priorizar campos espec√≠ficos)
                    let scoreValue = 0;
                    if (gymnast.apparatusScore !== undefined && gymnast.apparatusScore !== null) {
                        scoreValue = gymnast.apparatusScore;
                    } else if (gymnast.totalScore !== undefined && gymnast.totalScore !== null) {
                        scoreValue = gymnast.totalScore;
                    } else if (gymnast.aaTotal !== undefined && gymnast.aaTotal !== null) {
                        scoreValue = gymnast.aaTotal;
                    } else if (gymnast.total !== undefined && gymnast.total !== null) {
                        scoreValue = gymnast.total;
                    } else if (gymnast.score !== undefined && gymnast.score !== null) {
                        scoreValue = gymnast.score;
                    }
                    
                    // Nome formatado
                    const displayName = gymnast.name || gymnast.displayName || gymnast.firstName || 'Ginasta';
                    
                    const countryInfo = getCountryInfo(gymnast.country);
                    const indFlagMarkup = getFlagMarkup({ flagCode: countryInfo.code, flagEmoji: countryInfo.emoji }, 'w80');
                    card.innerHTML = `
                        <div class="ranking-position">#${i}</div>
                        <div class="ranking-info">
                            <div class="ranking-flag">${indFlagMarkup}</div>
                            <div class="ranking-name">${displayName}</div>
                        </div>
                        <div class="ranking-score">${formatScoreValue(scoreValue, 3)}</div>
                    `;
                }
                
                rankingCards.appendChild(card);
            }
        }

        /**
         * Anima a mudan√ßa de posi√ß√£o da ginasta no ranking (estilo F1)
         */
        function animateRankingPositionChange(rankingList, newRank, gymnastId) {
            const rankingCards = document.getElementById('ranking-cards');
            if (!rankingCards) return;
            
            console.log('[Stream] üèéÔ∏è Animando mudan√ßa de posi√ß√£o para:', newRank);
            
            // Calcular nova janela de exibi√ß√£o
            const { startRank, endRank } = calculateRankingWindow(newRank, rankingList.length);
            
            // Obter cards atuais
            const currentCards = Array.from(rankingCards.querySelectorAll('.ranking-card'));
            
            // Preparar novos cards
            const newCardsData = [];
            for (let i = startRank; i <= endRank; i++) {
                const gymnast = rankingList[i - 1];
                if (gymnast) {
                    // Buscar score correto (priorizar campos espec√≠ficos)
                    let scoreValue = 0;
                    if (gymnast.apparatusScore !== undefined && gymnast.apparatusScore !== null) {
                        scoreValue = gymnast.apparatusScore;
                    } else if (gymnast.totalScore !== undefined && gymnast.totalScore !== null) {
                        scoreValue = gymnast.totalScore;
                    } else if (gymnast.aaTotal !== undefined && gymnast.aaTotal !== null) {
                        scoreValue = gymnast.aaTotal;
                    } else if (gymnast.total !== undefined && gymnast.total !== null) {
                        scoreValue = gymnast.total;
                    } else if (gymnast.score !== undefined && gymnast.score !== null) {
                        scoreValue = gymnast.score;
                    }
                    
                    newCardsData.push({
                        rank: i,
                        id: gymnast.id,
                        name: gymnast.name || gymnast.displayName || 'Ginasta',
                        score: scoreValue,
                        isCurrent: gymnast.id === gymnastId
                    });
                }
            }
            
            // Fade out cards que v√£o sair
            currentCards.forEach(card => {
                const cardRank = parseInt(card.dataset.rank);
                const shouldRemove = cardRank < startRank || cardRank > endRank;
                
                if (shouldRemove) {
                    card.style.transition = 'opacity 300ms ease, transform 300ms ease';
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(-60px)';
                }
            });
            
            // Aguardar fade out antes de atualizar
            setTimeout(() => {
                // Limpar e reconstruir
                rankingCards.innerHTML = '';
                
                newCardsData.forEach((data, index) => {
                    const card = document.createElement('div');
                    card.className = 'ranking-card';
                    
                    if (data.isCurrent) {
                        card.classList.add('current');
                    }
                    
                    card.dataset.rank = data.rank;
                    card.dataset.gymnastId = data.id;
                    
                    card.innerHTML = `
                        <div class="ranking-position">#${data.rank}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${data.name}</div>
                        </div>
                        <div class="ranking-score">${formatScoreValue(data.score, 3)}</div>
                    `;
                    
                    rankingCards.appendChild(card);
                    
                    // For√ßar reflow
                    void card.offsetWidth;
                    
                    // Animar entrada com delay escalonado
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateX(0)';
                    }, index * 80);
                });
            }, 300);
        }

        /**
         * Esconde o overlay de Score Reveal
         */
        function hideScoreRevealOverlay() {
            const overlay = document.getElementById('overlay-score-reveal');
            if (!overlay) return;
            
            setOverlayVisibility(overlay, false);
            
            if (scoreRevealAnimationTimeout) {
                clearTimeout(scoreRevealAnimationTimeout);
                scoreRevealAnimationTimeout = null;
            }
        }

        function hideAllOverlays() {
            console.log('[Stream] üö´ Ocultando todos os overlays');
            
            // Hide warmup
            hideWarmupOverlay();
            
            // Hide inquiry
            hideInquiryOverlay();
            
            // Hide score reveal
            hideScoreRevealOverlay();
            
            // Hide reception
            const receptionOverlay = document.getElementById('overlay-reception');
            if (receptionOverlay) setOverlayVisibility(receptionOverlay, false);
            
            // Hide welcome
            const welcomeOverlay = document.getElementById('overlay-welcome');
            if (welcomeOverlay) setOverlayVisibility(welcomeOverlay, false);
            
            // Hide anthem
            const anthemOverlay = document.getElementById('overlay-anthem');
            if (anthemOverlay) setOverlayVisibility(anthemOverlay, false);
            
            // Hide instructions
            const instructionsOverlay = document.getElementById('overlay-instructions');
            if (instructionsOverlay) setOverlayVisibility(instructionsOverlay, false);

            hidePodiumOverlays();
            stopPodiumAudio();
            
            // Hide timer overlay
            if (overlayElements.timer && overlayElements.timer.root) {
                setOverlayVisibility(overlayElements.timer.root, false);
            }
            
            // Hide scorecard
            if (overlayElements.scorecard && overlayElements.scorecard.root) {
                setOverlayVisibility(overlayElements.scorecard.root, false);
            }
            
            // Hide lists
            if (overlayElements.startlistMain && overlayElements.startlistMain.root) {
                setOverlayVisibility(overlayElements.startlistMain.root, false);
            }
            if (overlayElements.results && overlayElements.results.root) {
                setOverlayVisibility(overlayElements.results.root, false);
            }
        }

        function updateWarmupOverlay(data = {}) {
            const warmupOverlay = document.getElementById('overlay-warmup');
            const warmupTimer = document.getElementById('warmup-timer');
            const warmupStatus = document.getElementById('warmup-status');
            
            if (!warmupOverlay || !warmupTimer || !warmupStatus) return;
            
            const visible = !!(data && data.visible);
            setOverlayVisibility(warmupOverlay, visible);
            if (!visible) {
                if (warmupInterval) {
                    clearInterval(warmupInterval);
                    warmupInterval = null;
                }
                return;
            }
            
            // Calculate time remaining based on start timestamp
            let timeRemaining = data.timeRemaining || 0;
            if (data.startTimestamp && data.totalTime) {
                const elapsed = Math.floor((Date.now() - data.startTimestamp) / 1000);
                timeRemaining = Math.max(0, data.totalTime - elapsed);
            }
            
            // Update display
            warmupTimer.textContent = formatSecondsToClock(timeRemaining);
            
            if (data.status === 'RUNNING' && timeRemaining > 0) {
                warmupStatus.textContent = 'EM ANDAMENTO';
            } else if (timeRemaining <= 0) {
                warmupStatus.textContent = 'FINALIZADO';
            } else {
                warmupStatus.textContent = data.status || 'AGUARDANDO';
            }
        }

        function updateInquiryOverlay(data = {}) {
            const inquiryOverlay = document.getElementById('overlay-inquiry');
            const inquiryGymnast = document.getElementById('inquiry-gymnast');
            const inquiryReason = document.getElementById('inquiry-reason');
            const inquiryStatus = document.getElementById('inquiry-status');
            
            if (!inquiryOverlay) return;
            
            const visible = !!(data && data.visible);
            setOverlayVisibility(inquiryOverlay, visible);
            if (!visible) return;
            
            if (inquiryGymnast) inquiryGymnast.textContent = data.gymnastName || 'Ginasta';
            if (inquiryReason) inquiryReason.textContent = data.reason || 'An√°lise de recurso em andamento...';
            if (inquiryStatus) {
                const statusText = {
                    'PENDING': 'EM AN√ÅLISE',
                    'ACCEPTED': 'ACEITO',
                    'REJECTED': 'REJEITADO'
                }[data.status] || 'EM AN√ÅLISE';
                inquiryStatus.textContent = statusText;
            }
        }

        /**
         * ‚ú® NOVO: Renderiza o overlay central de listas (Start List / Resultados)
         * Esta fun√ß√£o recebe dados pr√©-formatados do stcontrol e os renderiza.
         */
        function updateListCenter(data = {}) {
            const overlay = document.getElementById('overlay-list-center');
            if (!overlay) return;

            const visible = !!(data && data.visible);
            setOverlayVisibility(overlay, visible);
            if (!visible) return;

            // Preencher Cabe√ßalho
            const titleEl = document.getElementById('list-center-title');
            const subtitleEl = document.getElementById('list-center-subtitle');
            const pageEl = document.getElementById('list-center-page');
            
            if (titleEl) titleEl.textContent = data.title || 'Resultados';
            if (subtitleEl) subtitleEl.textContent = data.subtitle || '';
            
            if (pageEl) {
                if (data.page) {
                    pageEl.textContent = data.page;
                    pageEl.style.display = 'block';
                } else {
                    pageEl.style.display = 'none';
                }
            }

            // Preencher Itens da Lista
            const listEl = document.getElementById('list-center-items');
            if (!listEl) return;
            
            listEl.innerHTML = ''; // Limpar lista anterior para a anima√ß√£o em cascata

            if (!data.items || data.items.length === 0) {
                listEl.innerHTML = '<li style="opacity: 1; transform: none; grid-template-columns: 1fr; text-align: center; justify-content: center;">Aguardando dados...</li>';
                return;
            }

            data.items.forEach((item, index) => {
                const li = document.createElement('li');
                
                // Rank
                const rankEl = document.createElement('span');
                rankEl.className = 'list-item-rank';
                rankEl.textContent = item.rank;
                
                // Bandeira (com fallback para emoji)
                const flagEl = document.createElement('div');
                flagEl.className = 'list-item-flag';
                const flagImg = document.createElement('img');
                const flagEmoji = document.createElement('span');
                // Usa a fun√ß√£o applyFlagImage existente
                applyFlagImage(flagImg, flagEmoji, item.flagCode, item.flagEmoji);
                flagEl.appendChild(flagImg);
                flagEl.appendChild(flagEmoji);
                
                // Nome
                const nameEl = document.createElement('span');
                nameEl.className = 'list-item-name';
                nameEl.textContent = item.name;
                
                // Status (Q)
                const qStatusEl = document.createElement('span');
                qStatusEl.className = 'list-item-q-status';
                qStatusEl.textContent = item.qStatus || '';
                
                // Score
                const scoreEl = document.createElement('span');
                scoreEl.className = 'list-item-score';
                scoreEl.textContent = item.score || '';

                li.appendChild(rankEl);
                li.appendChild(flagEl);
                li.appendChild(nameEl);
                li.appendChild(qStatusEl);
                li.appendChild(scoreEl);
                
                listEl.appendChild(li);
            });
        }

        function getTimerColor(apparatus, status, elapsedSeconds) {
            // VT n√£o tem cron√¥metro, s√≥ cores baseadas no status
            if (apparatus === 'VT') {
                if (status === 'WAIT') return 'red';
                if (status === 'GO') return 'green';
                if (status === 'STOP') return 'purple';
                return 'red'; // padr√£o
            }
            
            // Para FX e BB
            if (apparatus === 'FX' || apparatus === 'BB') {
                if (status === 'WAIT') return 'red';
                if (status === 'STOP') return 'purple';
                if (status === 'GO') {
                    // GO: verde at√© 1:20 (80s), laranja at√© 1:31 (91s), vermelho depois
                    if (elapsedSeconds < 80) return 'green';
                    if (elapsedSeconds < 91) return 'orange';
                    return 'red';
                }
                return 'red';
            }
            
            // Para UB
            if (apparatus === 'UB') {
                if (status === 'WAIT') return 'red';
                if (status === 'STOP') return 'purple';
                if (status === 'GO') {
                    // GO: verde at√© 0:50 (50s), laranja at√© 1:00 (60s), vermelho depois
                    if (elapsedSeconds < 50) return 'green';
                    if (elapsedSeconds < 60) return 'orange';
                    return 'red';
                }
                return 'red';
            }
            
            // Padr√£o para outros aparelhos
            return 'red';
        }

        function updateTimerOverlay(data = {}) {
            const nodes = overlayElements.timer;
            if (!nodes?.root) return;

            console.log('[Stream] ‚è±Ô∏è updateTimerOverlay called with data:', data);
            
            const visible = !!(data && data.visible);
            console.log('[Stream] ‚è±Ô∏è Timer visible:', visible);
            
            setOverlayVisibility(nodes.root, visible);
            if (!visible) {
                // Remover atributo de cor quando oculto
                nodes.root.removeAttribute('data-timer-color');
                console.log('[Stream] ‚è±Ô∏è Timer hidden');
                return;
            }

            console.log('[Stream] ‚è±Ô∏è Timer showing - applying data...');
            
            const apparatusLabel = (data.apparatus || 'FX').toString().toUpperCase();
            const activeVaultNum = data.activeVaultNum || 1;
            
            // Para VT, mostrar VT1 ou VT2
            if (nodes.apparatus) {
                if (apparatusLabel === 'VT') {
                    nodes.apparatus.textContent = `VT${activeVaultNum}`;
                } else {
                    nodes.apparatus.textContent = apparatusLabel;
                }
            }

            const elapsedSeconds = data.elapsedSeconds || 0;
            const formattedTime = data.formatted || formatSecondsToClock(elapsedSeconds);
            
            // Para VT: esconder cron√¥metro, mostrar DV
            const isVault = apparatusLabel === 'VT';
            if (nodes.display) {
                if (isVault) {
                    // Para VT, mostrar "DV 5.6" no lugar do cron√¥metro
                    // Usar dvVt1 ou dvVt2 baseado em activeVaultNum
                    const currentDV = activeVaultNum === 1 ? data.dvVt1 : data.dvVt2;
                    console.log('[Stream] üéØ DV Debug:', { activeVaultNum, dvVt1: data.dvVt1, dvVt2: data.dvVt2, currentDV });
                    if (currentDV !== undefined && currentDV !== null && currentDV !== 0) {
                        nodes.display.textContent = `DV ${formatScoreValue(currentDV, 1)}`;
                    } else {
                        nodes.display.textContent = 'DV --';
                    }
                } else {
                    // Para outros aparelhos, mostrar cron√¥metro normal
                    nodes.display.textContent = formattedTime;
                }
            }

            const status = (data.status || 'WAIT').toString().toUpperCase();
            if (nodes.status) {
                nodes.status.dataset.status = status;
                nodes.status.textContent = status;
            }
            
            // Calcular e aplicar cor do timer
            const timerColor = getTimerColor(apparatusLabel, status, elapsedSeconds);
            nodes.root.dataset.timerColor = timerColor;
            console.log('[Stream] ‚è±Ô∏è Timer color:', { apparatus: apparatusLabel, status, elapsedSeconds, color: timerColor });

            // DV container - para VT, esconder pois j√° mostramos no display
            if (nodes.dvContainer && nodes.dv) {
                if (isVault) {
                    nodes.dvContainer.style.display = 'none';
                } else if (data.dv !== undefined && data.dv !== null && data.dv !== '') {
                    nodes.dvContainer.style.display = '';
                    nodes.dv.textContent = formatScoreValue(data.dv, 2);
                } else {
                    nodes.dvContainer.style.display = 'none';
                    nodes.dv.textContent = '--';
                }
            }

            if (nodes.warning) {
                // VT n√£o tem warning
                if (isVault) {
                    nodes.warning.dataset.active = 'false';
                } else {
                    nodes.warning.dataset.active = data.warning ? 'true' : 'false';
                }
            }
        }

        function updateScorecardOverlay(data = {}) {
            const nodes = overlayElements.scorecard;
            if (!nodes?.root) return;

            const visible = !!(data && data.visible);
            setOverlayVisibility(nodes.root, visible);
            if (!visible) return;

            const lastName = data.gymnastLastName || data.lastName || data.surname || '';
            if (nodes.lastname) nodes.lastname.textContent = lastName ? String(lastName).toUpperCase() : '-';

            const firstName = data.gymnastName || data.firstName || data.name || '';
            if (nodes.firstname) nodes.firstname.textContent = firstName || '-';

            const countryLabel = resolveListCountry(data);
            if (nodes.country) nodes.country.textContent = countryLabel || '---';

            applyFlagImage(nodes.flagImg, nodes.flagEmoji, data.countryCode, data.countryFlagEmoji);

            if (nodes.d) nodes.d.textContent = formatScoreValue(data.dScore, 3);
            if (nodes.e) nodes.e.textContent = formatScoreValue(data.eScore, 3);
            if (nodes.p) nodes.p.textContent = formatScoreValue(data.pScore, 3);
            const totalValue = data.totalScore ?? data.total ?? data.score;
            if (nodes.total) nodes.total.textContent = formatScoreValue(totalValue, 3);

            if (nodes.rank) {
                const rankValue = data.rank ?? data.position ?? data.place;
                if (rankValue === null || rankValue === undefined || rankValue === '') {
                    nodes.rank.dataset.visible = 'false';
                    nodes.rank.textContent = '';
                } else {
                    nodes.rank.dataset.visible = 'true';
                    nodes.rank.textContent = `#${rankValue}`;
                }
            }
        }

        function updateMusicOverlay(data = {}) {
            const nodes = overlayElements.music;
            if (!nodes?.root) return;

            const visible = !!(data && data.visible);
            setOverlayVisibility(nodes.root, visible);
            if (!visible) return;

            const status = (data.status || 'WAIT').toString().toUpperCase();
            if (nodes.status) {
                nodes.status.dataset.status = status;
                nodes.status.textContent = status;
            }

            if (nodes.label) {
                const labelText = data.label ? String(data.label).toUpperCase() : 'M√öSICA';
                nodes.label.textContent = labelText;
            }

            if (nodes.updated) {
                if (data.timestamp) {
                    const stamp = typeof data.timestamp === 'number' ? data.timestamp : Date.parse(data.timestamp);
                    if (!Number.isNaN(stamp)) {
                        const formatted = new Date(stamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        nodes.updated.textContent = `Atualizado ${formatted}`;
                    } else {
                        nodes.updated.textContent = '';
                    }
                }
            }
        }

        function updateListOverlay(nodes, data = {}, options = {}) {
            if (!nodes?.root) return;

            const visible = !!(data && data.visible);
            setOverlayVisibility(nodes.root, visible);

            if (nodes.title) {
                const titleText = data?.title || options.fallbackTitle || '';
                nodes.title.textContent = titleText;
            }

            if (!nodes.list) return;
            nodes.list.innerHTML = '';

            if (!visible) return;

            const items = Array.isArray(data?.items) ? data.items : [];
            if (!items.length) {
                if (options.showEmptyState !== false) {
                    const emptyItem = document.createElement('li');
                    emptyItem.className = 'overlay-list-item empty';
                    emptyItem.textContent = 'Aguardando dados...';
                    nodes.list.appendChild(emptyItem);
                }
                return;
            }

            const maxItems = typeof options.maxItems === 'number' ? options.maxItems : items.length;
            const showPosition = options.showPosition !== false;
            const showScore = options.showScore !== false;
            const scoreKeys = options.scoreKeys || LIST_SCORE_KEYS;
            const scoreDecimals = options.scoreDecimals ?? 3;
            const metaFields = Array.isArray(options.metaFields) ? options.metaFields : ['status', 'note'];

            items.slice(0, maxItems).forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'overlay-list-item';

                if (item && (item.highlight || item.isCurrent || item.active || item.focus || item.current)) {
                    li.dataset.highlight = 'true';
                }

                if (showPosition) {
                    const positionRaw = item?.position ?? item?.rank ?? item?.order ?? item?.lane ?? item?.index ?? (index + 1);
                    const positionSpan = document.createElement('span');
                    positionSpan.className = 'item-position';
                    if (typeof positionRaw === 'number') {
                        positionSpan.textContent = `#${positionRaw}`;
                    } else {
                        positionSpan.textContent = positionRaw ? String(positionRaw) : `#${index + 1}`;
                    }
                    li.appendChild(positionSpan);
                }

                const body = document.createElement('div');
                body.className = 'item-body';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'item-name';
                nameSpan.textContent = normalizeListName(item);
                body.appendChild(nameSpan);

                const countryLabel = resolveListCountry(item);
                if (countryLabel) {
                    const countrySpan = document.createElement('span');
                    countrySpan.className = 'item-country';
                    countrySpan.textContent = countryLabel;
                    body.appendChild(countrySpan);
                }
                li.appendChild(body);

                const metaContainer = document.createElement('div');
                metaContainer.className = 'item-meta';
                let metaCount = 0;

                if (showScore) {
                    const scoreValue = resolveListScore(item, scoreDecimals, scoreKeys);
                    if (scoreValue !== null && scoreValue !== '--') {
                        const scoreSpan = document.createElement('span');
                        scoreSpan.className = 'item-score';
                        scoreSpan.textContent = scoreValue;
                        metaContainer.appendChild(scoreSpan);
                        metaCount++;
                    }
                }

                const teamLabel = item?.team ? String(item.team).toUpperCase() : '';
                if (teamLabel && teamLabel !== countryLabel) {
                    const teamSpan = document.createElement('span');
                    teamSpan.textContent = teamLabel;
                    metaContainer.appendChild(teamSpan);
                    metaCount++;
                }

                metaFields.forEach((field) => {
                    if (!field || field === 'team' || !item || !(field in item)) return;
                    const value = item[field];
                    if (value === null || value === undefined || value === '') return;
                    const span = document.createElement('span');
                    span.textContent = String(value);
                    metaContainer.appendChild(span);
                    metaCount++;
                });

                if (metaCount > 0) {
                    li.appendChild(metaContainer);
                }

                nodes.list.appendChild(li);
            });
        }

        function normalizeGymnastRecord(raw = {}, fallbackId = '') {
            const gymnast = { ...raw };
            if (!gymnast.id) gymnast.id = fallbackId;
            if (!gymnast.name) {
                const first = gymnast.firstName || gymnast.firstname || gymnast.gymnastName || '';
                const last = gymnast.lastName || gymnast.lastname || gymnast.gymnastLastName || '';
                const combined = `${first} ${last}`.trim();
                gymnast.name = combined || gymnast.displayName || gymnast.fullName || fallbackId || '';
            }
            if (!gymnast.country && gymnast.countryCode) {
                gymnast.country = gymnast.countryCode;
            }
            if (!gymnast.countryCode && gymnast.country) {
                gymnast.countryCode = gymnast.country;
            }
            return gymnast;
        }

        function subscribeToGymnasts() {
            if (unsubscribeGymnasts) return;
            unsubscribeGymnasts = db.collection('new_gymnasts').onSnapshot((snapshot) => {
                const gymnasts = [];
                snapshot.forEach((doc) => {
                    const normalized = normalizeGymnastRecord(doc.data() || {}, doc.id);
                    gymnasts.push(normalized);
                });
                dataState.gymnasts = gymnasts;
                dataState.gymnastMap = new Map(gymnasts.map((g) => [g.id, g]));
                dataState.lastUpdated.gymnasts = Date.now();
                syncComputedOverlays();
            }, (error) => {
                console.error('[Stream] Error listening gymnasts:', error);
            });
        }

        function subscribeToStartLists() {
            if (unsubscribeStartLists) return;
            unsubscribeStartLists = db.collection('start_lists').onSnapshot((snapshot) => {
                snapshot.forEach((doc) => {
                    const payload = doc.data() || {};
                    const structure = payload?.structure || null;
                    dataState.startLists[doc.id] = structure;
                    if (doc.id === 'team_final' && structure) {
                        dataState.teamFinalDraw = structure;
                    }
                });
                dataState.lastUpdated.startLists = Date.now();
                syncComputedOverlays();
            }, (error) => {
                console.error('[Stream] Error listening start lists:', error);
            });
        }

        function initializeDataListeners() {
            subscribeToGymnasts();
            subscribeToStartLists();
        }

        function getBasePhaseName(rawPhase) {
            if (!rawPhase) return 'qualifiers';
            const phaseString = String(rawPhase);
            return phaseString.includes('|') ? phaseString.split('|')[0] : phaseString;
        }

        function getApparatusCode(rawApparatus) {
            if (!rawApparatus) return 'fx';
            return String(rawApparatus).toLowerCase();
        }

        // ========== FUN√á√ïES AUXILIARES PARA RODAP√âS DE NOTAS ==========
        
        function getCurrentGymnast() {
            const basePhase = getBasePhaseName(overlayContext.phase);
            const apparatusCode = getApparatusCode(overlayContext.apparatus);
            const startList = buildStartList(basePhase, apparatusCode);
            const currentIndex = resolveCurrentIndex(startList);
            return startList[currentIndex] || null;
        }

        function getGymnastScores(gymnastId, phase) {
            console.log('[Stream] üìä getGymnastScores:', { gymnastId, phase });
            
            if (!gymnastId) return null;
            
            const gymnast = resolveGymnastById(gymnastId);
            if (!gymnast || !gymnast.scores) return null;

            const basePhaseName = getBasePhaseName(phase);
            // Primeiro, tenta o formato aninhado: gymnast.scores.team_final
            let phaseScores = gymnast.scores[basePhaseName];

            // Se n√£o existir formato aninhado, alguns documentos armazenam as chaves
            // diretamente em gymnast.scores como `team_final_vt_d`, `team_final_fx_e`, etc.
            // Nesse caso, construir um objeto phaseScores a partir das chaves planas.
            if (!phaseScores) {
                phaseScores = {};
                const prefix = `${basePhaseName}_`;
                Object.keys(gymnast.scores).forEach((k) => {
                    if (typeof k === 'string' && k.startsWith(prefix)) {
                        phaseScores[k] = gymnast.scores[k];
                    }
                });

                // Se n√£o encontrou nenhuma chave com prefixo, n√£o temos scores para esta fase
                if (!Object.keys(phaseScores).length) {
                    return null;
                }
            }
            
            console.log('[Stream] üîç phaseScores object:', phaseScores);
            console.log('[Stream] üîç basePhaseName:', basePhaseName);
            console.log('[Stream] üîç Available keys in phaseScores:', Object.keys(phaseScores));
            
            // Retornar objeto com todas as notas dispon√≠veis
            const scores = {
                // VT1 - tentar todas as varia√ß√µes poss√≠veis
                // Para team_final, as notas de VT s√£o salvas como team_final_vt_d (sem o "1")
                vt1_d: phaseScores[`${basePhaseName}_vt1_d`] ?? phaseScores[`${basePhaseName}_vt_d`] ?? phaseScores.vt1_d ?? phaseScores.vt_d ?? null,
                vt1_e: phaseScores[`${basePhaseName}_vt1_e`] ?? phaseScores[`${basePhaseName}_vt_e`] ?? phaseScores.vt1_e ?? phaseScores.vt_e ?? null,
                vt1_p: phaseScores[`${basePhaseName}_vt1_p`] ?? phaseScores[`${basePhaseName}_vt_p`] ?? phaseScores.vt1_p ?? phaseScores.vt_p ?? null,
                
                // VT2 - tentar todas as varia√ß√µes poss√≠veis
                vt2_d: phaseScores[`${basePhaseName}_vt2_d`] ?? phaseScores.vt2_d ?? null,
                vt2_e: phaseScores[`${basePhaseName}_vt2_e`] ?? phaseScores.vt2_e ?? null,
                vt2_p: phaseScores[`${basePhaseName}_vt2_p`] ?? phaseScores.vt2_p ?? null,
                
                // UB - ‚úÖ ESPEC√çFICO
                ub_d: phaseScores[`${basePhaseName}_ub_d`] ?? phaseScores.ub_d ?? null,
                ub_e: phaseScores[`${basePhaseName}_ub_e`] ?? phaseScores.ub_e ?? null,
                ub_p: phaseScores[`${basePhaseName}_ub_p`] ?? phaseScores.ub_p ?? null,
                
                // BB
                bb_d: phaseScores[`${basePhaseName}_bb_d`] ?? phaseScores.bb_d ?? null,
                bb_e: phaseScores[`${basePhaseName}_bb_e`] ?? phaseScores.bb_e ?? null,
                bb_p: phaseScores[`${basePhaseName}_bb_p`] ?? phaseScores.bb_p ?? null,
                
                // FX
                fx_d: phaseScores[`${basePhaseName}_fx_d`] ?? phaseScores.fx_d ?? null,
                fx_e: phaseScores[`${basePhaseName}_fx_e`] ?? phaseScores.fx_e ?? null,
                fx_p: phaseScores[`${basePhaseName}_fx_p`] ?? phaseScores.fx_p ?? null
            };
            
            console.log('[Stream] üîç getGymnastScores result:', scores);
            console.log('[Stream] üîç VT1 extracted:', {
                vt1_d: scores.vt1_d,
                vt1_e: scores.vt1_e,
                vt1_p: scores.vt1_p
            });
            console.log('[Stream] üîç VT2 extracted:', {
                vt2_d: scores.vt2_d,
                vt2_e: scores.vt2_e,
                vt2_p: scores.vt2_p
            });
            
            // Log extra para team_final VT
            if (basePhaseName === 'team_final') {
                console.log('[Stream] üèÖ TEAM FINAL - Checking VT scores...');
                console.log('[Stream] üèÖ team_final_vt_d:', phaseScores['team_final_vt_d']);
                console.log('[Stream] üèÖ team_final_vt_e:', phaseScores['team_final_vt_e']);
                console.log('[Stream] üèÖ team_final_vt_p:', phaseScores['team_final_vt_p']);
            }
            
            return scores;
        }

        function normalizeStartListEntry(entry = {}, index = 0) {
            const id = entry.id || entry.gymnastId || entry.athleteId || entry.uuid || null;
            const name = entry.name || entry.displayName || entry.gymnastName || entry.fullName || '';
            const country = entry.country || entry.countryCode || entry.team || entry.teamCode || '';
            const position = entry.position || entry.order || entry.slot || index + 1;
            return { id, name, country, position, bib: entry.bib || null };
        }

        function hydrateStartList(baseList = []) {
            return baseList
                .filter((item) => item && item.id)
                .map((item, index) => {
                    const gymnast = resolveGymnastById(item.id) || {};
                    const name = gymnast.name || item.name || '-';
                    const country = gymnast.country || item.country || '';
                    const countryInfo = getCountryInfo(country);
                    const names = splitNameParts(name);
                    return {
                        id: item.id,
                        name,
                        firstName: names.firstName,
                        lastName: names.lastName,
                        country,
                        countryCode: country,
                        flagCode: countryInfo.code,
                        position: item.position || index + 1,
                        bib: gymnast.bib || item.bib || null
                    };
                });
        }

        function buildStartList(basePhase, apparatusCode) {
            const structure = dataState.startLists[basePhase];
            let provisional = [];

            if (structure) {
                const uppercaseApp = apparatusCode.toUpperCase();
                const rotationIndex = typeof overlayContext.rotIdx === 'number' ? overlayContext.rotIdx : 0;
                const subdivisionIndex = typeof overlayContext.subdivIdx === 'number' ? overlayContext.subdivIdx : 0;

                try {
                    if (structure.type === 'apparatus_final' && Array.isArray(structure.athletes)) {
                        provisional = structure.athletes.map((athlete, index) => normalizeStartListEntry(athlete, index));
                    } else if (Array.isArray(structure.rotations)) {
                        const rotation = structure.rotations[rotationIndex] || structure.rotations[0];
                        const apparatusList = rotation?.apparatus?.[uppercaseApp] || rotation?.apparatus?.[apparatusCode] || [];
                        provisional = apparatusList.map((athlete, index) => normalizeStartListEntry(athlete, index));
                    } else if (Array.isArray(structure.subdivisions)) {
                        const subdivision = structure.subdivisions[subdivisionIndex] || structure.subdivisions[0];
                        const rotation = subdivision?.rotations?.[rotationIndex] || subdivision?.rotations?.[0];
                        const apparatusList = rotation?.apparatus?.[uppercaseApp] || rotation?.apparatus?.[apparatusCode] || [];
                        provisional = apparatusList.map((athlete, index) => normalizeStartListEntry(athlete, index));
                    } else if (Array.isArray(structure.athletes)) {
                        provisional = structure.athletes.map((athlete, index) => normalizeStartListEntry(athlete, index));
                    }
                } catch (error) {
                    console.error('[Stream] Failed to parse start list structure:', error, structure);
                }
            }

            if (!provisional.length) {
                provisional = buildFallbackStartList(basePhase, apparatusCode);
            }

            return hydrateStartList(provisional);
        }

        function buildFallbackStartList(basePhase, apparatusCode) {
            const gymnasts = dataState.gymnasts || [];
            if (!gymnasts.length) return [];

            const list = [];

            if (basePhase === 'qualifiers') {
                gymnasts.forEach((gymnast) => {
                    const phaseScores = gymnast.scores?.qualifiers || {};
                    const hasScore = apparatusCode === 'vt'
                        ? phaseScores['qualifiers_vt1_d'] !== undefined || phaseScores['qualifiers_vt_d'] !== undefined
                        : phaseScores[`qualifiers_${apparatusCode}_d`] !== undefined;
                    if (hasScore) {
                        list.push({ id: gymnast.id, name: gymnast.name, country: gymnast.country });
                    }
                });
            } else if (basePhase === 'team_final') {
                const teamResults = typeof calculateTeamScores === 'function' ? calculateTeamScores(gymnasts) : [];
                const qualifyingCountries = teamResults.slice(0, 4).map((team) => team.country);
                gymnasts.forEach((gymnast) => {
                    if (qualifyingCountries.includes(gymnast.country)) {
                        list.push({ id: gymnast.id, name: gymnast.name, country: gymnast.country });
                    }
                });
            } else if (basePhase === 'aa_final') {
                if (typeof calculateAAScores === 'function' && typeof applyMaxPerCountry === 'function') {
                    const aaQualifiers = calculateAAScores(gymnasts);
                    const aaFinalists = applyMaxPerCountry(aaQualifiers, 8, 2);
                    aaFinalists.forEach((gymnast) => {
                        list.push({ id: gymnast.id, name: gymnast.name, country: gymnast.country });
                    });
                }
            } else if (basePhase.endsWith('_final')) {
                const apparatusFinal = basePhase.replace('_final', '');
                if (apparatusFinal === 'vt') {
                    if (typeof calculateApparatusScores === 'function' && typeof applyMaxPerCountry === 'function') {
                        const qualifiers = calculateApparatusScores(gymnasts, 'vt');
                        const finalists = applyMaxPerCountry(qualifiers, 8, 2);
                        finalists.forEach((gymnast) => {
                            list.push({ id: gymnast.id, name: gymnast.name, country: gymnast.country });
                        });
                    }
                } else {
                    if (typeof calculateApparatusScores === 'function' && typeof applyMaxPerCountry === 'function') {
                        const qualifiers = calculateApparatusScores(gymnasts, apparatusFinal);
                        const finalists = applyMaxPerCountry(qualifiers, 8, 2);
                        finalists.forEach((gymnast) => {
                            list.push({ id: gymnast.id, name: gymnast.name, country: gymnast.country });
                        });
                    }
                }
            }

            return list.map((item, index) => ({ ...item, position: index + 1 }));
        }

        function resolveCurrentIndex(startList) {
            if (!Array.isArray(startList) || !startList.length) {
                overlayContext.currentIndex = 0;
                return 0;
            }

            if (overlayContext.gymnastId) {
                const idxById = startList.findIndex((item) => item.id === overlayContext.gymnastId);
                if (idxById >= 0) {
                    overlayContext.currentIndex = idxById;
                    return idxById;
                }
            }

            let nextIndex = typeof overlayContext.currentIndex === 'number' ? overlayContext.currentIndex : 0;
            if (nextIndex < 0) nextIndex = 0;
            if (nextIndex >= startList.length) nextIndex = startList.length - 1;
            overlayContext.currentIndex = nextIndex;
            return nextIndex;
        }

        function computeConsolidatedResults(basePhase, apparatusCode) {
            const gymnasts = dataState.gymnasts || [];
            if (!gymnasts.length) return [];

            let results = [];
            const apparatus = apparatusCode || overlayContext.apparatus || 'fx';

            try {
                if (basePhase === 'qualifiers') {
                    if (typeof calculateAAScores === 'function') {
                        results = calculateAAScores(gymnasts);
                    }
                } else if (basePhase === 'aa_final') {
                    const aaQualifiers = typeof calculateAAScores === 'function' ? calculateAAScores(gymnasts) : [];
                    const finalists = typeof applyMaxPerCountry === 'function'
                        ? applyMaxPerCountry(aaQualifiers, 16, 2)
                        : aaQualifiers.slice(0, 16);
                    const finalistIds = new Set(finalists.map((g) => g.id));
                    const finalGymnasts = gymnasts.filter((g) => finalistIds.has(g.id));

                    if (apparatus) {
                        results = finalGymnasts.map((gymnast) => {
                            // Construir phaseScores de forma robusta (apoiar chaves planas como 'aa_final_vt_d')
                            let phaseScores = gymnast.scores?.[basePhase];
                            if (!phaseScores) {
                                phaseScores = {};
                                const prefix = `${basePhase}_`;
                                Object.keys(gymnast.scores || {}).forEach((k) => {
                                    if (typeof k === 'string' && k.startsWith(prefix)) phaseScores[k] = gymnast.scores[k];
                                });
                                if (!Object.keys(phaseScores).length) phaseScores = {};
                            }
                            const scoreData = getAppScore(phaseScores, apparatus, gymnast.id, basePhase);
                            return { ...gymnast, apparatusScore: scoreData.total };
                        }).filter((g) => g.apparatusScore > 0).sort((a, b) => b.apparatusScore - a.apparatusScore);
                    } else {
                        results = finalGymnasts.map((gymnast) => {
                            const phaseScores = gymnast.scores?.[basePhase] || {};
                            const total = ['vt', 'ub', 'bb', 'fx'].reduce((acc, app) => {
                                const scoreData = getAppScore(phaseScores, app, gymnast.id, basePhase);
                                return acc + (scoreData.total || 0);
                            }, 0);
                            return { ...gymnast, aaTotal: total };
                        }).filter((g) => g.aaTotal > 0).sort((a, b) => b.aaTotal - a.aaTotal);
                    }
                } else if (basePhase === 'team_final') {
                    const teamQualifiers = typeof calculateTeamScores === 'function' ? calculateTeamScores(gymnasts) : [];
                    const qualifyingCountries = teamQualifiers.map((team) => team.country);
                    if (dataState.teamFinalDraw && typeof calculateTeamFinalScoresWithDuplication === 'function') {
                        results = calculateTeamFinalScoresWithDuplication(gymnasts, qualifyingCountries, dataState.teamFinalDraw);
                    } else if (typeof calculateTeamFinalScores === 'function') {
                        results = calculateTeamFinalScores(gymnasts, qualifyingCountries);
                    } else {
                        results = teamQualifiers;
                    }
                } else if (basePhase.endsWith('_final')) {
                    const apparatusFinal = basePhase.replace('_final', '');
                    let finalists = [];
                    if (typeof calculateApparatusScores === 'function' && typeof applyMaxPerCountry === 'function') {
                        finalists = applyMaxPerCountry(calculateApparatusScores(gymnasts, apparatusFinal), 8, 2);
                    }
                    const finalistIds = new Set(finalists.map((g) => g.id));
                    const finalGymnasts = finalists.length ? gymnasts.filter((g) => finalistIds.has(g.id)) : gymnasts;

                    results = finalGymnasts.map((gymnast) => {
                        let phaseScores = gymnast.scores?.[basePhase];
                        if (!phaseScores) {
                            phaseScores = {};
                            const prefix = `${basePhase}_`;
                            Object.keys(gymnast.scores || {}).forEach((k) => {
                                if (typeof k === 'string' && k.startsWith(prefix)) phaseScores[k] = gymnast.scores[k];
                            });
                            if (!Object.keys(phaseScores).length) phaseScores = {};
                        }
                        if (apparatusFinal === 'vt') {
                            const vt1 = getAppScore(phaseScores, 'vt1', gymnast.id, basePhase);
                            const vt2 = getAppScore(phaseScores, 'vt2', gymnast.id, basePhase);
                            const vtScores = [vt1.total || 0, vt2.total || 0];
                            const validScores = vtScores.filter((score) => score > 0);
                            let apparatusScore = 0;
                            if (validScores.length === 2) {
                                apparatusScore = (validScores[0] + validScores[1]) / 2;
                            } else if (validScores.length === 1) {
                                apparatusScore = validScores[0];
                            }
                            return { ...gymnast, apparatusScore };
                        }
                        const scoreData = getAppScore(phaseScores, apparatusFinal, gymnast.id, basePhase);
                        return { ...gymnast, apparatusScore: scoreData.total };
                    }).filter((g) => g.apparatusScore > 0).sort((a, b) => b.apparatusScore - a.apparatusScore);
                }
            } catch (error) {
                console.error('[Stream] Error computing consolidated results:', error);
            }

            return results;
        }

        function computeScorecardData(currentGymnast, basePhase, apparatusCode, resultsList) {
            if (!currentGymnast) return null;
            const gymnast = resolveGymnastById(currentGymnast.id) || currentGymnast;
            if (!gymnast || !gymnast.id) return null;

            const phaseName = basePhase;
            let appKey = apparatusCode || overlayContext.apparatus || 'fx';
            if (appKey === 'vt') {
                if (phaseName === 'qualifiers' || phaseName === 'vt_final') {
                    appKey = overlayContext.activeVaultNum === 2 ? 'vt2' : 'vt1';
                } else {
                    appKey = 'vt';
                }
            }

            // Primeiro tenta estrutura aninhada
            let phaseScores = gymnast.scores?.[phaseName];
            // Se n√£o existir, reconstruir a partir de chaves planas como 'team_final_vt_d'
            if (!phaseScores) {
                phaseScores = {};
                const prefix = `${phaseName}_`;
                Object.keys(gymnast.scores || {}).forEach((k) => {
                    if (typeof k === 'string' && k.startsWith(prefix)) {
                        phaseScores[k] = gymnast.scores[k];
                    }
                });
                // Se n√£o achou nada, garantir objeto vazio para evitar erros em getAppScore
                if (!Object.keys(phaseScores).length) phaseScores = {};
            }
            const scoreData = getAppScore(phaseScores, appKey, gymnast.id, phaseName);
            const countryCode = gymnast.country || currentGymnast.country || '';
            const countryInfo = getCountryInfo(countryCode);
            const nameParts = splitNameParts(gymnast.name || currentGymnast.name);

            overlayContext.timer.dv = (apparatusCode === 'vt') ? scoreData.d : null;

            let rank = null;
            if (Array.isArray(resultsList) && resultsList.length) {
                const foundIndex = resultsList.findIndex((item) => item.id === gymnast.id || item.gymnastId === gymnast.id);
                if (foundIndex >= 0) rank = foundIndex + 1;
            }

            return {
                gymnastId: gymnast.id,
                gymnastName: nameParts.firstName,
                gymnastLastName: nameParts.lastName,
                countryCode: countryInfo.code,
                countryFlagEmoji: countryInfo.emoji,
                dScore: scoreData.d,
                eScore: scoreData.e,
                pScore: scoreData.p,
                totalScore: scoreData.total,
                rank
            };
        }

        function buildStartlistWidgetsData(startList, basePhase) {
            const apparatusCode = getApparatusCode(overlayContext.apparatus);
            const apparatusLabel = apparatusCode.toUpperCase();
            const currentIndex = resolveCurrentIndex(startList);
            const mainItems = startList.map((item, index) => ({
                id: item.id,
                displayName: item.name,
                firstName: item.firstName,
                lastName: item.lastName,
                countryCode: item.countryCode,
                country: item.countryCode,
                position: item.position || index + 1,
                highlight: index === currentIndex,
                status: index === currentIndex
                    ? 'No aparelho'
                    : (index === currentIndex + 1 ? 'Pr√≥xima' : '')
            }));

            const upcoming = startList.slice(currentIndex + 1, currentIndex + 5).map((item, offset) => ({
                id: item.id,
                displayName: item.name,
                firstName: item.firstName,
                lastName: item.lastName,
                countryCode: item.countryCode,
                country: item.countryCode,
                position: item.position,
                highlight: offset === 0
            }));

            return {
                main: {
                    title: `Startlist ¬∑ ${apparatusLabel}`,
                    items: mainItems
                },
                corner: {
                    title: `Pr√≥ximas ¬∑ ${apparatusLabel}`,
                    items: upcoming
                },
                current: startList[currentIndex] || null
            };
        }

        function formatResultsForOverlay(results, basePhase, apparatusCode) {
            if (!Array.isArray(results)) return [];

            return results.map((item, index) => {
                const gymnast = item.id ? resolveGymnastById(item.id) : null;
                const country = item.country || gymnast?.country || item.countryCode || '';
                const displayName = gymnast?.name || item.name || item.gymnastName || item.displayName || country || '-';
                const nameParts = splitNameParts(displayName);
                const totalScore = item.total ?? item.totalScore ?? item.aaTotal ?? item.apparatusScore ?? item.points ?? item.score ?? 0;
                return {
                    id: item.id || item.gymnastId || `${country || 'result'}-${index}`,
                    displayName,
                    firstName: nameParts.firstName,
                    lastName: nameParts.lastName,
                    countryCode: country,
                    country,
                    position: index + 1,
                    totalScore,
                    highlight: overlayContext.gymnastId && (item.id === overlayContext.gymnastId || item.gymnastId === overlayContext.gymnastId)
                };
            });
        }

        function syncComputedOverlays() {
            const baseOverlays = latestBroadcastState.activeOverlays || {};
            const scenePayload = latestBroadcastState.scenePayload || {};

            if (scenePayload.gymnastId) {
                overlayContext.gymnastId = scenePayload.gymnastId;
            }
            if (scenePayload.apparatus) {
                overlayContext.apparatus = getApparatusCode(scenePayload.apparatus);
            }
            if (scenePayload.phase) {
                overlayContext.phase = getBasePhaseName(scenePayload.phase);
            }

            const merged = {
                logoBug: !!baseOverlays.logoBug,
                widgets: { ...(baseOverlays.widgets || {}) }
            };

            const basePhase = getBasePhaseName(overlayContext.phase);
            const apparatusCode = getApparatusCode(overlayContext.apparatus);
            const startList = buildStartList(basePhase, apparatusCode);
            const startlistWidgets = buildStartlistWidgetsData(startList, basePhase);
            const resultsRaw = computeConsolidatedResults(basePhase, apparatusCode) || [];
            const resultsItems = formatResultsForOverlay(resultsRaw, basePhase, apparatusCode);
            const currentIndex = resolveCurrentIndex(startList);
            const currentGymnast = startList[currentIndex] || null;
            const scorecardPayload = computeScorecardData(currentGymnast, basePhase, apparatusCode, resultsRaw);

            const startlistMainBase = merged.widgets.startlistMain || {};
            merged.widgets.startlistMain = {
                ...startlistMainBase,
                title: startlistMainBase.title || startlistWidgets.main.title,
                items: startlistWidgets.main.items,
                visible: startlistMainBase.visible ?? false
            };

            const startlistCornerBase = merged.widgets.startlistCorner || {};
            merged.widgets.startlistCorner = {
                ...startlistCornerBase,
                title: startlistCornerBase.title || startlistWidgets.corner.title,
                items: startlistWidgets.corner.items,
                visible: startlistCornerBase.visible ?? false
            };

            const resultsBase = merged.widgets.results || {};
            merged.widgets.results = {
                ...resultsBase,
                title: resultsBase.title || `Resultados ¬∑ ${basePhase.replace(/_/g, ' ').toUpperCase()}`,
                items: resultsItems,
                visible: resultsBase.visible ?? false
            };

            if (scorecardPayload) {
                const scorecardBase = merged.widgets.scorecard || {};
                merged.widgets.scorecard = {
                    ...scorecardBase,
                    ...scorecardPayload,
                    visible: scorecardBase.visible ?? false
                };
            }

            const timerBase = merged.widgets.timer || {};
            console.log('[Stream] üîç DEBUG Timer - timerBase from Firebase:', timerBase);
            console.log('[Stream] üîç DEBUG Timer - timerBase.visible:', timerBase.visible);
            
            // Always sync timer state from Firestore (centralized control)
            if (typeof timerBase.elapsedSeconds === 'number') {
                overlayContext.timer.elapsed = timerBase.elapsedSeconds;
            }
            if (timerBase.status) {
                overlayContext.timer.status = timerBase.status;
                
                // ‚úÖ Resetar lastBeepSecond quando timer para ou reseta
                if (timerBase.status === 'WAIT' || timerBase.status === 'STOP') {
                    lastBeepSecond = -1;
                }
            }
            
            // ‚úÖ Verificar beeps para BB e UB quando timer est√° rodando
            const timerApparatus = (timerBase.apparatus || apparatusCode).toLowerCase();
            if (timerBase.status === 'GO') {
                checkTimerBeeps(timerApparatus);
            }
            
            // Update warning state based on elapsed time
            updateTimerWarningState();
            merged.widgets.timer = {
                ...timerBase,  // ‚úÖ Preservar TODOS os campos do Firebase (dvVt1, dvVt2, activeVaultNum, etc)
                apparatus: (timerBase.apparatus || apparatusCode.toUpperCase()),
                status: (overlayContext.timer.status || timerBase.status || 'WAIT').toUpperCase(),
                elapsedSeconds: overlayContext.timer.elapsed,
                formatted: formatSecondsToClock(overlayContext.timer.elapsed),
                warning: overlayContext.timer.warning,
                visible: timerBase.visible !== undefined ? timerBase.visible : false
            };
            console.log('[Stream] üîç DEBUG Timer - merged.widgets.timer:', merged.widgets.timer);

            const musicBase = merged.widgets.music || {};
            const resolvedMusicStatus = musicBase.status || overlayContext.music.status || 'WAIT';
            merged.widgets.music = {
                ...musicBase,
                status: resolvedMusicStatus.toUpperCase(),
                label: musicBase.label || overlayContext.music.label || apparatusCode.toUpperCase(),
                timestamp: musicBase.timestamp || overlayContext.music.timestamp || null,
                visible: musicBase.visible ?? false
            };

            overlayContext.music.status = resolvedMusicStatus;
            overlayContext.music.label = merged.widgets.music.label;
            overlayContext.music.timestamp = merged.widgets.music.timestamp;

            // Update lower-third with current gymnast data SOMENTE se explicitamente vis√≠vel
            // Usar scenePayload.lowerThirdVisible para MUDAR o estado, sen√£o manter o atual
            console.log('[Stream] üîç Lower-third DEBUG - scenePayload.lowerThirdVisible:', scenePayload.lowerThirdVisible, 'currentLowerThirdState:', currentLowerThirdState);
            
            if (scenePayload.lowerThirdVisible === true) {
                // Comando expl√≠cito para MOSTRAR
                console.log('[Stream] ‚úÖ Comando para MOSTRAR rodap√© recebido');
                currentLowerThirdState = true;
            } else if (scenePayload.lowerThirdVisible === false) {
                // Comando expl√≠cito para ESCONDER
                console.log('[Stream] ‚ùå Comando para ESCONDER rodap√© recebido');
                currentLowerThirdState = false;
            }
            // Se undefined, manter currentLowerThirdState como est√°
            
            console.log('[Stream] üîç Lower-third state FINAL:', currentLowerThirdState);
            
            // Atualizar conte√∫do do rodap√© se estiver vis√≠vel
            if (currentGymnast && currentLowerThirdState) {
                console.log('[Stream] üè≥Ô∏è Atualizando conte√∫do do lower-third (vis√≠vel)');
                const countryInfo = getCountryInfo(currentGymnast.country);
                console.log('[Stream] üè≥Ô∏è Atualizando lower-third:', {
                    gymnastName: currentGymnast.firstName || currentGymnast.name,
                    country: currentGymnast.country,
                    countryCode: countryInfo.code,
                    countryEmoji: countryInfo.emoji
                });
                updateLowerThirdContent({
                    gymnastName: currentGymnast.firstName || currentGymnast.name || '',
                    gymnastLastName: currentGymnast.surname || currentGymnast.lastName || '',
                    countryCode: countryInfo.code,
                    countryFlagEmoji: countryInfo.emoji,
                    apparatus: apparatusCode,
                    showScore: false
                });
            } else {
                console.log('[Stream] üö´ N√ÉO atualizando lower-third (currentGymnast:', !!currentGymnast, 'currentLowerThirdState:', currentLowerThirdState, ')');
            }
            
            // Aplicar visibilidade baseado no estado persistente
            console.log('[Stream] üéØ Aplicando visibilidade do rodap√©:', currentLowerThirdState);
            setLowerThirdVisibility(currentLowerThirdState);

            applyOverlays(merged);
        }

        function getTimerThresholds(apparatusCode) {
            const app = apparatusCode || 'fx';
            if (app === 'bb') {
                return { warn: 91, overtime: 91 };  // BB: 1:31
            }
            if (app === 'fx') {
                return { warn: 91, overtime: 91 };  // FX: 1:31
            }
            if (app === 'ub') {
                return { warn: 61, overtime: 61 };  // UB: 1:01
            }
            // VT n√£o tem warning
            return { warn: 9999, overtime: 9999 };
        }

        function checkTimerBeeps(apparatusCode) {
            const elapsed = overlayContext.timer.elapsed;
            if (!audioEnabled || elapsed === lastBeepSecond) return;

            if (apparatusCode === 'bb' && (elapsed === 80 || elapsed === 90)) {
                console.log(`[Stream] üîî BB Beep at ${elapsed}s`);
                playBeep();
                lastBeepSecond = elapsed;  // ‚úÖ Marcar para n√£o tocar novamente
            } else if (apparatusCode === 'ub' && elapsed === 50) {
                console.log(`[Stream] üîî UB Beep at ${elapsed}s`);
                playBeep();
                lastBeepSecond = elapsed;  // ‚úÖ Marcar para n√£o tocar novamente
            }
        }

        function handleTimerStartAudio(apparatusCode, gymnastId) {
            if (!ensureAudioEnabled()) return;
            if (apparatusCode === 'fx') {
                playGymnastMusic(gymnastId || overlayContext.gymnastId);
            } else {
                playBeep(true);
                overlayContext.music.status = 'WAIT';
                overlayContext.music.label = apparatusCode.toUpperCase();
                overlayContext.music.timestamp = Date.now();
                stopGymnastMusic();
            }
        }

        function clearTimerInterval() {
            if (overlayContext.timer.intervalId) {
                clearInterval(overlayContext.timer.intervalId);
                overlayContext.timer.intervalId = null;
            }
        }

        function updateTimerWarningState() {
            const apparatusCode = getApparatusCode(overlayContext.apparatus);
            const { warn } = getTimerThresholds(apparatusCode);
            overlayContext.timer.warning = overlayContext.timer.elapsed >= warn;
        }

        function tickTimer() {
            if (!overlayContext.timer.startedAt) return;
            const elapsedSeconds = Math.max(0, Math.floor((Date.now() - overlayContext.timer.startedAt) / 1000));
            if (elapsedSeconds !== overlayContext.timer.elapsed) {
                overlayContext.timer.elapsed = elapsedSeconds;
                updateTimerWarningState();
                const apparatusCode = getApparatusCode(overlayContext.apparatus);
                checkTimerBeeps(apparatusCode);
                syncComputedOverlays();
            }
        }

        function startTimerCountdown() {
            clearTimerInterval();
            overlayContext.timer.status = 'GO';
            overlayContext.timer.startedAt = Date.now() - (overlayContext.timer.elapsed * 1000);
            updateTimerWarningState();
            overlayContext.timer.intervalId = setInterval(tickTimer, 250);
            tickTimer();
        }

        function stopTimerCountdown() {
            if (overlayContext.timer.status === 'GO') {
                overlayContext.timer.status = 'STOP';
            }
            clearTimerInterval();
            const apparatusCode = getApparatusCode(overlayContext.apparatus);
            if (apparatusCode === 'fx') {
                overlayContext.music.status = 'STOP';
                overlayContext.music.timestamp = Date.now();
                stopGymnastMusic();
            }
            tickTimer();
        }

        function resetTimerCountdown() {
            clearTimerInterval();
            overlayContext.timer.status = 'WAIT';
            overlayContext.timer.elapsed = 0;
            overlayContext.timer.warning = false;
            overlayContext.timer.startedAt = null;
            overlayContext.timer.dv = null;
            lastBeepSecond = -1;
            overlayContext.music.status = 'WAIT';
            overlayContext.music.timestamp = Date.now();
            stopGymnastMusic();
        }

        function handleControlMessage(event) {
                const data = event?.data || {};
                console.log('[Stream] üì° Received fx-control message:', data);
                let contextChanged = false;

                if (data.phase && data.phase !== overlayContext.phase) {
                    overlayContext.phase = data.phase;
                    contextChanged = true;
                }

                if (data.apparatus) {
                    const apparatusCode = getApparatusCode(data.apparatus);
                    if (apparatusCode !== overlayContext.apparatus) {
                        overlayContext.apparatus = apparatusCode;
                        contextChanged = true;
                    }
                }

                if (typeof data.index === 'number' && data.index !== overlayContext.currentIndex) {
                    overlayContext.currentIndex = data.index;
                    contextChanged = true;
                }

                if (typeof data.subdivIdx === 'number' && data.subdivIdx !== overlayContext.subdivIdx) {
                    overlayContext.subdivIdx = data.subdivIdx;
                    contextChanged = true;
                }

                if (typeof data.rotIdx === 'number' && data.rotIdx !== overlayContext.rotIdx) {
                    overlayContext.rotIdx = data.rotIdx;
                    contextChanged = true;
                }

                if (typeof data.activeVaultNum === 'number') {
                    overlayContext.activeVaultNum = data.activeVaultNum;
                }

                if (data.gymnastId) {
                    overlayContext.gymnastId = data.gymnastId;
                    contextChanged = true;
                }

                const apparatusCode = getApparatusCode(data.apparatus || overlayContext.apparatus);

                // Handle Timer controls
                if (data.action === 'timer-start') {
                    overlayContext.apparatus = apparatusCode;
                    // Timer state now comes from Firestore, no local countdown needed
                    // overlayContext.timer.elapsed = overlayContext.timer.elapsed || 0;
                    // overlayContext.timer.startedAt = Date.now() - (overlayContext.timer.elapsed * 1000);
                    // overlayContext.timer.status = 'GO';
                    if (typeof data.vaultDV === 'number') {
                        overlayContext.timer.dv = data.vaultDV;
                    }
                    // startTimerCountdown(); // Disabled - timer controlled via Firestore
                    handleTimerStartAudio(apparatusCode, data.gymnastId || overlayContext.gymnastId);
                    contextChanged = true;
                } else if (data.action === 'timer-stop') {
                    // stopTimerCountdown(); // Disabled - timer controlled via Firestore
                    contextChanged = true;
                } else if (data.action === 'timer-reset') {
                    // resetTimerCountdown(); // Disabled - timer controlled via Firestore
                    if (typeof data.activeVaultNum === 'number') {
                        overlayContext.activeVaultNum = data.activeVaultNum;
                    }
                    contextChanged = true;
                }

                // Handle Warmup controls
                else if (data.action === 'warmup-start') {
                    const duration = data.time || data.duration || 60;
                    showWarmupOverlay(duration);
                    playBeep();
                } else if (data.action === 'warmup-stop') {
                    hideWarmupOverlay();
                }

                // Handle Reception Overlay (Country Reception)
                else if (data.action === 'show-reception') {
                    console.log('[Stream] üé™ ACTION: show-reception detected!', data);
                    showReceptionOverlay(data.flag, data.text, data.duration || 5000, data.countryCode);
                }

                // Handle Welcome Overlay (Boas-Vindas)
                else if (data.action === 'show-welcome') {
                    console.log('[Stream] üëã ACTION: show-welcome detected!', data);
                    showWelcomeOverlay(data.duration || 6000);
                }

                // Handle Anthem Overlay (Hino Nacional)
                else if (data.action === 'show-anthem') {
                    console.log('[Stream] üáßüá∑ ACTION: show-anthem detected!', data);
                    showAnthemOverlay(data.duration || 8000);
                }

                // Handle Instructions Overlay (Instru√ß√µes Finais)
                  else if (data.action === 'show-instructions') {
                      console.log('[Stream] ‚ö†Ô∏è ACTION: show-instructions detected!', data);
                      showInstructionsOverlay(data.duration || 5000);
                  }

                  // Handle Hide All Overlays
                  else if (data.action === 'hide-all-overlays') {
                      hideAllOverlays();
                  }
                  else if (data.action === 'podium-start-ceremony') {
                      handlePodiumStart(data);
                  }
                  else if (data.action === 'podium-show-medal') {
                      handlePodiumShowMedal(data);
                  }
                  else if (data.action === 'podium-hide') {
                      handlePodiumHide();
                  }
                  else if (data.action === 'podium-start-anthem') {
                      handlePodiumAnthem(data);
                  }

                  // Handle Show/Hide Lower-third (Rodap√© Padr√£o)
                else if (data.action === 'show-lower-third-default') {
                    console.log('[Stream] üë§ Exibindo rodap√© padr√£o...');
                    currentLowerThirdState = true;
                    syncComputedOverlays();  // ‚úÖ Atualizar conte√∫do com ginasta atual
                }
                else if (data.action === 'hide-lower-third-default') {
                    console.log('[Stream] üö´ Fechando rodap√© padr√£o...');
                    currentLowerThirdState = false;
                    setLowerThirdVisibility(false);
                }

                // Handle Show/Hide Lower-third VT1 (Rodap√© Nota VT1)
                else if (data.action === 'show-lower-third-vt1') {
                    console.log('[Stream] üìä Abrindo rodap√© VT1...');
                    const currentGymnast = getCurrentGymnast();
                    if (currentGymnast) {
                        const phase = getBasePhaseName(overlayContext.phase);
                        const scoreData = getGymnastScores(currentGymnast.id, phase);
                        updateLowerThirdVt1(currentGymnast, phase, scoreData);
                    }
                }
                else if (data.action === 'hide-lower-third-vt1') {
                    console.log('[Stream] üö´ Fechando rodap√© VT1...');
                    if (lowerThirdVt1) lowerThirdVt1.dataset.visible = 'false';
                }

                // Handle Show/Hide Lower-third VT2 (Rodap√© M√©dia VT)
                else if (data.action === 'show-lower-third-vt2') {
                    console.log('[Stream] üìä Abrindo rodap√© VT2...');
                    const currentGymnast = getCurrentGymnast();
                    if (currentGymnast) {
                        const phase = getBasePhaseName(overlayContext.phase);
                        const scoreData = getGymnastScores(currentGymnast.id, phase);
                        updateLowerThirdVt2(currentGymnast, phase, scoreData);
                    }
                }
                else if (data.action === 'hide-lower-third-vt2') {
                    console.log('[Stream] üö´ Fechando rodap√© VT2...');
                    if (lowerThirdVt2) lowerThirdVt2.dataset.visible = 'false';
                }

                // Handle Show/Hide Lower-third Apparatus (Rodap√© FX/UB/BB)
                else if (data.action === 'show-lower-third-apparatus') {
                    console.log('[Stream] üìä Abrindo rodap√© FX/UB/BB...');
                    const currentGymnast = getCurrentGymnast();
                    if (currentGymnast) {
                        const phase = getBasePhaseName(overlayContext.phase);
                        const apparatus = getApparatusCode(overlayContext.apparatus);
                        const scoreData = getGymnastScores(currentGymnast.id, phase);
                        updateLowerThirdApparatus(currentGymnast, phase, apparatus, scoreData);
                    }
                }
                else if (data.action === 'hide-lower-third-apparatus') {
                    console.log('[Stream] üö´ Fechando rodap√© FX/UB/BB...');
                    if (lowerThirdApparatus) lowerThirdApparatus.dataset.visible = 'false';
                }

                // ‚ú® NOVO: Handle Show/Hide Score Reveal Overlay
                else if (data.action === 'show-score-reveal') {
                    console.log('[Stream] ‚ú® Mostrando Score Reveal Overlay...', data);
                    
                    // Atualizar activeVaultNum se fornecido na mensagem
                    if (typeof data.activeVaultNum === 'number') {
                        overlayContext.activeVaultNum = data.activeVaultNum;
                        console.log('[Stream] üîÑ ActiveVaultNum atualizado para:', data.activeVaultNum);
                    }
                    
                    // ‚úÖ Atualizar apparatus se fornecido na mensagem (CRITICAL FIX)
                    if (data.apparatus) {
                        overlayContext.apparatus = data.apparatus;
                        console.log('[Stream] üîÑ Apparatus atualizado para:', data.apparatus);
                    }
                    
                    // Buscar dados da ginasta atual
                    const currentGymnast = getCurrentGymnast();
                    if (!currentGymnast) {
                        console.error('[Stream] ‚ùå Nenhuma ginasta atual encontrada!');
                        return;
                    }
                    
                    const phase = getBasePhaseName(overlayContext.phase);
                    const apparatus = getApparatusCode(overlayContext.apparatus);
                    
                    // Buscar scores
                    const scoreData = getGymnastScores(currentGymnast.id, phase);
                    if (!scoreData) {
                        console.error('[Stream] ‚ùå Nenhuma nota encontrada para a ginasta!');
                        return;
                    }
                    
                    // Calcular D, E, P, Total baseado no aparelho
                    let finalScoreData = {};
                    
                    if (apparatus === 'vt') {
                        // Para VT, verificar se √© VT1 ou VT2
                        const vaultNum = overlayContext.activeVaultNum || 1;
                        console.log('[Stream] üéØ VT Mode - activeVaultNum:', vaultNum);
                        
                        if (vaultNum === 2) {
                            // Modo VT2: Mostrar ambos os saltos + m√©dia
                            console.log('[Stream] üîç VT2 Score Data RAW:', scoreData);
                            console.log('[Stream] üîç VT2 Score Data Keys:', Object.keys(scoreData));
                            
                            const vt1_d = scoreData.vt1_d || 0;
                            const vt1_e = scoreData.vt1_e || 0;
                            const vt1_p = scoreData.vt1_p || 0;
                            const vt1_total = vt1_d + vt1_e - vt1_p;
                            
                            const vt2_d = scoreData.vt2_d || 0;
                            const vt2_e = scoreData.vt2_e || 0;
                            const vt2_p = scoreData.vt2_p || 0;
                            const vt2_total = vt2_d + vt2_e - vt2_p;
                            
                            console.log('[Stream] üîç VT2 Individual Values:', {
                                vt1_d, vt1_e, vt1_p,
                                vt2_d, vt2_e, vt2_p,
                                fromScoreData: {
                                    vt1_d: scoreData.vt1_d,
                                    vt1_e: scoreData.vt1_e,
                                    vt1_p: scoreData.vt1_p,
                                    vt2_d: scoreData.vt2_d,
                                    vt2_e: scoreData.vt2_e,
                                    vt2_p: scoreData.vt2_p
                                }
                            });
                            
                            const average = (vt1_total + vt2_total) / 2;
                            
                            console.log('[Stream] üìä VT2 Calculated:', {
                                vt1: { d: vt1_d, e: vt1_e, p: vt1_p, total: vt1_total },
                                vt2: { d: vt2_d, e: vt2_e, p: vt2_p, total: vt2_total },
                                average
                            });
                            
                            finalScoreData = {
                                isVT2: true,
                                vt1: { d: vt1_d, e: vt1_e, p: vt1_p, total: vt1_total },
                                vt2: { d: vt2_d, e: vt2_e, p: vt2_p, total: vt2_total },
                                average: average,
                                total: average // Para ranking
                            };
                        } else {
                            // Modo VT1: Apenas um salto
                            const d = scoreData.vt1_d || 0;
                            const e = scoreData.vt1_e || 0;
                            const p = scoreData.vt1_p || 0;
                            finalScoreData = {
                                isVT2: false,
                                d: d,
                                e: e,
                                p: p,
                                total: d + e - p
                            };
                        }
                    } else if (apparatus === 'ub') {
                        const d = scoreData.ub_d || 0;
                        const e = scoreData.ub_e || 0;
                        const p = scoreData.ub_p || 0;
                        finalScoreData = {
                            isVT2: false,
                            d: d,
                            e: e,
                            p: p,
                            total: d + e - p
                        };
                    } else if (apparatus === 'bb') {
                        const d = scoreData.bb_d || 0;
                        const e = scoreData.bb_e || 0;
                        const p = scoreData.bb_p || 0;
                        finalScoreData = {
                            isVT2: false,
                            d: d,
                            e: e,
                            p: p,
                            total: d + e - p
                        };
                    } else if (apparatus === 'fx') {
                        const d = scoreData.fx_d || 0;
                        const e = scoreData.fx_e || 0;
                        const p = scoreData.fx_p || 0;
                        finalScoreData = {
                            isVT2: false,
                            d: d,
                            e: e,
                            p: p,
                            total: d + e - p
                        };
                    }
                    
                    // Para team_final, buscar ranking de EQUIPES (pa√≠ses)
                    let resultsRaw = [];
                    let currentRank = null;
                    
                    if (phase !== 'team_final') {
                        // Buscar ranking completo para fases individuais
                        resultsRaw = computeConsolidatedResults(phase, apparatus) || [];
                        
                        // Encontrar posi√ß√£o atual
                        currentRank = resultsRaw.findIndex(g => g.id === currentGymnast.id) + 1;
                        
                        if (currentRank === 0) {
                            console.error('[Stream] ‚ùå Ginasta n√£o encontrada no ranking!');
                            return;
                        }
                    } else {
                        // Team Final: buscar ranking de PA√çSES (equipes)
                        console.log('[Stream] üèÜ Team Final: buscando ranking de equipes...');
                        resultsRaw = computeConsolidatedResults('team_final', apparatus) || [];
                        console.log('[Stream] üèÜ Ranking de equipes:', resultsRaw);
                        
                        // Encontrar posi√ß√£o do PA√çS da ginasta atual
                        const gymnastCountry = currentGymnast.country;
                        currentRank = resultsRaw.findIndex(team => team.country === gymnastCountry) + 1;
                        
                        if (currentRank === 0) {
                            console.warn('[Stream] ‚ö†Ô∏è Pa√≠s n√£o encontrado no ranking de equipes:', gymnastCountry);
                            currentRank = null;
                        } else {
                            console.log('[Stream] üèÜ Pa√≠s encontrado na posi√ß√£o:', currentRank);
                        }
                    }
                    
                    // Mostrar overlay
                    console.log('[Stream] üéØ Calling showScoreRevealOverlay with finalScoreData:', finalScoreData);
                    showScoreRevealOverlay(
                        currentGymnast,
                        phase,
                        apparatus,
                        finalScoreData,
                        resultsRaw,
                        currentRank,
                        phase === 'team_final' // isTeamRanking flag
                    );
                }
                else if (data.action === 'hide-score-reveal') {
                    console.log('[Stream] üö´ Fechando Score Reveal Overlay...');
                    hideScoreRevealOverlay();
                }

                // Legacy compatibility (manter para n√£o quebrar)
                else if (data.action === 'show-lower-third') {
                    console.log('[Stream] üë§ Mostrando rodap√© (legacy)...');
                    currentLowerThirdState = true;
                    syncComputedOverlays();
                }
                else if (data.action === 'hide-lower-third') {
                    console.log('[Stream] üö´ Ocultando rodap√© (legacy)...');
                    currentLowerThirdState = false;
                    setLowerThirdVisibility(false);
                }

                // Handle Inquiry controls
                else if (data.action === 'inquiry-start') {
                    const gymnastName = data.gymnastName || data.name || 'Ginasta';
                    const reason = data.reason || 'An√°lise de recurso em andamento...';
                    showInquiryOverlay(gymnastName, reason);
                } 
                // Handle inquiry submitted (novo)
                else if (data.action === 'inquiry-submitted') {
                    const gymnastName = data.inquiry?.gymnastName || 'Ginasta';
                    const reason = data.inquiry?.reason || 'An√°lise de recurso em andamento...';
                    console.log('[Stream] üìã Recurso submetido:', gymnastName, reason);
                    showInquiryOverlay(gymnastName, reason);
                }
                // Handle inquiry rejected
                else if (data.action === 'inquiry-rejected') {
                    console.log('[Stream] üîç ENTROU NO HANDLER inquiry-rejected');
                    const gymnastName = data.inquiry?.gymnastName || 'Ginasta';
                    const reason = data.inquiry?.rejectionReason || 'Recurso rejeitado pela superior jury';
                    console.log('[Stream] ‚ùå Recurso rejeitado:', gymnastName, reason);
                    showInquiryOverlay(gymnastName, reason, 'rejected', 10000);
                }
                // Handle inquiry resolved (aumentado/diminu√≠do)
                else if (data.action === 'inquiry-resolved') {
                    console.log('[Stream] üîç ENTROU NO HANDLER inquiry-resolved!');
                    console.log('[Stream] üîç data completa:', data);
                    console.log('[Stream] üîç data.inquiry:', data.inquiry);
                    console.log('[Stream] üîç data.inquiry.resolution:', data.inquiry?.resolution);
                    
                    const gymnastName = data.inquiry?.gymnastName || 'Ginasta';
                    const decision = data.inquiry?.resolution?.decision || 'mantido';
                    const justification = data.inquiry?.resolution?.justification || '';
                    console.log('[Stream] ‚úÖ Recurso resolvido:', gymnastName, decision, justification);
                    
                    if (decision === 'aumentado') {
                        console.log('[Stream] üü£ Vai mostrar NOTA AUMENTADA');
                        showInquiryOverlay(gymnastName, justification, 'increased', 10000);
                    } else if (decision === 'diminuido') {
                        console.log('[Stream] üü£ Vai mostrar NOTA DIMINU√çDA');
                        showInquiryOverlay(gymnastName, justification, 'decreased', 10000);
                    } else {
                        console.log('[Stream] ‚ö†Ô∏è Decision n√£o √© aumentado nem diminuido:', decision);
                    }
                }
                else if (data.action === 'inquiry-stop') {
                    hideInquiryOverlay();
                }

                // Handle Start List cascade
                else if (data.action === 'show-startlist-main') {
                    if (data.list && Array.isArray(data.list)) {
                        // Show cascade of gymnast cards
                        const startlistWidget = {
                            visible: true,
                            title: data.title || 'Startlist',
                            items: data.list
                        };
                        updateListOverlay(overlayElements.startlistMain, startlistWidget, {
                            fallbackTitle: 'Startlist',
                            maxItems: 12,
                            showScore: false,
                            showPosition: true
                        });
                        contextChanged = true;
                    }
                } else if (data.action === 'hide-startlist-main') {
                    setOverlayVisibility(overlayElements.startlistMain.root, false);
                }

                // Handle Results cascade
                else if (data.action === 'show-results-main') {
                    if (data.list && Array.isArray(data.list)) {
                        const resultsWidget = {
                            visible: true,
                            title: data.title || 'Resultados',
                            items: data.list
                        };
                        updateListOverlay(overlayElements.results, resultsWidget, {
                            fallbackTitle: 'Resultados',
                            maxItems: 10,
                            scoreDecimals: 3
                        });
                        contextChanged = true;
                    }
                } else if (data.action === 'hide-results-main') {
                    setOverlayVisibility(overlayElements.results.root, false);
                }

                // Handle navigation (setIndex from prev/next buttons)
                else if (data.action === 'setIndex') {
                    if (typeof data.index === 'number') {
                        overlayContext.currentIndex = data.index;
                        contextChanged = true;
                    }
                    if (data.gymnastId) {
                        overlayContext.gymnastId = data.gymnastId;
                    }
                    if (typeof data.activeVaultNum === 'number') {
                        overlayContext.activeVaultNum = data.activeVaultNum;
                    }
                }

                // Handle sync (manual sync button)
                else if (data.action === 'sync') {
                    if (data.phase) overlayContext.phase = data.phase;
                    if (data.apparatus) overlayContext.apparatus = getApparatusCode(data.apparatus);
                    if (typeof data.index === 'number') overlayContext.currentIndex = data.index;
                    if (data.gymnastId) overlayContext.gymnastId = data.gymnastId;
                    if (typeof data.activeVaultNum === 'number') overlayContext.activeVaultNum = data.activeVaultNum;
                    contextChanged = true;
                }

                // Handle setPhase (phase/rotation dropdown changes)
                else if (data.action === 'setPhase') {
                    if (data.phase) overlayContext.phase = data.phase;
                    if (data.apparatus) overlayContext.apparatus = getApparatusCode(data.apparatus);
                    if (typeof data.index === 'number') overlayContext.currentIndex = data.index;
                    if (data.gymnastId) overlayContext.gymnastId = data.gymnastId;
                    if (typeof data.activeVaultNum === 'number') overlayContext.activeVaultNum = data.activeVaultNum;
                    contextChanged = true;
                }

                // Handle showScreen (timer, startlist, results buttons)
                else if (data.action === 'showScreen') {
                    const screen = data.screen;
                    console.log('[Stream] üì∫ ShowScreen requested:', screen);
                    // Timer is handled by Firestore, startlist/results by show-startlist-main/show-results-main
                    // This is more for legacy compatibility or future use
                }

                // Handle show resources screen
                else if (data.action === 'show-resources-screen') {
                    console.log('[Stream] ‚öñÔ∏è Mostrando tela de recursos...');
                    const gymnastName = overlayContext.gymnastId ? 'Ginasta' : 'Recurso';
                    const reason = 'An√°lise de Nota D em andamento...';
                    showInquiryOverlay(gymnastName, reason);
                }

                // Handle show warmup screen
                else if (data.action === 'show-warmup-screen') {
                    console.log('[Stream] üî• Mostrando tela de aquecimento...');
                    showWarmupOverlay(60); // Default 60s
                }

                // Handle hide special screens
                else if (data.action === 'hide-special-screens') {
                    console.log('[Stream] ‚ùå Ocultando telas especiais...');
                    hideWarmupOverlay();
                    hideInquiryOverlay();
                }

                // Legacy actions
                else if (data.action === 'showScore') {
                    console.log('[Stream] üìä Mostrando nota para:', data.gymnastId);
                    overlayContext.timer.status = 'SCORE';
                    stopTimerCountdown();
                    
                    // Get gymnast data and show scores in lower-third
                    if (data.gymnastId || data.gymnast?.id) {
                        const gymnastId = data.gymnastId || data.gymnast.id;
                        const gymnast = resolveGymnastById(gymnastId);
                        
                        if (gymnast) {
                            const basePhase = getBasePhaseName(overlayContext.phase);
                            const apparatusCode = getApparatusCode(data.gymnast?.apparatus || overlayContext.apparatus);
                            
                            // Get scores
                            let phaseScores = gymnast.scores?.[basePhase];
                            if (!phaseScores) {
                                phaseScores = {};
                                const prefix = `${basePhase}_`;
                                Object.keys(gymnast.scores || {}).forEach((k) => {
                                    if (typeof k === 'string' && k.startsWith(prefix)) phaseScores[k] = gymnast.scores[k];
                                });
                                if (!Object.keys(phaseScores).length) phaseScores = {};
                            }
                            let appKey = apparatusCode;
                            if (apparatusCode === 'vt') {
                                appKey = overlayContext.activeVaultNum === 2 ? 'vt2' : 'vt1';
                            }
                            const scoreData = getAppScore(phaseScores, appKey, gymnast.id, basePhase);
                            const countryInfo = getCountryInfo(gymnast.country);
                            
                            // Update lower-third with scores
                            updateLowerThirdContent({
                                gymnastName: gymnast.firstName || gymnast.name || '',
                                gymnastLastName: gymnast.surname || gymnast.lastName || '',
                                countryCode: countryInfo.code,
                                countryFlagEmoji: countryInfo.emoji,
                                apparatus: apparatusCode,
                                showScore: true,
                                dScore: scoreData.d,
                                eScore: scoreData.e,
                                pScore: scoreData.p,
                                totalScore: scoreData.total,
                                vt1Score: apparatusCode === 'vt' ? scoreData.vt1 : null,
                                vt2Score: apparatusCode === 'vt' ? scoreData.vt2 : null
                            });
                            setLowerThirdVisibility(true);
                        }
                    }
                    
                    contextChanged = true;
                } else if (data.action === 'updateLowerThird') {
                    if (data.data) {
                        updateLowerThirdContent(data.data);
                    }
                } else if (data.action === 'startWarmup') {
                    showWarmupOverlay(data.duration || 60);
                    playBeep();
                } else if (data.action === 'stopWarmup') {
                    hideWarmupOverlay();
                }

                if (contextChanged) {
                    syncComputedOverlays();
                }
            }

        // Setup BroadcastChannel for control messages
        try {
            controlChannel = new BroadcastChannel('fx-control');
            controlChannel.onmessage = handleControlMessage;
            console.log('[Stream] ‚úÖ BroadcastChannel fx-control initialized and ready');
        } catch (error) {
            console.error('[Stream] ‚ùå BroadcastChannel fx-control unavailable:', error);
        }

        let soundEffectsChannel = null;
        let currentSoundEffectAudio = null;

        function handleSoundEffectsMessage(event) {
            const data = event?.data || {};
            console.log('[Stream] üéµ Received sound-effects message:', data);
            
            // Handle standardized play command
            if (data.action === 'play') {
                const audioUrl = data.file || data.url;
                const audioType = data.type || 'music'; // 'music' or 'effect'
                const volume = data.volume !== undefined ? data.volume : 1.0;
                
                console.log('[Stream] üéµ Playing audio:', audioUrl, '| Type:', audioType);
                
                if (!audioUrl) {
                    console.error('[Stream] ‚ùå No audio file specified');
                    return;
                }
                
                if (!ensureAudioEnabled()) {
                    console.error('[Stream] ‚ùå Cannot play - audio not enabled!');
                    return;
                }
                
                // Determine which audio element to use
                if (audioType === 'effect') {
                    // Play sound effect (beep, welcome, etc.)
                    if (currentSoundEffectAudio) {
                        currentSoundEffectAudio.pause();
                    }
                    currentSoundEffectAudio = new Audio(audioUrl);
                    currentSoundEffectAudio.volume = volume;
                    currentSoundEffectAudio.play().then(() => {
                        console.log('[Stream] ‚úÖ Playing sound effect:', audioUrl);
                    }).catch((error) => {
                        console.error('[Stream] ‚ùå Sound effect playback failed:', error);
                    });
                } else {
                    // Play gymnast music (FX)
                    if (gymnastAudioElement) {
                        gymnastAudioElement.src = audioUrl;
                        gymnastAudioElement.currentTime = 0;
                        gymnastAudioElement.volume = volume;
                        
                        gymnastAudioElement.play().then(() => {
                            console.log('[Stream] ‚úÖ Playing music:', audioUrl);
                            overlayContext.music.status = 'GO';
                            overlayContext.music.label = data.label || 'M√öSICA';
                            overlayContext.music.timestamp = Date.now();
                            syncComputedOverlays();
                        }).catch((error) => {
                            console.error('[Stream] ‚ùå Music playback failed:', error);
                        });
                    }
                }
            } 
            // Handle standardized stop command
            else if (data.action === 'stop') {
                const stopType = data.type || 'music'; // 'music', 'effect', or 'all'
                
                console.log('[Stream] üéµ Stopping audio type:', stopType);
                
                if (stopType === 'all' || stopType === 'music') {
                    stopGymnastMusic();
                    overlayContext.music.status = 'STOP';
                    overlayContext.music.timestamp = Date.now();
                    syncComputedOverlays();
                }
                
                if (stopType === 'all' || stopType === 'effect') {
                    if (currentSoundEffectAudio) {
                        currentSoundEffectAudio.pause();
                        currentSoundEffectAudio = null;
                    }
                }
            }
            
            // Legacy format handling (for backward compatibility)
            else if (data.type === 'SOUND_EFFECT') {
                playSoundEffectOnStream(data.effect, data.audioFile, data.timestamp);
            } else if (data.type === 'CLEAR_SOUND_EFFECTS') {
                clearSoundEffectsOnStream(data.timestamp);
            } else if (data.type === 'PLAY_BEEP') {
                playBeep();
            }
        }

        function normalizeBooleanValue(value, defaultValue = false) {
            if (value === undefined || value === null) return defaultValue;
            if (typeof value === 'boolean') return value;
            if (typeof value === 'number') return value !== 0;
            if (typeof value === 'string') {
                const normalized = value.trim().toLowerCase();
                if (!normalized) return defaultValue;
                if (['true', '1', 'yes', 'y', 'sim'].includes(normalized)) return true;
                if (['false', '0', 'no', 'n', 'nao', 'n√£o'].includes(normalized)) return false;
            }
            return Boolean(value);
        }

        function getFlagMarkup(entry, size = 'w80') {
            if (!entry) return '';
            if (entry.flagCode) {
                return `<img src="${FLAG_CDN_BASE}/${size}/${entry.flagCode}.png" alt="${(entry.country || '').toUpperCase()}">`;
            }
            if (entry.flagEmoji) {
                const fontSize = size === 'w256' ? '3rem' : (size === 'w160' ? '2.4rem' : '2rem');
                return `<span style="font-size:${fontSize};">${entry.flagEmoji}</span>`;
            }
            return '';
        }

        function resetPodiumState(clearAudio = false) {
            if (podiumState.introTimeout) {
                clearTimeout(podiumState.introTimeout);
                podiumState.introTimeout = null;
            }
            podiumState.phaseKey = null;
            podiumState.apparatus = null;
            podiumState.phaseLabel = '';
            podiumState.category = 'individual';
            podiumState.results = [];
            podiumState.activeMedals.gold = null;
            podiumState.activeMedals.silver = null;
            podiumState.activeMedals.bronze = null;
            podiumState.lastMedal = null;
            if (podiumStageContainer) {
                podiumStageContainer.innerHTML = '';
            }
            if (podiumFooterFlagEl) {
                podiumFooterFlagEl.innerHTML = '';
            }
            if (podiumFooterCountryEl) podiumFooterCountryEl.textContent = '';
            if (podiumFooterSubtitleEl) podiumFooterSubtitleEl.textContent = '';
            if (podiumFooterScoreEl) podiumFooterScoreEl.textContent = '';
            if (clearAudio) {
                stopPodiumAudio();
            }
            setOverlayVisibility(overlayPodiumIntro, false);
            setOverlayVisibility(overlayPodium, false);
            setOverlayVisibility(overlayPodiumFooter, false);
            setOverlayVisibility(overlayPodiumFlags, false);
        }

        function playAwardsMusic() {
            if (!ensureAudioEnabled()) {
                console.warn('[Stream] ‚ö†Ô∏è Awards music requested but audio is disabled.');
                return;
            }
            stopGymnastMusic();
            if (currentSoundEffectAudio) {
                currentSoundEffectAudio.pause();
            }
            currentSoundEffectAudio = new Audio('music/awards.mp3');
            currentSoundEffectAudio.loop = true;
            currentSoundEffectAudio.volume = 0.82;
            currentSoundEffectAudio.play().then(() => {
                overlayContext.music.status = 'GO';
                overlayContext.music.label = 'CERIM√îNIA';
                overlayContext.music.timestamp = Date.now();
                syncComputedOverlays();
            }).catch((error) => {
                console.error('[Stream] ‚ùå Awards music playback failed:', error);
            });
        }

        function stopPodiumAudio() {
            if (currentSoundEffectAudio) {
                currentSoundEffectAudio.pause();
                currentSoundEffectAudio = null;
            }
            if (overlayContext.music.label === 'CERIM√îNIA' || overlayContext.music.label === 'HINO') {
                overlayContext.music.status = 'STOP';
                overlayContext.music.timestamp = Date.now();
                syncComputedOverlays();
            }
        }

        function playAnthemMusic(countryCode) {
            const raw = (countryCode || '').toString().trim();
            const normalized = raw.toUpperCase();

            // Tenta encontrar a chave direta (pode ser 3-letter like 'ITA')
            let anthemKey = normalized;
            let file = ANTHEM_FILES[anthemKey];

            // Se n√£o encontrar, e o c√≥digo for 2-letter (ex: 'it'), tentar mapear para 3-letter
            if (!file && normalized.length === 2 && window.countryData) {
                for (const three of Object.keys(window.countryData)) {
                    const cd = window.countryData[three];
                    if (cd && cd.code && cd.code.toUpperCase() === normalized) {
                        anthemKey = three.toUpperCase();
                        file = ANTHEM_FILES[anthemKey];
                        break;
                    }
                }
            }

            // Se n√£o encontrou com c√≥digo 2-letter, talvez foi passado um 3-letter em lowercase ou similar;
            // garantir tentativa extra usando somente first 3 chars
            if (!file && normalized.length >= 2) {
                // tentar usar exactly 3 letters if possible
                const maybe3 = (normalized.length === 3) ? normalized : null;
                if (maybe3 && ANTHEM_FILES[maybe3]) {
                    anthemKey = maybe3;
                    file = ANTHEM_FILES[anthemKey];
                }
            }

            if (!file) {
                console.warn('[Stream] ‚ö†Ô∏è No anthem file available for country:', countryCode, '(tried keys:', anthemKey, ')');
                return;
            }
            if (!ensureAudioEnabled()) {
                console.warn('[Stream] ‚ö†Ô∏è Anthem requested but audio is disabled.');
                return;
            }
            stopGymnastMusic();
            if (currentSoundEffectAudio) {
                currentSoundEffectAudio.pause();
            }
            currentSoundEffectAudio = new Audio(file);
            currentSoundEffectAudio.loop = false;
            currentSoundEffectAudio.volume = 0.92;
            currentSoundEffectAudio.play().then(() => {
                overlayContext.music.status = 'GO';
                overlayContext.music.label = 'HINO';
                overlayContext.music.timestamp = Date.now();
                syncComputedOverlays();
            }).catch((error) => {
                console.error('[Stream] ‚ùå Anthem playback failed:', error);
            });
            if (currentSoundEffectAudio) {
                currentSoundEffectAudio.onended = () => {
                    overlayContext.music.status = 'STOP';
                    overlayContext.music.timestamp = Date.now();
                    syncComputedOverlays();
                    setOverlayVisibility(overlayPodiumFlags, false);
                };
            }
        }

        function fetchPodiumResults(phaseKey, apparatus, category) {
            const gymnasts = dataState.gymnasts || [];
            if (!gymnasts.length) {
                console.warn('[Stream] ‚ö†Ô∏è Podium requested but gymnast data is empty.');
                return [];
            }

            if (phaseKey === 'team_final') {
                let results = [];
                const teamQualifiers = typeof calculateTeamScores === 'function' ? calculateTeamScores(gymnasts) : [];
                const qualifyingCountries = teamQualifiers.map(team => team.country);
                if (dataState.teamFinalDraw && typeof calculateTeamFinalScoresWithDuplication === 'function') {
                    results = calculateTeamFinalScoresWithDuplication(gymnasts, qualifyingCountries, dataState.teamFinalDraw);
                } else if (typeof calculateTeamFinalScores === 'function') {
                    results = calculateTeamFinalScores(gymnasts, qualifyingCountries);
                } else {
                    results = teamQualifiers;
                }

                return results
                    .filter(Boolean)
                    .sort((a, b) => (b.total || 0) - (a.total || 0))
                    .slice(0, 3)
                    .map((team, index) => {
                        const countryInfo = getCountryInfo(team.country);
                        const athletes = gymnasts
                            .filter(g => g.country === team.country && normalizeBooleanValue(g.team_final_present, true))
                            .map(g => g.name)
                            .slice(0, 6);
                        // Garantir flagCode e flagEmoji robustos (aceitar 2 or 3 letter codes)
                        const resolvedFlagCode = (countryInfo && countryInfo.code) ? countryInfo.code : (window.getCountryCode ? window.getCountryCode(team.country) : null);
                        const resolvedFlagEmoji = (countryInfo && countryInfo.emoji) ? countryInfo.emoji : (window.getCountryFlag ? window.getCountryFlag(team.country) : 'üè≥Ô∏è');
                        return {
                            type: 'team',
                            rank: index + 1,
                            country: team.country,
                            flagCode: resolvedFlagCode,
                            flagEmoji: resolvedFlagEmoji,
                            score: Number(team.total || team.score || 0),
                            athletes
                        };
                    });
            }

            if (phaseKey === 'aa_final') {
                const aaScores = typeof calculateAAScores === 'function' ? calculateAAScores(gymnasts, 'aa_final') : [];
                return aaScores
                    .filter(g => typeof g.aaTotal === 'number' && g.aaTotal > 0)
                    .sort((a, b) => b.aaTotal - a.aaTotal)
                    .slice(0, 3)
                    .map((gymnast, index) => {
                        const countryInfo = getCountryInfo(gymnast.country);
                        return {
                            type: 'individual',
                            rank: index + 1,
                            gymnastId: gymnast.id,
                            fullName: gymnast.name,
                            country: gymnast.country,
                            flagCode: countryInfo.code,
                            flagEmoji: countryInfo.emoji,
                            score: Number(gymnast.aaTotal || 0)
                        };
                    });
            }

            if (phaseKey && phaseKey.endsWith('_final')) {
                const targetApparatus = apparatus || phaseKey.replace('_final', '');
                const finalResults = computeConsolidatedResults(phaseKey, targetApparatus) || [];
                return finalResults
                    .filter(Boolean)
                    .slice(0, 3)
                    .map((gymnast, index) => {
                        const countryInfo = getCountryInfo(gymnast.country);
                        const scoreValue = gymnast.apparatusScore ?? gymnast.total ?? gymnast.score ?? gymnast.points ?? 0;
                        return {
                            type: 'individual',
                            rank: index + 1,
                            gymnastId: gymnast.id,
                            fullName: gymnast.name || gymnast.displayName || `${gymnast.firstName || ''} ${gymnast.lastName || ''}`.trim(),
                            country: gymnast.country,
                            flagCode: countryInfo.code,
                            flagEmoji: countryInfo.emoji,
                            score: Number(scoreValue)
                        };
                    });
            }

            console.warn('[Stream] ‚ö†Ô∏è Unknown podium phase key:', phaseKey);
            return [];
        }

        function initializePodiumStateFromControl(payload) {
            const phaseKey = payload.phaseKey;
            if (!phaseKey) {
                console.warn('[Stream] ‚ö†Ô∏è Podium payload missing phaseKey.');
                return false;
            }
            const metadata = PODIUM_PHASES[phaseKey] || {};
            podiumState.phaseKey = phaseKey;
            podiumState.phaseLabel = payload.phaseLabel || metadata.label || phaseKey.replace(/_/g, ' ').toUpperCase();
            podiumState.category = payload.category || metadata.category || 'individual';
            podiumState.apparatus = payload.apparatus || metadata.apparatus || null;
            podiumState.results = fetchPodiumResults(podiumState.phaseKey, podiumState.apparatus, podiumState.category);
            podiumState.activeMedals.gold = null;
            podiumState.activeMedals.silver = null;
            podiumState.activeMedals.bronze = null;
            podiumState.lastMedal = null;
            if (!podiumState.results.length) {
                console.warn('[Stream] ‚ö†Ô∏è No podium results available for', podiumState.phaseKey);
                return false;
            }
            if (podiumStageContainer) {
                podiumStageContainer.innerHTML = '';
            }
            return true;
        }

        function updatePodiumStage(highlightMedal = null) {
            if (!podiumStageContainer) return;
            const html = PODIUM_LAYOUT.map((medal) => {
                const entry = podiumState.activeMedals[medal];
                const medalCfg = MEDAL_CONFIG[medal];
                const classes = ['podium-block', `medal-${medal}`];
                if (entry) classes.push('active');
                if (highlightMedal === medal) classes.push('podium-active-medal');
                const scoreText = entry ? formatScoreValue(entry.score ?? 0, 3) : '--';
                const flagMarkup = entry ? getFlagMarkup(entry, 'w80') : '';
                const countryLabel = entry ? (entry.country || '').toUpperCase() : '---';
                let nameLine = '';
                let athletesLine = '';
                if (entry) {
                    if (entry.type === 'team') {
                        nameLine = `<div class="podium-name">${countryLabel}</div>`;
                        if (entry.athletes && entry.athletes.length) {
                            athletesLine = `<div class="podium-athletes">${entry.athletes.join(' ‚Ä¢ ')}</div>`;
                        }
                    } else {
                        nameLine = `<div class="podium-name">${entry.fullName || entry.display || 'Ginasta'}</div>`;
                    }
                }
                return `
                    <div class="${classes.join(' ')}">
                        <div class="podium-header">
                            <div class="medal-icon">${medalCfg.icon}</div>
                            <div class="podium-score">${scoreText}</div>
                        </div>
                        <div class="podium-details">
                            <div class="podium-flag">${flagMarkup}<span>${countryLabel}</span></div>
                            ${nameLine || ''}
                            ${athletesLine || ''}
                        </div>
                    </div>
                `;
            }).join('');
            podiumStageContainer.innerHTML = html;
            if (podiumPhaseLabelEl) {
                podiumPhaseLabelEl.textContent = podiumState.phaseLabel || 'Ceremony';
            }
        }

        function renderPodiumFooter(medal, entry) {
            if (!entry || !overlayPodiumFooter) return;
            const medalCfg = MEDAL_CONFIG[medal] || MEDAL_CONFIG.bronze;
            if (podiumFooterMedalIconEl) {
                podiumFooterMedalIconEl.textContent = medalCfg.icon;
            }
            if (podiumFooterScoreEl) {
                podiumFooterScoreEl.textContent = formatScoreValue(entry.score ?? 0, 3);
            }
            if (podiumFooterCountryEl) {
                podiumFooterCountryEl.textContent = entry.type === 'team'
                    ? (entry.country || 'Equipe')
                    : (entry.fullName || entry.display || 'Ginasta');
            }
            if (podiumFooterSubtitleEl) {
                const subtitle = `${medalCfg.label.toUpperCase()} - ${(podiumState.phaseLabel || '').toUpperCase()} - MANAUS 2025`;
                podiumFooterSubtitleEl.textContent = subtitle;
            }
            if (podiumFooterFlagEl) {
                podiumFooterFlagEl.innerHTML = getFlagMarkup(entry, 'w160');
            }
        }

        function renderPodiumFlags() {
            if (!podiumFlagsStageEl) return;
            const layout = [
                { medal: 'silver', entry: podiumState.results[1] },
                { medal: 'gold', entry: podiumState.results[0] },
                { medal: 'bronze', entry: podiumState.results[2] }
            ];
            const html = layout.map(({ medal, entry }) => {
                if (!entry) return '';
                const flagMarkup = getFlagMarkup(entry, 'w256');
                const title = entry.type === 'team'
                    ? (entry.country || '').toUpperCase()
                    : (entry.fullName || entry.display || 'Ginasta');
                return `
                    <div class="flag-column ${medal}">
                        <div class="flag-img-wrapper">${flagMarkup}</div>
                        <div class="flag-caption">
                            ${title}
                            <span class="score">${formatScoreValue(entry.score ?? 0, 3)}</span>
                        </div>
                    </div>
                `;
            }).join('');
            podiumFlagsStageEl.innerHTML = html;
            if (podiumFlagsPhaseEl) {
                podiumFlagsPhaseEl.textContent = podiumState.phaseLabel || 'Ceremony';
            }
        }

        function showPodiumIntro(phaseLabel) {
            if (podiumIntroPhaseEl) {
                podiumIntroPhaseEl.textContent = phaseLabel || 'Ceremony';
            }
            setOverlayVisibility(overlayPodiumIntro, true);
            if (podiumState.introTimeout) {
                clearTimeout(podiumState.introTimeout);
            }
            podiumState.introTimeout = setTimeout(() => {
                setOverlayVisibility(overlayPodiumIntro, false);
                podiumState.introTimeout = null;
            }, 10000);
        }

        function handlePodiumStart(payload) {
            resetPodiumState(true);
            if (!initializePodiumStateFromControl(payload)) {
                hidePodiumOverlays();
                return;
            }
            showPodiumIntro(podiumState.phaseLabel);
            updatePodiumStage();
            setOverlayVisibility(overlayPodium, false);
            setOverlayVisibility(overlayPodiumFooter, false);
            setOverlayVisibility(overlayPodiumFlags, false);
            playAwardsMusic();
        }

        function handlePodiumShowMedal(payload) {
            if (!payload || !payload.medal) return;
            if (!podiumState.phaseKey || podiumState.phaseKey !== payload.phaseKey) {
                if (!initializePodiumStateFromControl(payload)) {
                    return;
                }
            }
            const medal = payload.medal;
            if (!MEDAL_CONFIG[medal]) {
                console.warn('[Stream] ‚ö†Ô∏è Unknown medal:', medal);
                return;
            }
            const entryIndex = MEDAL_INDEX[medal] ?? 0;
            const entry = podiumState.results[entryIndex];
            if (!entry) {
                console.warn('[Stream] ‚ö†Ô∏è Missing podium entry for medal:', medal);
                return;
            }
            podiumState.activeMedals[medal] = entry;
            podiumState.lastMedal = medal;
            updatePodiumStage(medal);
            renderPodiumFooter(medal, entry);
            setOverlayVisibility(overlayPodiumIntro, false);
            setOverlayVisibility(overlayPodiumFlags, false);
            setOverlayVisibility(overlayPodium, true);
            setOverlayVisibility(overlayPodiumFooter, true);
        }

        function handlePodiumHide() {
            resetPodiumState(true);
        }

        function handlePodiumAnthem(payload) {
            if (!podiumState.phaseKey || podiumState.phaseKey !== payload.phaseKey) {
                if (!initializePodiumStateFromControl(payload)) {
                    return;
                }
            }
            const goldEntry = podiumState.results[0];
            if (!goldEntry) {
                console.warn('[Stream] ‚ö†Ô∏è No gold entry available to start anthem.');
                return;
            }
            renderPodiumFlags();
            setOverlayVisibility(overlayPodium, false);
            setOverlayVisibility(overlayPodiumFooter, false);
            setOverlayVisibility(overlayPodiumIntro, false);
            setOverlayVisibility(overlayPodiumFlags, true);
            playAnthemMusic(goldEntry.country);
        }

        function hidePodiumOverlays() {
            setOverlayVisibility(overlayPodiumIntro, false);
            setOverlayVisibility(overlayPodium, false);
            setOverlayVisibility(overlayPodiumFooter, false);
            setOverlayVisibility(overlayPodiumFlags, false);
        }

        function playSoundEffectOnStream(effect, audioFile, timestamp) {
            if (!audioFile) return;
            if (!ensureAudioEnabled()) {
                return;
            }

            stopGymnastMusic();
            if (!currentSoundEffectAudio) {
                currentSoundEffectAudio = new Audio();
            }
            currentSoundEffectAudio.src = audioFile;
            currentSoundEffectAudio.currentTime = 0;
            currentSoundEffectAudio.play().catch((error) => {
                console.warn('[Stream] Falha ao reproduzir efeito sonoro:', error);
            });

            overlayContext.music.status = 'GO';
            overlayContext.music.label = effect ? effect.replace(/[-_]/g, ' ').toUpperCase() : (overlayContext.music.label || 'M√öSICA');
            overlayContext.music.timestamp = timestamp || Date.now();
            syncComputedOverlays();
        }

        function clearSoundEffectsOnStream(timestamp) {
            if (currentSoundEffectAudio) {
                currentSoundEffectAudio.pause();
                currentSoundEffectAudio.currentTime = 0;
            }
            overlayContext.music.status = 'STOP';
            overlayContext.music.timestamp = timestamp || Date.now();
            stopGymnastMusic();
            syncComputedOverlays();
        }

        // Setup BroadcastChannel for sound effects
        try {
            soundEffectsChannel = new BroadcastChannel('sound-effects');
            soundEffectsChannel.onmessage = handleSoundEffectsMessage;
            console.log('[Stream] ‚úÖ BroadcastChannel sound-effects initialized and ready');
        } catch (error) {
            console.error('[Stream] ‚ùå BroadcastChannel sound-effects indispon√≠vel:', error);
        }

        // === JUDGE SCORE NOTIFICATION SYSTEM ===
        let judgeNotificationChannel = null;
        let notificationTimeout = null;
        
        function showJudgeNotification(message) {
            const notification = document.getElementById('judge-notification');
            const notificationText = document.getElementById('judge-notification-text');
            
            if (!notification || !notificationText) return;
            
            // Clear any existing timeout
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
            
            // Update message and show notification
            notificationText.textContent = message;
            notification.classList.add('show');
            
            // Auto-hide after 2 seconds
            notificationTimeout = setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }
        
        function handleJudgeScoreMessage(event) {
            const data = event?.data || {};
            console.log('[Stream] üìä Judge score notification:', data);
            
            if (data.type === 'JUDGE_D_CONFIRMED') {
                showJudgeNotification('‚úì Nota de Dificuldade lan√ßada');
            } else if (data.type === 'JUDGE_E_CONFIRMED') {
                showJudgeNotification('‚úì Nota de Execu√ß√£o lan√ßada');
            } else if (data.type === 'SCORE_FINAL_AVAILABLE') {
                showJudgeNotification('‚úì Nota Final dispon√≠vel');
            }
        }
        
        // Setup BroadcastChannel for judge score notifications
        try {
            judgeNotificationChannel = new BroadcastChannel('judge-scores');
            judgeNotificationChannel.onmessage = handleJudgeScoreMessage;
            console.log('[Stream] ‚úÖ BroadcastChannel judge-scores initialized and ready');
        } catch (error) {
            console.error('[Stream] ‚ùå BroadcastChannel judge-scores indispon√≠vel:', error);
        }

        async function startCapture() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: 'never',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { max: 60 }
                    },
                    audio: false
                });
                videoStream.srcObject = stream;
                captureButton.classList.add('hidden');
            } catch (error) {
                console.error('Erro ao iniciar captura de tela:', error);
                captureButton.textContent = 'Tentar novamente';
            }
        }

        captureButton.addEventListener('click', startCapture);

        if (enableAudioBtn) {
            enableAudioBtn.addEventListener('click', async () => {
                enableAudioBtn.disabled = true;
                enableAudioBtn.textContent = 'üîÑ Liberando √°udio...';
                const unlocked = await unlockAudio();
                if (unlocked) {
                    enableAudioBtn.textContent = 'üîä √Åudio habilitado';
                    // Esconder o bot√£o permanentemente ap√≥s habilitar
                    setTimeout(() => {
                        enableAudioBtn.classList.add('hidden');
                    }, 1000);
                } else {
                    enableAudioBtn.disabled = false;
                    enableAudioBtn.textContent = 'üîÅ Tentar habilitar √°udio';
                }
            });
        }

        function setSceneActive(sceneId, payload = {}) {
            if (activeSceneId === sceneId) {
                updateScene(sceneId, payload);
                return;
            }

            sceneNodes.forEach((scene) => {
                if (scene.dataset.scene === activeSceneId) {
                    scene.classList.remove('active');
                    setTimeout(() => {
                        if (scene.dataset.scene !== activeSceneId) {
                            scene.style.display = 'none';
                        }
                    }, 610);
                }
            });

            const newScene = sceneNodes.find(scene => scene.dataset.scene === sceneId);
            if (!newScene) {
                console.warn(`Cena n√£o encontrada: ${sceneId}`);
                return;
            }

            newScene.style.display = 'flex';
            requestAnimationFrame(() => {
                newScene.classList.add('active');
            });

            activeSceneId = sceneId;
            updateScene(sceneId, payload);
        }

        function updateScene(sceneId, payload) {
            if (sceneId === SCENES.LIVE) {
                // N√ÉO chamar updateLowerThirdContent nem setLowerThirdVisibility aqui
                // Isso j√° √© feito em syncComputedOverlays() com a l√≥gica correta
                // updateLowerThirdContent(payload);
                // setLowerThirdVisibility j√° √© gerenciado por currentLowerThirdState
            } else if (sceneId === SCENES.STANDBY) {
                setLowerThirdVisibility(false);
                currentLowerThirdState = false;
            }
        }

        function applyOverlays(activeOverlays = {}) {
            const { logoBug: showLogo = false, widgets = null } = activeOverlays || {};
            
            console.log('[Stream] üé® applyOverlays called with:', { showLogo, widgets });

            if (showLogo) {
                logoBug.classList.remove('hidden');
                requestAnimationFrame(() => logoBug.classList.add('active'));
            } else {
                logoBug.classList.remove('active');
                logoBug.classList.add('hidden');
            }

            if (!widgets) {
                console.log('[Stream] ‚ö†Ô∏è No widgets found, hiding all overlays');
                updateTimerOverlay({ visible: false });
                updateScorecardOverlay({ visible: false });
                updateWarmupOverlay({ visible: false });
                updateInquiryOverlay({ visible: false });
                updateListCenter({ visible: false }); // ‚ú® NOVO
                return;
            }

            console.log('[Stream] üé® Applying widgets.timer:', widgets.timer);
            updateTimerOverlay(widgets.timer || { visible: false });
            updateScorecardOverlay(widgets.scorecard || { visible: false });
            updateWarmupOverlay(widgets.warmup || { visible: false });
            updateInquiryOverlay(widgets.inquiry || { visible: false });

            // ‚ú® NOVO: Overlay central de listas
            updateListCenter(widgets.listCenter || { visible: false });

            // ‚ùå REMOVIDO: Overlays antigos de lista (n√£o existem mais)
            /*
            updateListOverlay(overlayElements.startlistMain, widgets.startlistMain, {
                fallbackTitle: 'Startlist',
                maxItems: 12,
                showScore: false,
                showPosition: true
            });

            updateListOverlay(overlayElements.startlistCorner, widgets.startlistCorner, {
                fallbackTitle: 'Pr√≥ximas Ginastas',
                maxItems: 4,
                showScore: false,
                showPosition: true
            });

            updateListOverlay(overlayElements.results, widgets.results, {
                fallbackTitle: 'Resultados',
                maxItems: 10,
                scoreDecimals: 3
            });
            */
        }

        function audioManager(audioCommand) {
            if (!audioCommand || !audioCommand.trigger) return;
            const { trigger, timestamp = 0 } = audioCommand;
            if (timestamp <= lastAudioTimestamp) return;

            lastAudioTimestamp = timestamp;
            console.log(`[AUDIO] Trigger recebido: ${trigger}`);
            // Release 1: placeholder para futuros efeitos sonoros
        }

        function listenBroadcastState() {
            if (unsubscribeBroadcast) unsubscribeBroadcast();

            unsubscribeBroadcast = db.collection('broadcast').doc('liveState').onSnapshot((doc) => {
                if (!doc.exists) {
                    console.warn('Documento broadcast/liveState n√£o encontrado.');
                    return;
                }

                const docData = doc.data();
                console.log('[Stream] üî• Firebase snapshot received:', docData);
                
                const { currentScene = SCENES.STANDBY, scenePayload = {}, activeOverlays = {}, audioCommand = null } = docData;
                
                console.log('[Stream] üî• activeOverlays from Firebase:', activeOverlays);
                console.log('[Stream] üî• activeOverlays.widgets:', activeOverlays.widgets);
                if (activeOverlays.widgets?.timer) {
                    console.log('[Stream] üî• timer widget from Firebase:', activeOverlays.widgets.timer);
                }

                latestBroadcastState.currentScene = currentScene;
                latestBroadcastState.scenePayload = scenePayload || {};
                latestBroadcastState.activeOverlays = activeOverlays || {};
                latestBroadcastState.audioCommand = audioCommand;

                setSceneActive(currentScene, scenePayload);
                syncComputedOverlays();
                audioManager(audioCommand);
            }, (error) => {
                console.error('Erro ao escutar liveState:', error);
            });
        }

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && !unsubscribeBroadcast) {
                listenBroadcastState();
            }
        });

        // Initialize everything (script is at end of body, DOM is ready)
        console.log('[Stream] üöÄüöÄüöÄ VERSAO 5.0 COM IMAGENS PNG - TIMESTAMP:', new Date().toISOString(), 'üöÄüöÄüöÄ');
        console.log('[Stream] MUDANCA: Agora usando https://flagcdn.com PNG ao inves de emojis!');
        
        initializeDataListeners();
        listenBroadcastState();
        setSceneActive(SCENES.STANDBY);
        console.log('[Stream] Broadcast engine initialized');
    </script>
</body>
</html>